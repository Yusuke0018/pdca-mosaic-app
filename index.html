// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
const app = {
    ideas: [],
    projects: [],
    logs: [],
    improvements: [],
    currentSection: 'dashboard',
    currentProjectId: null,
    apiKey: null,
    searchQuery: '',
    filterPhase: 'all'
};

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    const loadedData = DataManager.loadData();
    if (loadedData) {
        app.ideas = loadedData.ideas;
        app.projects = loadedData.projects;
        app.logs = loadedData.logs;
        app.improvements = loadedData.improvements;
        app.apiKey = loadedData.apiKey;
    }
    
    renderDashboard();
    setupEventListeners();
    checkDailyReminder();
    requestNotificationPermission();
    // è¤‡æ•°ã‚¿ãƒ–åŒæœŸ
    window.addEventListener('storage', handleStorageChange);
});

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
function saveData() {
    DataManager.saveData(app);
}

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
function toggleNavMenu() {
    const dropdown = document.querySelector('.nav-dropdown');
    dropdown.classList.toggle('active');
    
    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    if (dropdown.classList.contains('active')) {
        setTimeout(() => {
            document.addEventListener('click', closeNavMenu);
        }, 100);
    }
}

function closeNavMenu(e) {
    const dropdown = document.querySelector('.nav-dropdown');
    const menuBtn = document.querySelector('.nav-menu-btn');
    
    if (!dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
        dropdown.classList.remove('active');
        document.removeEventListener('click', closeNavMenu);
    }
}

// ã‚¹ãƒ¯ã‚¤ãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
function setupSwipeNavigation() {
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    const mainContent = document.querySelector('.main-content');
    const sections = ['dashboard', 'play', 'calendar', 'daily', 'weekly', 'monthly', 'quarterly', 'completed', 'trash'];
    
    // ã‚¿ãƒƒãƒé–‹å§‹
    mainContent.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });
    
    // ã‚¿ãƒƒãƒçµ‚äº†
    mainContent.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    }, { passive: true });
    
    function handleSwipe() {
        const swipeDistanceX = touchEndX - touchStartX;
        const swipeDistanceY = Math.abs(touchEndY - touchStartY);
        
        // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å ´åˆã¯ç„¡è¦–ï¼ˆæ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã‚ˆã‚Šç¸¦ã®ç§»å‹•ãŒå¤§ãã„å ´åˆï¼‰
        if (swipeDistanceY > Math.abs(swipeDistanceX)) {
            return;
        }
        
        // æœ€å°ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ï¼ˆ50pxï¼‰
        if (Math.abs(swipeDistanceX) < 50) {
            return;
        }
        
        const currentIndex = sections.indexOf(app.currentSection);
        let newIndex = currentIndex;
        
        if (swipeDistanceX > 0 && currentIndex > 0) {
            // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ï¼‰
            newIndex = currentIndex - 1;
        } else if (swipeDistanceX < 0 && currentIndex < sections.length - 1) {
            // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ï¼‰
            newIndex = currentIndex + 1;
        }
        
        if (newIndex !== currentIndex) {
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
            const newSection = sections[newIndex];
            UI.showSection(newSection);
        }
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
function setupEventListeners() {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
    
    // ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã®è¿½åŠ 
    setupSwipeNavigation();
}

// è¤‡æ•°ã‚¿ãƒ–åŒæœŸå‡¦ç†
function handleStorageChange(e) {
    if (e.key && e.key.startsWith('pdca_')) {
        const loadedData = DataManager.loadData();
        if (loadedData) {
            app.ideas = loadedData.ideas;
            app.projects = loadedData.projects;
            app.logs = loadedData.logs;
            app.improvements = loadedData.improvements;
            app.apiKey = loadedData.apiKey;
        }
        renderCurrentSection();
        UI.showToast('ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
    }
}

// ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†æç”»
function renderCurrentSection() {
    if (app.currentSection === 'dashboard') {
        renderDashboard();
    } else if (app.currentSection === 'play') {
        renderIdeas();
    } else if (app.currentSection === 'completed') {
        renderCompletedProjects();
    } else if (app.currentSection === 'trash') {
        renderTrashProjects();
    } else if (app.currentSection === 'weekly') {
        renderWeeklyReport();
    } else if (app.currentSection === 'daily') {
        renderDailyComment();
    } else if (app.currentSection === 'monthly') {
        renderMonthlyInsight();
    } else if (app.currentSection === 'quarterly') {
        renderQuarterlyInsight();
    } else if (app.currentSection === 'calendar') {
        renderCalendar();
    }
}

// æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
function filterProjects() {
    app.searchQuery = document.getElementById('searchInput').value.toLowerCase();
    renderDashboard();
}

function setFilter(phase) {
    app.filterPhase = phase;
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ã‚°ã®æ›´æ–°
    document.querySelectorAll('.filter-tag').forEach(tag => {
        tag.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderDashboard();
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æç”»
function renderDashboard() {
    const grid = document.getElementById('projectGrid');
    const emptyState = document.getElementById('emptyState');
    
    let activeProjects = app.projects.filter(p => !p.completed && !p.deleted);
    
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (app.searchQuery) {
        activeProjects = activeProjects.filter(p => 
            p.name.toLowerCase().includes(app.searchQuery) ||
            p.goal.toLowerCase().includes(app.searchQuery)
        );
    }
    
    // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (app.filterPhase !== 'all') {
        activeProjects = activeProjects.filter(p => p.phase === app.filterPhase);
    }
    
    if (activeProjects.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    grid.innerHTML = activeProjects.map(project => {
        const progress = calculateProjectProgress(project);
        const phaseColors = {
            'Play': '#6366f1',
            'Design': '#f59e0b',
            'Check': '#10b981',
            'Adapt': '#ef4444'
        };
        
        // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®é”æˆç‡ã‚’è¨ˆç®—
        const checkpointStats = calculateCheckpointStats(project);
        
        return `
            <div class="project-card" onclick="showProjectDetail('${project.id}')">
                <div class="trash-icon" onclick="moveToTrash(event, '${project.id}')">ğŸ—‘ï¸</div>
                <div class="project-header">
                    <div>
                        <div class="project-title">${project.name}</div>
                        <div style="font-size: 0.875rem; color: var(--gray);">${project.duration}æ—¥é–“</div>
                    </div>
                    <div class="project-phase" style="background: ${phaseColors[project.phase] || phaseColors.Play}">
                        ${project.phase}
                    </div>
                </div>
                
                <div class="project-stats">
                    <div class="stat-item">
                        <div class="stat-value">${progress}%</div>
                        <div class="stat-label">ç·åˆé€²æ—</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${getProjectDaysLeft(project)}</div>
                        <div class="stat-label">æ®‹ã‚Šæ—¥æ•°</div>
                    </div>
                </div>
                
                ${project.trackingType === 'daily' && checkpointStats.length > 0 ? `
                    <div class="checkpoint-progress">
                        ${checkpointStats.map(stat => `
                            <div class="checkpoint-item">
                                <span class="checkpoint-name">${stat.name}</span>
                                <span class="checkpoint-rate">${stat.rate}%</span>
                                <div class="mini-progress">
                                    <div class="mini-progress-fill" style="width: ${stat.rate}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${project.trackingType === 'count' ? renderCounterSection(project) : ''}
                
                ${project.trackingType === 'milestone' ? renderMilestoneProgress(project) : ''}
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                
                ${renderPhaseActions(project)}
            </div>
        `;
    }).join('');
}

// ã‚´ãƒŸç®±ã¸ç§»å‹•
function moveToTrash(event, projectId) {
    event.stopPropagation();
    
    const project = app.projects.find(p => p.id === projectId);
    if (project) {
        project.deleted = true;
        project.deletedAt = new Date().toISOString();
        saveData();
        renderDashboard();
        UI.showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã—ãŸ', 'success');
    }
}

// ã‚´ãƒŸç®±ã‹ã‚‰å¾©å…ƒ
function restoreFromTrash(event, projectId) {
    event.stopPropagation();
    
    const project = app.projects.find(p => p.id === projectId);
    if (project) {
        delete project.deleted;
        delete project.deletedAt;
        saveData();
        renderTrashProjects();
        UI.showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
    }
}

// ã‚´ãƒŸç®±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»
function renderTrashProjects() {
    const grid = document.getElementById('trashGrid');
    const emptyState = document.getElementById('trashEmpty');
    
    const deletedProjects = app.projects.filter(p => p.deleted);
    
    if (deletedProjects.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    grid.innerHTML = deletedProjects.map(project => {
        const deletedDate = new Date(project.deletedAt);
        
        return `
            <div class="project-card" style="opacity: 0.7;">
                <div class="project-header">
                    <div>
                        <div class="project-title">${project.name}</div>
                        <div style="font-size: 0.875rem; color: var(--gray);">
                            å‰Šé™¤æ—¥: ${formatDate(deletedDate)}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                            onclick="restoreFromTrash(event, '${project.id}')">
                        å¾©å…ƒã™ã‚‹
                    </button>
                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                            onclick="permanentlyDelete(event, '${project.id}')">
                        å®Œå…¨ã«å‰Šé™¤
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// å®Œå…¨å‰Šé™¤
function permanentlyDelete(event, projectId) {
    event.stopPropagation();
    
    if (confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        app.projects = app.projects.filter(p => p.id !== projectId);
        app.logs = app.logs.filter(log => log.projectId !== projectId);
        saveData();
        renderTrashProjects();
        UI.showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
}

// ã‚´ãƒŸç®±ã‚’ç©ºã«ã™ã‚‹
function emptyTrash() {
    if (confirm('ã‚´ãƒŸç®±å†…ã®ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        const deletedProjectIds = app.projects
            .filter(p => p.deleted)
            .map(p => p.id);
        
        app.projects = app.projects.filter(p => !p.deleted);
        app.logs = app.logs.filter(log => !deletedProjectIds.includes(log.projectId));
        
        saveData();
        renderTrashProjects();
        UI.showToast('ã‚´ãƒŸç®±ã‚’ç©ºã«ã—ã¾ã—ãŸ', 'success');
    }
}

// ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»
function renderCounterSection(project) {
    if (!project.countItems) return '';
    
    return `
        <div class="counter-section">
            ${project.countItems.map((item, index) => {
                const count = getProjectCountForItem(project.id, index);
                return `
                    <div class="counter-item">
                        <span class="counter-label">${item}</span>
                        <div class="counter-controls">
                            <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, -1)">âˆ’</button>
                            <span class="counter-value" onclick="editCount(event, '${project.id}', ${index})" id="count_${project.id}_${index}">${count}</span>
                            <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, 1)">+</button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€²æ—ã®æç”»
function renderMilestoneProgress(project) {
    if (!project.milestones) return '';
    
    const achievedCount = getMilestoneAchievedCount(project);
    return `
        <div style="margin-top: 1rem;">
            <div style="font-size: 0.875rem; color: var(--gray);">
                é”æˆæ¸ˆã¿: ${achievedCount} / ${project.milestones.length}
            </div>
        </div>
    `;
}

// å®Œäº†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æç”»
function renderCompletedProjects() {
    const grid = document.getElementById('completedGrid');
    const emptyState = document.getElementById('completedEmpty');
    
    const completedProjects = app.projects.filter(p => p.completed && !p.deleted);
    
    if (completedProjects.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    grid.innerHTML = completedProjects.map(project => {
        const completedDate = project.completedAt ? new Date(project.completedAt) : null;
        
        return `
            <div class="project-card completed" onclick="showProjectDetail('${project.id}')">
                <div class="project-header">
                    <div>
                        <div class="project-title">
                            ${project.name}
                            <span class="completed-badge">å®Œäº†</span>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--gray);">
                            ${completedDate ? `å®Œäº†æ—¥: ${formatDate(completedDate)}` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="project-stats">
                    <div class="stat-item">
                        <div class="stat-value">${project.duration}</div>
                        <div class="stat-label">å®Ÿæ–½æ—¥æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${project.cycleCount || 1}</div>
                        <div class="stat-label">ã‚µã‚¤ã‚¯ãƒ«æ•°</div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                            onclick="reactivateProject(event, '${project.id}')">
                        å†é–‹ã™ã‚‹
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
function renderPhaseActions(project) {
    const actions = {
        'Play': [
            { icon: 'ğŸ’¡', text: 'ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…·ä½“åŒ–', action: 'moveToDesign' }
        ],
        'Design': [
            { icon: 'â–¶ï¸', text: 'å®Ÿè¡Œé–‹å§‹', action: 'moveToCheck' },
            { icon: 'â—€ï¸', text: 'ã‚¢ã‚¤ãƒ‡ã‚¢ã«æˆ»ã™', action: 'moveToPlay' }
        ],
        'Check': [
            { icon: 'ğŸ“', text: 'ä»Šæ—¥ã®è¨˜éŒ²', action: 'showDailyLog' },
            { icon: 'ğŸ“Š', text: 'é€²æ—ã‚’åˆ†æ', action: 'analyzeProgress' },
            { icon: 'ğŸ”„', text: 'æ”¹å–„ãƒ•ã‚§ãƒ¼ã‚ºã¸', action: 'moveToAdapt' },
            { icon: 'â—€ï¸', text: 'è¨­è¨ˆã«æˆ»ã‚‹', action: 'moveToDesign' }
        ],
        'Adapt': [
            { icon: 'ğŸ“', text: 'æ”¹å–„ç‚¹ãƒ¡ãƒ¢', action: 'showImprovements' },
            { icon: 'âœ…', text: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†', action: 'completeProject' },
            { icon: 'ğŸ”„', text: 'å†è¨­è¨ˆã™ã‚‹', action: 'moveToDesign' },
            { icon: 'â–¶ï¸', text: 'å®Ÿè¡Œã«æˆ»ã‚‹', action: 'moveToCheck' }
        ]
    };

    const phaseActions = actions[project.phase] || [];
    if (phaseActions.length === 0) return '';

    return `
        <div class="phase-actions">
            ${phaseActions.map(action => `
                <div class="phase-action" onclick="handlePhaseAction(event, '${project.id}', '${action.action}')">
                    <span class="phase-action-icon">${action.icon}</span>
                    <span>${action.text}</span>
                </div>
            `).join('')}
        </div>
    `;
}

// ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
function handlePhaseAction(event, projectId, action) {
    event.stopPropagation();
    
    switch (action) {
        case 'moveToPlay':
            moveToPhase(projectId, 'Play');
            break;
        case 'moveToDesign':
            moveToPhase(projectId, 'Design');
            break;
        case 'showDailyLog':
            showDailyLog(projectId);
            break;
        case 'moveToCheck':
            moveToPhase(projectId, 'Check');
            break;
        case 'analyzeProgress':
            analyzeProjectProgress(projectId);
            break;
        case 'moveToAdapt':
            moveToPhase(projectId, 'Adapt');
            break;
        case 'showImprovements':
            showImprovementModal(projectId);
            break;
        case 'completeProject':
            completeProject(projectId);
            break;
        case 'restartCycle':
            restartProjectCycle(projectId);
            break;
    }
}

// ã‚«ã‚¦ãƒ³ãƒˆã®å¢—æ¸›
function incrementCount(event, projectId, itemIndex, delta) {
    event.stopPropagation();
    
    const log = {
        id: Date.now().toString(),
        projectId: projectId,
        date: new Date().toISOString(),
        type: 'count',
        itemIndex: itemIndex,
        value: delta
    };
    
    app.logs.push(log);
    saveData();
    
    // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
    const countElement = document.getElementById(`count_${projectId}_${itemIndex}`);
    if (countElement) {
        const newCount = getProjectCountForItem(projectId, itemIndex);
        countElement.textContent = newCount;
    }
    
    UI.showToast(`ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${delta > 0 ? '+' : ''}${delta}`, 'success');
}

// ã‚«ã‚¦ãƒ³ãƒˆã®ç›´æ¥ç·¨é›†
function editCount(event, projectId, itemIndex) {
    event.stopPropagation();
    
    const countElement = event.target;
    const currentCount = getProjectCountForItem(projectId, itemIndex);
    
    // inputã«ç½®ãæ›ãˆ
    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'counter-input';
    input.value = currentCount;
    input.onclick = (e) => e.stopPropagation();
    
    input.onblur = () => {
        const newValue = parseInt(input.value) || 0;
        const delta = newValue - currentCount;
        
        if (delta !== 0) {
            const log = {
                id: Date.now().toString(),
                projectId: projectId,
                date: new Date().toISOString(),
                type: 'count',
                itemIndex: itemIndex,
                value: delta
            };
            
            app.logs.push(log);
            saveData();
            UI.showToast('ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        }
        
        // å…ƒã®è¡¨ç¤ºã«æˆ»ã™
        countElement.textContent = newValue;
        countElement.style.display = '';
        input.remove();
    };
    
    input.onkeypress = (e) => {
        if (e.key === 'Enter') {
            input.blur();
        }
    };
    
    countElement.style.display = 'none';
    countElement.parentElement.insertBefore(input, countElement.nextSibling);
    input.focus();
    input.select();
}

// ç‰¹å®šé …ç›®ã®ã‚«ã‚¦ãƒ³ãƒˆå–å¾—
function getProjectCountForItem(projectId, itemIndex) {
    return app.logs.filter(log => 
        log.projectId === projectId && 
        log.type === 'count' &&
        log.itemIndex === itemIndex
    ).reduce((sum, log) => sum + (log.value || 0), 0);
}

// ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆæ•°ã®å–å¾—
function getMilestoneAchievedCount(project) {
    const milestoneLogs = app.logs.filter(log =>
        log.projectId === project.id &&
        log.type === 'milestone'
    );
    
    const achievedMilestones = new Set();
    milestoneLogs.forEach(log => {
        if (log.achieved) {
            achievedMilestones.add(log.milestoneIndex);
        }
    });
    
    return achievedMilestones.size;
}

// ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®çµ±è¨ˆã‚’è¨ˆç®—
function calculateCheckpointStats(project) {
    if (project.trackingType !== 'daily' || !project.checkpoints) return [];
    
    const projectLogs = app.logs.filter(log => log.projectId === project.id);
    
    return project.checkpoints.map((checkpoint, index) => {
        const completedCount = projectLogs.filter(log => 
            log.checkpoints && log.checkpoints[index] === true
        ).length;
        
        const totalDays = Math.min(
            Math.floor((new Date() - new Date(project.startDate)) / (1000 * 60 * 60 * 24)) + 1,
            project.duration
        );
        
        const rate = totalDays > 0 ? Math.round((completedCount / totalDays) * 100) : 0;
        
        return {
            name: checkpoint,
            completedCount,
            totalDays,
            rate
        };
    });
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã®åˆ†æ
function analyzeProjectProgress(projectId) {
    const project = app.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const stats = calculateCheckpointStats(project);
    const overallProgress = calculateProjectProgress(project);
    
    let analysis = `ğŸ“Š ${project.name} ã®é€²æ—åˆ†æ\n\n`;
    analysis += `ç·åˆé€²æ—: ${overallProgress}%\n`;
    analysis += `çµŒéæ—¥æ•°: ${Math.floor((new Date() - new Date(project.startDate)) / (1000 * 60 * 60 * 24)) + 1}æ—¥\n\n`;
    
    if (stats.length > 0) {
        analysis += `é …ç›®åˆ¥é”æˆç‡:\n`;
        stats.forEach(stat => {
            analysis += `â€¢ ${stat.name}: ${stat.rate}% (${stat.completedCount}/${stat.totalDays}æ—¥)\n`;
        });
        
        // æœ€ã‚‚é”æˆç‡ãŒé«˜ã„é …ç›®ã¨ä½ã„é …ç›®ã‚’ç‰¹å®š
        const bestItem = stats.reduce((best, current) => 
            current.rate > best.rate ? current : best
        );
        const worstItem = stats.reduce((worst, current) => 
            current.rate < worst.rate ? current : worst
        );
        
        analysis += `\nğŸ’ª æœ€ã‚‚é †èª¿: ${bestItem.name} (${bestItem.rate}%)\n`;
        analysis += `âš ï¸ è¦æ”¹å–„: ${worstItem.name} (${worstItem.rate}%)\n`;
    }
    
    alert(analysis);
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã®è¨ˆç®—
function calculateProjectProgress(project) {
    if (project.trackingType === 'daily') {
        const logs = app.logs.filter(log => log.projectId === project.id);
        const totalCheckpoints = project.checkpoints.length * project.duration;
        let completedCheckpoints = 0;
        
        logs.forEach(log => {
            if (log.checkpoints) {
                completedCheckpoints += Object.values(log.checkpoints).filter(v => v === true).length;
            }
        });
        
        return totalCheckpoints > 0 ? Math.round((completedCheckpoints / totalCheckpoints) * 100) : 0;
    } else if (project.trackingType === 'count') {
        // ã‚«ã‚¦ãƒ³ãƒˆå‹ã®é€²æ—ï¼ˆä»®ï¼š100å›ã‚’ç›®æ¨™ã¨ã—ã¦è¨ˆç®—ï¼‰
        const totalCount = project.countItems.reduce((sum, _, index) => {
            return sum + getProjectCountForItem(project.id, index);
        }, 0);
        const targetCount = project.countItems.length * 100; // å„é …ç›®100å›ã‚’ç›®æ¨™
        return Math.min(100, Math.round((totalCount / targetCount) * 100));
    } else if (project.trackingType === 'milestone') {
        const achieved = getMilestoneAchievedCount(project);
        const total = project.milestones.length;
        return Math.round((achieved / total) * 100);
    }
    return 0;
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ®‹ã‚Šæ—¥æ•°ã‚’å–å¾—
function getProjectDaysLeft(project) {
    const startDate = new Date(project.startDate);
    const endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + project.duration);
    
    const today = new Date();
    const daysLeft = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
    
    return Math.max(0, daysLeft);
}

// ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã‚’å–å¾—
function getPhaseDescription(phase) {
    const descriptions = {
        'Play': 'ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è‡ªç”±ã«è€ƒãˆã€å¯èƒ½æ€§ã‚’æ¢ã‚‹æ®µéš',
        'Design': 'ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…·ä½“çš„ãªè¨ˆç”»ã«è½ã¨ã—è¾¼ã‚€æ®µéš',
        'Check': 'è¨ˆç”»ã‚’å®Ÿè¡Œã—ã€é€²æ—ã‚’ç¢ºèªã™ã‚‹æ®µéš',
        'Adapt': 'çµæœã‚’è©•ä¾¡ã—ã€æ”¹å–„ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹æ®µéš'
    };
    return descriptions[phase] || '';
}

// ãƒ•ã‚§ãƒ¼ã‚ºç§»å‹•
function moveToPhase(projectId, newPhase) {
    const project = app.projects.find(p => p.id === projectId);
    if (!project) return;
    
    project.phase = newPhase;
    saveData();
    renderDashboard();
    
    UI.showToast(`${newPhase}ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»å‹•ã—ã¾ã—ãŸ`, 'success');
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Œäº†
function completeProject(projectId) {
    const project = app.projects.find(p => p.id === projectId);
    if (!project) return;
    
    if (confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ')) {
        project.completed = true;
        project.completedAt = new Date().toISOString();
        saveData();
        renderDashboard();
        
        UI.showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
    }
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å†é–‹
function reactivateProject(event, projectId) {
    event.stopPropagation();
    
    const project = app.projects.find(p => p.id === projectId);
    if (!project) return;
    
    project.completed = false;
    project.phase = 'Design';
    delete project.completedAt;
    
    saveData();
    UI.showSection('dashboard');
    
    UI.showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†é–‹ã—ã¾ã—ãŸ', 'success');
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ã‚¯ãƒ«ã®å†é–‹
function restartProjectCycle(projectId) {
    const project = app.projects.find(p => p.id === projectId);
    if (!project) return;
    
    // ã‚µã‚¤ã‚¯ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
    project.cycleCount = (project.cycleCount || 1) + 1;
    project.phase = 'Design';
    project.startDate = new Date().toISOString();
    
    saveData();
    renderDashboard();
    
    UI.showToast('æ–°ã—ã„ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showAddModal() {
    UI.showModal('addModal');
    document.getElementById('ideaContent').value = '';
}

function showProjectDetail(projectId) {
    const project = app.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const modal = document.getElementById('projectModal');
    const title = document.getElementById('projectModalTitle');
    const body = document.getElementById('projectModalBody');
    
    title.textContent = project.name;
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è©³ç´°è¡¨ç¤º
    const logs = app.logs.filter(log => log.projectId === projectId);
    const completedDays = logs.filter(log => log.completed).length;
    const checkpointStats = calculateCheckpointStats(project);
    
    body.innerHTML = `
        <div class="form-group">
            <label class="form-label">ã‚´ãƒ¼ãƒ«</label>
            <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius);">
                ${project.goal}
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º: ${project.phase}</label>
            <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius);">
                ${getPhaseDescription(project.phase)}
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">é€²æ—çŠ¶æ³</label>
            <div class="project-stats" style="margin-top: 0;">
                <div class="stat-item">
                    <div class="stat-value">${completedDays}</div>
                    <div class="stat-label">å®Ÿè¡Œæ—¥æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${project.duration}</div>
                    <div class="stat-label">ç›®æ¨™æ—¥æ•°</div>
                </div>
            </div>
        </div>
        
        ${project.trackingType === 'daily' && checkpointStats.length > 0 ? `
            <div class="form-group">
                <label class="form-label">ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåˆ¥é”æˆç‡</label>
                ${checkpointStats.map(stat => `
                    <div class="checkpoint-item">
                        <span class="checkpoint-name">${stat.name}</span>
                        <span class="checkpoint-rate">${stat.rate}% (${stat.completedCount}/${stat.totalDays}æ—¥)</span>
                        <div class="mini-progress">
                            <div class="mini-progress-fill" style="width: ${stat.rate}%"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        
        ${project.trackingType === 'count' && project.countItems ? `
            <div class="form-group">
                <label class="form-label">ã‚«ã‚¦ãƒ³ãƒˆé€²æ—</label>
                ${project.countItems.map((item, index) => `
                    <div style="padding: 0.5rem; background: var(--light-gray); border-radius: var(--radius); margin-bottom: 0.5rem;">
                        ${item}: ${getProjectCountForItem(project.id, index)}
                    </div>
                `).join('')}
            </div>
        ` : ''}
        
        ${project.trackingType === 'milestone' && project.milestones ? `
            <div class="form-group">
                <label class="form-label">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</label>
                ${project.milestones.map((milestone, index) => {
                    const isAchieved = isMilestoneAchieved(project.id, index);
                    return `
                        <div class="milestone-item">
                            <span class="${isAchieved ? 'milestone-achieved' : ''}">${milestone}</span>
                            ${isAchieved ? 'âœ…' : 'â­•'}
                        </div>
                    `;
                }).join('')}
            </div>
        ` : ''}
    `;
    
    UI.showModal('projectModal');
}

function showSettings() {
    updateNotificationStatus();
    UI.showModal('settingsModal');
}

function showAPIKeyModal() {
    UI.closeModal('settingsModal');
    const modal = document.getElementById('apiKeyModal');
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.value = app.apiKey || '';
    UI.showModal('apiKeyModal');
}

// æ”¹å–„ç‚¹ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
function showImprovementModal(projectId) {
    app.currentProjectId = projectId;
    const modal = document.getElementById('improvementModal');
    const project = app.projects.find(p => p.id === projectId);
    
    if (!project) return;
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤º
    const modalTitle = modal.querySelector('.modal-title');
    modalTitle.textContent = `æ”¹å–„ç‚¹ãƒ¡ãƒ¢ - ${project.name}`;
    
    // æ”¹å–„ç‚¹ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    renderImprovementsList(projectId);
    
    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('newImprovement').value = '';
    
    UI.showModal('improvementModal');
}

// æ”¹å–„ç‚¹ãƒ¡ãƒ¢ã®è¿½åŠ 
function addImprovementMemo() {
    const content = document.getElementById('newImprovement').value.trim();
    if (!content) return;
    
    const improvement = {
        id: Date.now().toString(),
        projectId: app.currentProjectId,
        content: content,
        createdAt: new Date().toISOString(),
        type: 'memo' // 'daily'ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚
    };
    
    app.improvements.push(improvement);
    saveData();
    
    document.getElementById('newImprovement').value = '';
    renderImprovementsList(app.currentProjectId);
    
    UI.showToast('æ”¹å–„ç‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

// æ”¹å–„ç‚¹ãƒªã‚¹ãƒˆã®è¡¨ç¤º
function renderImprovementsList(projectId) {
    const listDiv = document.getElementById('improvementsList');
    const projectImprovements = app.improvements
        .filter(imp => imp.projectId === projectId)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    if (projectImprovements.length === 0) {
        listDiv.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 2rem;">ã¾ã æ”¹å–„ç‚¹ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    
    listDiv.innerHTML = `
        <h4 style="margin-bottom: 1rem;">æ”¹å–„ç‚¹å±¥æ­´</h4>
        ${projectImprovements.map(imp => {
            const date = new Date(imp.createdAt);
            const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            return `
                <div style="background: var(--light-gray); padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">${dateStr}</div>
                            <div style="white-space: pre-wrap;">${imp.content}</div>
                        </div>
                        <button onclick="deleteImprovement('${imp.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0.25rem;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
        }).join('')}
    `;
}

// æ”¹å–„ç‚¹ã®å‰Šé™¤
function deleteImprovement(improvementId) {
    if (confirm('ã“ã®æ”¹å–„ç‚¹ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        app.improvements = app.improvements.filter(imp => imp.id !== improvementId);
        saveData();
        renderImprovementsList(app.currentProjectId);
        UI.showToast('æ”¹å–„ç‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
}

// ã‚¢ã‚¤ãƒ‡ã‚¢ã®è¿½åŠ 
function addIdea() {
    const content = document.getElementById('ideaContent').value.trim();
    
    if (!content) return;
    
    const idea = {
        id: Date.now().toString(),
        content: content,
        createdAt: new Date().toISOString()
    };
    
    app.ideas.push(idea);
    saveData();
    
    UI.closeModal('addModal');
    renderIdeas();
    
    UI.showToast('ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
}

// ã‚¢ã‚¤ãƒ‡ã‚¢ãƒªã‚¹ãƒˆã®æç”»
function renderIdeas() {
    const list = document.getElementById('inboxList');
    const emptyState = document.getElementById('inboxEmpty');
    
    if (app.ideas.length === 0) {
        list.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    list.innerHTML = app.ideas.map(idea => `
        <div class="inbox-item">
            <div class="inbox-content">
                <div>${idea.content}</div>
                <div class="inbox-date">${formatDate(new Date(idea.createdAt))}</div>
            </div>
            <button class="inbox-action" onclick="startDesign('${idea.id}')">
                ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–
            </button>
        </div>
    `).join('');
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆé–‹å§‹
function startDesign(ideaId) {
    const idea = app.ideas.find(i => i.id === ideaId);
    if (!idea) return;
    
    // ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ä¸€æ™‚ä¿å­˜
    app.currentIdeaId = ideaId;
    
    // ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modal = document.getElementById('designModal');
    document.getElementById('projectName').value = idea.content;
    document.getElementById('projectGoal').value = '';
    document.getElementById('projectDuration').value = '30';
    document.getElementById('trackingType').value = 'daily';
    updateTrackingUI();
    
    UI.showModal('designModal');
}

// ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°UIã®æ›´æ–°
function updateTrackingUI() {
    const trackingType = document.getElementById('trackingType').value;
    
    document.getElementById('dailyCheckGroup').style.display = 
        trackingType === 'daily' ? 'block' : 'none';
    document.getElementById('countGroup').style.display = 
        trackingType === 'count' ? 'block' : 'none';
    document.getElementById('milestoneGroup').style.display = 
        trackingType === 'milestone' ? 'block' : 'none';
}

// ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
function addCheckpoint() {
    const container = document.getElementById('checkpoints');
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.style.marginBottom = '0.5rem';
    input.placeholder = 'ä¾‹: ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’5åˆ†å®Ÿæ–½';
    container.appendChild(input);
}

// ã‚«ã‚¦ãƒ³ãƒˆé …ç›®è¿½åŠ 
function addCountItem() {
    const container = document.getElementById('countItems');
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.style.marginBottom = '0.5rem';
    input.placeholder = 'ä¾‹: è…¹ç­‹ã®å›æ•°';
    container.appendChild(input);
}

// ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¿½åŠ 
function addMilestone() {
    const container = document.getElementById('milestones');
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control';
    input.style.marginBottom = '0.5rem';
    input.placeholder = 'ä¾‹: 100å›é€£ç¶šã§è…¹ç­‹ãŒã§ãã‚‹';
    container.appendChild(input);
}

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
function createProject() {
    const name = document.getElementById('projectName').value.trim();
    const goal = document.getElementById('projectGoal').value.trim();
    const duration = parseInt(document.getElementById('projectDuration').value);
    const trackingType = document.getElementById('trackingType').value;
    
    if (!name || !goal) {
        alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨ã‚´ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const project = {
        id: Date.now().toString(),
        name: name,
        goal: goal,
        duration: duration,
        trackingType: trackingType,
        phase: 'Design',
        startDate: new Date().toISOString(),
        createdAt: new Date().toISOString(),
        cycleCount: 1
    };
    
    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é …ç›®ã‚’è¿½åŠ 
    if (trackingType === 'daily') {
        const checkpoints = Array.from(document.querySelectorAll('#checkpoints input'))
            .map(input => input.value.trim())
            .filter(value => value);
        
        if (checkpoints.length === 0) {
            alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        project.checkpoints = checkpoints;
    } else if (trackingType === 'count') {
        const countItems = Array.from(document.querySelectorAll('#countItems input'))
            .map(input => input.value.trim())
            .filter(value => value);
        
        if (countItems.length === 0) {
            alert('å°‘ãªãã¨ã‚‚1ã¤ã®ã‚«ã‚¦ãƒ³ãƒˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        project.countItems = countItems;
    } else if (trackingType === 'milestone') {
        const milestones = Array.from(document.querySelectorAll('#milestones input'))
            .map(input => input.value.trim())
            .filter(value => value);
        
        if (milestones.length === 0) {
            alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        project.milestones = milestones;
    }
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
    app.projects.push(project);
    
    // å…ƒã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‰Šé™¤
    if (app.currentIdeaId) {
        app.ideas = app.ideas.filter(i => i.id !== app.currentIdeaId);
        app.currentIdeaId = null;
    }
    
    saveData();
    UI.closeModal('designModal');
    UI.showSection('dashboard');
    
    UI.showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
}

// æ—¥æ¬¡ãƒ­ã‚°ã®è¡¨ç¤º
function showDailyLog(projectId) {
    // ç‰¹å®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã‚’è¡¨ç¤º
    if (projectId) {
        app.currentProjectId = projectId;
    } else {
        // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ¥ãŸå ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ãƒ•ã‚§ãƒ¼ã‚ºã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
        app.currentProjectId = null;
    }
    
    const modal = document.getElementById('logModal');
    const body = document.getElementById('logModalBody');
    
    const today = new Date().toDateString();
    const projects = app.currentProjectId 
        ? app.projects.filter(p => p.id === app.currentProjectId)
        : app.projects.filter(p => p.phase === 'Check' && !p.completed && !p.deleted);
    
    const dailyProjects = projects.filter(p => p.trackingType === 'daily');
    const countProjects = projects.filter(p => p.trackingType === 'count');
    const milestoneProjects = projects.filter(p => p.trackingType === 'milestone');
    
    let html = '';
    
    // æ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é …ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    html += `
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">ä»Šæ—¥ã®æ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é …</h4>
            <textarea 
                id="dailyImprovements" 
                class="form-control" 
                rows="3" 
                placeholder="ä»Šæ—¥å®Ÿæ–½ã—ãŸæ”¹å–„ç‚¹ã‚„ã€æ–°ã—ãé©å¿œã—ãŸã“ã¨ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹ï¼šä½œæ¥­æ™‚é–“ã‚’æœã«å¤‰æ›´ã—ãŸã€æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’å°å…¥ã—ãŸã€ãªã©"
                style="width: 100%; resize: vertical;"
            >${getTodayImprovements()}</textarea>
        </div>
    `;
    
    // æ¯æ—¥ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
    if (dailyProjects.length > 0) {
        html += '<h4 style="margin-bottom: 1rem;">ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯é …ç›®</h4>';
        dailyProjects.forEach(project => {
            const todayLog = app.logs.find(log => 
                log.projectId === project.id && 
                new Date(log.date).toDateString() === today
            );
            
            html += `
                <div style="margin-bottom: 1.5rem;">
                    <h5 style="margin-bottom: 0.5rem;">${project.name}</h5>
                    ${project.checkpoints.map((checkpoint, index) => `
                        <div class="checkbox-group">
                            <input type="checkbox" 
                                   id="check_${project.id}_${index}"
                                   ${todayLog && todayLog.checkpoints && todayLog.checkpoints[index] ? 'checked' : ''}>
                            <label for="check_${project.id}_${index}" class="checkbox-label">
                                ${checkpoint}
                            </label>
                        </div>
                    `).join('')}
                </div>
            `;
        });
    }
    
    // ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
    if (countProjects.length > 0) {
        html += '<h4 style="margin-top: 2rem; margin-bottom: 1rem;">ã‚«ã‚¦ãƒ³ãƒˆé …ç›®</h4>';
        countProjects.forEach(project => {
            html += `
                <div style="margin-bottom: 1.5rem;">
                    <h5 style="margin-bottom: 0.5rem;">${project.name}</h5>
                    ${project.countItems.map((item, index) => {
                        const count = getProjectCountForItem(project.id, index);
                        return `
                            <div class="counter-item">
                                <span class="counter-label">${item}</span>
                                <div class="counter-controls">
                                    <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, -1)">âˆ’</button>
                                    <span class="counter-value" id="modal_count_${project.id}_${index}">${count}</span>
                                    <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, 1)">+</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        });
    }
    
    // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
    if (milestoneProjects.length > 0) {
        html += '<h4 style="margin-top: 2rem; margin-bottom: 1rem;">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆ</h4>';
        milestoneProjects.forEach(project => {
            html += `
                <div style="margin-bottom: 1.5rem;">
                    <h5 style="margin-bottom: 0.5rem;">${project.name}</h5>
                    ${project.milestones.map((milestone, index) => {
                        const achieved = isMilestoneAchieved(project.id, index);
                        const tempKey = `milestone_${project.id}_${index}`;
                        const tempAchieved = sessionStorage.getItem(tempKey) === 'true';
                        
                        return `
                            <div class="milestone-item">
                                <input type="checkbox" 
                                       class="milestone-checkbox"
                                       id="milestone_${project.id}_${index}"
                                       ${achieved || tempAchieved ? 'checked' : ''}
                                       onchange="toggleMilestone('${project.id}', ${index}, this.checked)">
                                <label for="milestone_${project.id}_${index}" 
                                       class="milestone-text ${achieved || tempAchieved ? 'milestone-achieved' : ''}">
                                    ${milestone}
                                </label>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        });
    }
    
    if (html === '') {
        html = '<p style="text-align: center; color: var(--gray);">è¨˜éŒ²ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }
    
    body.innerHTML = html;
    UI.showModal('logModal');
    
    // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒãƒŠãƒ¼ã‚’éè¡¨ç¤º
    document.getElementById('reminderBanner').classList.remove('show');
}

// ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
function toggleMilestone(projectId, milestoneIndex, achieved) {
    const tempKey = `milestone_${projectId}_${milestoneIndex}`;
    sessionStorage.setItem(tempKey, achieved ? 'true' : 'false');
    
    // UIã®æ›´æ–°
    const label = document.querySelector(`label[for="milestone_${projectId}_${milestoneIndex}"]`);
    if (label) {
        if (achieved) {
            label.classList.add('milestone-achieved');
        } else {
            label.classList.remove('milestone-achieved');
        }
    }
}

// ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãŒé”æˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
function isMilestoneAchieved(projectId, milestoneIndex) {
    const latestLog = app.logs
        .filter(log => 
            log.projectId === projectId && 
            log.type === 'milestone' &&
            log.milestoneIndex === milestoneIndex
        )
        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    
    return latestLog && latestLog.achieved;
}

// ä»Šæ—¥ã®æ”¹å–„ç‚¹ã‚’å–å¾—
function getTodayImprovements() {
    const today = new Date().toDateString();
    const todayImprovement = app.improvements?.find(imp => 
        new Date(imp.date).toDateString() === today
    );
    return todayImprovement?.content || '';
}

// æ—¥æ¬¡ãƒ­ã‚°ã®ä¿å­˜
function saveDailyLog() {
    const today = new Date();
    
    // æ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é …ã‚’ä¿å­˜
    const improvementsText = document.getElementById('dailyImprovements')?.value;
    if (improvementsText && improvementsText.trim()) {
        if (!app.improvements) {
            app.improvements = [];
        }
        
        const todayIndex = app.improvements.findIndex(imp => 
            new Date(imp.date).toDateString() === today.toDateString()
        );
        
        const improvement = {
            id: todayIndex >= 0 ? app.improvements[todayIndex].id : Date.now().toString(),
            date: today.toISOString(),
            content: improvementsText.trim()
        };
        
        if (todayIndex >= 0) {
            app.improvements[todayIndex] = improvement;
        } else {
            app.improvements.push(improvement);
        }
    }
    
    // æ¯æ—¥ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‡¦ç†
    const dailyProjects = app.currentProjectId 
        ? app.projects.filter(p => p.id === app.currentProjectId && p.trackingType === 'daily')
        : app.projects.filter(p => p.phase === 'Check' && p.trackingType === 'daily' && !p.completed && !p.deleted);
    
    dailyProjects.forEach(project => {
        const checkpoints = {};
        let hasChecked = false;
        
        project.checkpoints.forEach((_, index) => {
            const checkbox = document.getElementById(`check_${project.id}_${index}`);
            if (checkbox) {
                checkpoints[index] = checkbox.checked;
                if (checkbox.checked) hasChecked = true;
            }
        });
        
        if (hasChecked) {
            // ä»Šæ—¥ã®ãƒ­ã‚°ãŒã‚ã‚‹ã‹ç¢ºèª
            const existingLogIndex = app.logs.findIndex(log => 
                log.projectId === project.id && 
                new Date(log.date).toDateString() === today.toDateString()
            );
            
            const log = {
                id: existingLogIndex >= 0 ? app.logs[existingLogIndex].id : Date.now().toString(),
                projectId: project.id,
                date: today.toISOString(),
                checkpoints: checkpoints,
                completed: Object.values(checkpoints).every(v => v === true)
            };
            
            if (existingLogIndex >= 0) {
                app.logs[existingLogIndex] = log;
            } else {
                app.logs.push(log);
            }
        }
    });
    
    // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®å‡¦ç†
    const milestoneProjects = app.currentProjectId 
        ? app.projects.filter(p => p.id === app.currentProjectId && p.trackingType === 'milestone')
        : app.projects.filter(p => p.phase === 'Check' && p.trackingType === 'milestone' && !p.completed && !p.deleted);
    
    milestoneProjects.forEach(project => {
        project.milestones.forEach((_, index) => {
            const tempKey = `milestone_${project.id}_${index}`;
            const tempValue = sessionStorage.getItem(tempKey);
            
            if (tempValue !== null) {
                const achieved = tempValue === 'true';
                const existingAchieved = isMilestoneAchieved(project.id, index);
                
                if (achieved !== existingAchieved) {
                    const log = {
                        id: Date.now().toString() + '_' + index,
                        projectId: project.id,
                        date: today.toISOString(),
                        type: 'milestone',
                        milestoneIndex: index,
                        achieved: achieved
                    };
                    app.logs.push(log);
                }
                
                sessionStorage.removeItem(tempKey);
            }
        });
    });
    
    // æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ—¥ã‚’æ›´æ–°
    localStorage.setItem(DataManager.STORAGE_KEYS.LAST_CHECK_DATE, today.toDateString());
    
    saveData();
    UI.closeModal('logModal');
    renderDashboard();
    
    UI.showToast('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// æ¯æ—¥ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
function checkDailyReminder() {
    const today = new Date().toDateString();
    const lastCheckDate = localStorage.getItem(DataManager.STORAGE_KEYS.LAST_CHECK_DATE);
    
    // ä»Šæ—¥ã¾ã ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãªã„å ´åˆ
    if (lastCheckDate !== today) {
        const hasActiveProjects = app.projects.some(p => 
            p.phase === 'Check' && p.trackingType === 'daily' && !p.completed && !p.deleted
        );
        
        if (hasActiveProjects) {
            // æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const todayLogs = app.logs.filter(log => 
                new Date(log.date).toDateString() === today
            );
            
            const hasUncompletedTasks = app.projects.some(project => {
                if (project.phase !== 'Check' || project.trackingType !== 'daily' || project.completed || project.deleted) return false;
                
                const todayLog = todayLogs.find(log => log.projectId === project.id);
                return !todayLog || !todayLog.completed;
            });
            
            if (hasUncompletedTasks) {
                document.getElementById('reminderBanner').classList.add('show');
                
                // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’é€ä¿¡
                if (localStorage.getItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS) === 'enabled') {
                    sendNotification();
                }
            }
        }
    }
}

// é€šçŸ¥æ¨©é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}

// ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã®é€ä¿¡
function sendNotification() {
    if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification('PDCA Mosaic - ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯', {
            body: 'ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ï¼',
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%236366f1"/><text x="50" y="65" font-size="50" text-anchor="middle" fill="white">â—ˆ</text></svg>',
            badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%236366f1"/></svg>',
            requireInteraction: true
        });
        
        notification.onclick = function() {
            window.focus();
            showDailyLog();
            notification.close();
        };
    }
}

// é€šçŸ¥è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆ
function toggleNotifications() {
    const currentStatus = localStorage.getItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS);
    const newStatus = currentStatus === 'enabled' ? 'disabled' : 'enabled';
    
    if (newStatus === 'enabled' && 'Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    localStorage.setItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS, 'enabled');
                    updateNotificationStatus();
                }
            });
        } else if (Notification.permission === 'granted') {
            localStorage.setItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS, 'enabled');
            updateNotificationStatus();
        } else {
            alert('ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
        }
    } else {
        localStorage.setItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS, 'disabled');
        updateNotificationStatus();
    }
}

// é€šçŸ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºæ›´æ–°
function updateNotificationStatus() {
    const status = localStorage.getItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS);
    const statusElement = document.getElementById('notificationStatus');
    if (statusElement) {
        statusElement.textContent = status === 'enabled' ? 'é€šçŸ¥ãŒã‚ªãƒ³ã§ã™' : 'é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹';
    }
}

// APIã‚­ãƒ¼ã®ä¿å­˜
function saveAPIKey() {
    const apiKey = document.getElementById('apiKey').value.trim();
    
    if (!apiKey) {
        alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    app.apiKey = apiKey;
    localStorage.setItem(DataManager.STORAGE_KEYS.API_KEY, apiKey);
    
    UI.closeModal('apiKeyModal');
    UI.showToast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

// ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function exportData() {
    const data = {
        ideas: app.ideas,
        projects: app.projects,
        logs: app.logs,
        improvements: app.improvements,
        exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pdca-mosaic-backup-${formatDate(new Date(), 'file')}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    UI.showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
}

// ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function importData() {
    document.getElementById('importFile').click();
}

// ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
function handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (!data.ideas || !data.projects || !data.logs) {
                throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
            }
            
            if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                app.ideas = data.ideas;
                app.projects = data.projects;
                app.logs = data.logs;
                app.improvements = data.improvements || [];
                
                saveData();
                renderDashboard();
                
                UI.showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
            }
        } catch (error) {
            alert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®çŠ¶æ…‹
const calendarState = {
    currentYear: new Date().getFullYear(),
    currentMonth: new Date().getMonth(),
    selectedDate: null
};

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æç”»
function renderCalendar() {
    const year = calendarState.currentYear;
    const month = calendarState.currentMonth;
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°
    document.getElementById('calendarTitle').textContent = `${year}å¹´${month + 1}æœˆ`;
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã®ç”Ÿæˆ
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    
    // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
    const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    weekdays.forEach(day => {
        const weekdayDiv = document.createElement('div');
        weekdayDiv.className = 'calendar-weekday';
        weekdayDiv.textContent = day;
        grid.appendChild(weekdayDiv);
    });
    
    // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’å–å¾—
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const prevLastDay = new Date(year, month, 0);
    
    // å‰æœˆã®æ—¥ä»˜ã‚’åŸ‹ã‚ã‚‹
    const firstDayOfWeek = firstDay.getDay();
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = prevLastDay.getDate() - i;
        const dayDiv = createCalendarDay(year, month - 1, day, true);
        grid.appendChild(dayDiv);
    }
    
    // å½“æœˆã®æ—¥ä»˜
    const today = new Date();
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayDiv = createCalendarDay(year, month, day, false);
        
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
            dayDiv.classList.add('today');
        }
        
        grid.appendChild(dayDiv);
    }
    
    // æ¬¡æœˆã®æ—¥ä»˜ã‚’åŸ‹ã‚ã‚‹
    const remainingDays = 42 - (firstDayOfWeek + lastDay.getDate());
    for (let day = 1; day <= remainingDays; day++) {
        const dayDiv = createCalendarDay(year, month + 1, day, true);
        grid.appendChild(dayDiv);
    }
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜è¦ç´ ã‚’ä½œæˆ
function createCalendarDay(year, month, day, isOtherMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    if (isOtherMonth) {
        dayDiv.classList.add('other-month');
    }
    
    const date = new Date(year, month, day);
    const dateStr = formatDateForKey(date);
    
    // ãã®æ—¥ã®æ´»å‹•ã‚’ãƒã‚§ãƒƒã‚¯
    const dayLogs = app.logs.filter(log => {
        const logDate = new Date(log.date);
        return formatDateForKey(logDate) === dateStr;
    });
    
    const dayImprovements = app.improvements.filter(imp => {
        const impDate = new Date(imp.createdAt || imp.date);
        return formatDateForKey(impDate) === dateStr;
    });
    
    if (dayLogs.length > 0 || dayImprovements.length > 0) {
        dayDiv.classList.add('has-activity');
    }
    
    // æ—¥ä»˜ç•ªå·
    const numberDiv = document.createElement('div');
    numberDiv.className = 'calendar-day-number';
    numberDiv.textContent = day;
    dayDiv.appendChild(numberDiv);
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    if (dayLogs.length > 0 || dayImprovements.length > 0) {
        const indicatorDiv = document.createElement('div');
        indicatorDiv.className = 'calendar-day-indicator';
        
        // æœ€å¤§3ã¤ã®ãƒ‰ãƒƒãƒˆã‚’è¡¨ç¤º
        const dotCount = Math.min(3, dayLogs.length + dayImprovements.length);
        for (let i = 0; i < dotCount; i++) {
            const dot = document.createElement('div');
            dot.className = 'activity-dot';
            indicatorDiv.appendChild(dot);
        }
        
        dayDiv.appendChild(indicatorDiv);
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    dayDiv.onclick = () => selectCalendarDate(date);
    
    return dayDiv;
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’é¸æŠ
function selectCalendarDate(date) {
    // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
    document.querySelectorAll('.calendar-day.selected').forEach(day => {
        day.classList.remove('selected');
    });
    
    // æ–°ã—ã„é¸æŠã‚’è¿½åŠ 
    event.currentTarget.classList.add('selected');
    calendarState.selectedDate = date;
    
    // è©³ç´°ã‚’è¡¨ç¤º
    showDayDetail(date);
}

// æ—¥ä»˜ã®è©³ç´°ã‚’è¡¨ç¤º
function showDayDetail(date) {
    const detailDiv = document.getElementById('dayDetail');
    const dateStr = formatDateForKey(date);
    
    // ãã®æ—¥ã®ãƒ­ã‚°ã‚’å–å¾—
    const dayLogs = app.logs.filter(log => {
        const logDate = new Date(log.date);
        return formatDateForKey(logDate) === dateStr;
    });
    
    // ãã®æ—¥ã®æ”¹å–„ç‚¹ã‚’å–å¾—
    const dayImprovements = app.improvements.filter(imp => {
        const impDate = new Date(imp.createdAt || imp.date);
        return formatDateForKey(impDate) === dateStr;
    });
    
    let html = `
        <div class="day-detail">
            <div class="day-detail-header">
                <div class="day-detail-date">${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥</div>
                <button class="btn btn-secondary" onclick="closeDayDetail()">é–‰ã˜ã‚‹</button>
            </div>
    `;
    
    // ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    if (dayLogs.length > 0) {
        html += `
            <div class="day-detail-section">
                <div class="day-detail-section-title">
                    <span>ğŸ“</span>
                    <span>æ´»å‹•è¨˜éŒ² (${dayLogs.length}ä»¶)</span>
                </div>
        `;
        
        dayLogs.forEach(log => {
            const project = app.projects.find(p => p.id === log.projectId);
            if (project) {
                html += `
                    <div class="day-detail-item">
                        <div class="day-detail-project">${project.name}</div>
                `;
                
                if (log.checkpoints) {
                    const checkedCount = Object.values(log.checkpoints).filter(c => c).length;
                    html += `<div>ãƒã‚§ãƒƒã‚¯é …ç›®: ${checkedCount}/${Object.keys(log.checkpoints).length} å®Œäº†</div>`;
                }
                
                if (log.type === 'count') {
                    html += `<div>ã‚«ã‚¦ãƒ³ãƒˆ: +${log.value}</div>`;
                }
                
                if (log.type === 'milestone') {
                    html += `<div>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³: ${log.achieved ? 'é”æˆ' : 'æœªé”æˆ'}</div>`;
                }
                
                html += `</div>`;
            }
        });
        
        html += `</div>`;
    }
    
    // æ”¹å–„ç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    if (dayImprovements.length > 0) {
        html += `
            <div class="day-detail-section">
                <div class="day-detail-section-title">
                    <span>ğŸ’¡</span>
                    <span>æ”¹å–„ç‚¹ãƒ»é©å¿œ (${dayImprovements.length}ä»¶)</span>
                </div>
        `;
        
        dayImprovements.forEach(imp => {
            const project = app.projects.find(p => p.id === imp.projectId);
            html += `
                <div class="day-detail-item">
                    ${project ? `<div class="day-detail-project">${project.name}</div>` : ''}
                    <div>${imp.content}</div>
                </div>
            `;
        });
        
        html += `</div>`;
    }
    
    // AIã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const dailyComments = JSON.parse(localStorage.getItem('pdca_daily_comments') || '[]');
    const dayComment = dailyComments.find(comment => {
        const commentDate = new Date(comment.date);
        return formatDateForKey(commentDate) === dateStr;
    });
    
    if (dayComment) {
        html += `
            <div class="day-detail-section">
                <div class="day-detail-section-title">
                    <span>ğŸ¤–</span>
                    <span>AIã‚³ãƒ¡ãƒ³ãƒˆ</span>
                </div>
                <div class="day-detail-item">
                    ${dayComment.content}
                </div>
            </div>
        `;
    }
    
    if (dayLogs.length === 0 && dayImprovements.length === 0 && !dayComment) {
        html += `
            <div style="text-align: center; color: var(--gray); padding: 2rem;">
                ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“
            </div>
        `;
    }
    
    html += `</div>`;
    
    detailDiv.innerHTML = html;
    detailDiv.style.display = 'block';
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
    detailDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// æ—¥ä»˜è©³ç´°ã‚’é–‰ã˜ã‚‹
function closeDayDetail() {
    document.getElementById('dayDetail').style.display = 'none';
    document.querySelectorAll('.calendar-day.selected').forEach(day => {
        day.classList.remove('selected');
    });
}

// æœˆã‚’å¤‰æ›´
function changeMonth(delta) {
    calendarState.currentMonth += delta;
    
    if (calendarState.currentMonth < 0) {
        calendarState.currentMonth = 11;
        calendarState.currentYear--;
    } else if (calendarState.currentMonth > 11) {
        calendarState.currentMonth = 0;
        calendarState.currentYear++;
    }
    
    renderCalendar();
}

// ä»Šæ—¥ã«ç§»å‹•
function goToToday() {
    const today = new Date();
    calendarState.currentYear = today.getFullYear();
    calendarState.currentMonth = today.getMonth();
    renderCalendar();
}

// AIæ©Ÿèƒ½ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼é–¢æ•°
function renderWeeklyReport() {
    // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®æç”»ãƒ­ã‚¸ãƒƒã‚¯
    console.log('renderWeeklyReport called');
}

function renderDailyComment() {
    // ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®æç”»ãƒ­ã‚¸ãƒƒã‚¯
    console.log('renderDailyComment called');
}

function renderMonthlyInsight() {
    // æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®æç”»ãƒ­ã‚¸ãƒƒã‚¯
    console.log('renderMonthlyInsight called');
}

function renderQuarterlyInsight() {
    // 3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆã®æç”»ãƒ­ã‚¸ãƒƒã‚¯
    console.log('renderQuarterlyInsight called');
}

function generateWeeklyReport() {
    // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    console.log('generateWeeklyReport called');
}

function generateDailyComment() {
    // ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    console.log('generateDailyComment called');
}

function generateMonthlyInsight() {
    // æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    console.log('generateMonthlyInsight called');
}

function generateQuarterlyInsight() {
    // 3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    console.log('generateQuarterlyInsight called');
}

// PWAé–¢é€£ã®é–¢æ•°
function installPWA() {
    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯
    console.log('installPWA called');
}

function dismissInstallPrompt() {
    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå´ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯
    document.getElementById('installPrompt').classList.remove('show');
}
