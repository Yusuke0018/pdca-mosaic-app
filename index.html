<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDCA Mosaic - ã‚ãªãŸã®äººç”Ÿã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã™ã‚‹</title>

    <!-- â–¼â–¼â–¼ ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ã¨PWAè¨­å®š â–¼â–¼â–¼ -->
    <meta name="application-name" content="PDCA Mosaic">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PDCA Mosaic">
    <meta name="theme-color" content="#6366f1">

    <!-- ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾© (SVGã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿) -->
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3cdefs%3e%3clinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3e%3cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3e%3cstop offset='100%25' style='stop-color:%23f59e0b;stop-opacity:1' /%3e%3c/linearGradient%3e%3cfilter id='shadow' x='-20%25' y='-20%25' width='140%25' height='140%25'%3e%3cfeGaussianBlur in='SourceAlpha' stdDeviation='2'/%3e%3cfeOffset dx='2' dy='2' result='offsetblur'/%3e%3cfeComponentTransfer%3e%3cfeFuncA type='linear' slope='0.5'/%3e%3c/feComponentTransfer%3e%3cfeMerge%3e%3cfeMergeNode/%3e%3cfeMergeNode in='SourceGraphic'/%3e%3c/feMerge%3e%3c/filter%3e%3c/defs%3e%3crect width='100' height='100' rx='20' fill='url(%23grad)' /%3e%3ctext x='50' y='68' font-family='sans-serif' font-size='60' font-weight='bold' fill='white' text-anchor='middle' filter='url(%23shadow)'%3eâ—ˆ%3c/text%3e%3c/svg%3e">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3cdefs%3e%3clinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3e%3cstop offset='0%25' style='stop-color:%236366f1;stop-opacity:1' /%3e%3cstop offset='100%25' style='stop-color:%23f59e0b;stop-opacity:1' /%3e%3c/linearGradient%3e%3cfilter id='shadow' x='-20%25' y='-20%25' width='140%25' height='140%25'%3e%3cfeGaussianBlur in='SourceAlpha' stdDeviation='2'/%3e%3cfeOffset dx='2' dy='2' result='offsetblur'/%3e%3cfeComponentTransfer%3e%3cfeFuncA type='linear' slope='0.5'/%3e%3c/feComponentTransfer%3e%3cfeMerge%3e%3cfeMergeNode/%3e%3cfeMergeNode in='SourceGraphic'/%3e%3c/feMerge%3e%3c/filter%3e%3c/defs%3e%3crect width='100' height='100' rx='20' fill='url(%23grad)' /%3e%3ctext x='50' y='68' font-family='sans-serif' font-size='60' font-weight='bold' fill='white' text-anchor='middle' filter='url(%23shadow)'%3eâ—ˆ%3c/text%3e%3c/svg%3e">

    <!-- Web App Manifest (JSONã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿) -->
   <link rel="manifest" href="manifest.json">
    <!-- â–²â–²â–² ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ã¨PWAè¨­å®š â–²â–²â–² -->

 <link rel="stylesheet" href="css/main.css"> 
</head>
<body>
    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <!-- PWA Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <div class="install-prompt-text">
            ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ï¼
        </div>
        <div class="install-prompt-buttons">
            <button class="install-prompt-button install-prompt-button-primary" onclick="installPWA()">
                ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            </button>
            <button class="install-prompt-button install-prompt-button-secondary" onclick="dismissInstallPrompt()">
                å¾Œã§
            </button>
        </div>
    </div>

    <!-- Daily Reminder Banner -->
    <div id="reminderBanner" class="reminder-banner" onclick="showDailyLog()">
        <div class="reminder-text">ğŸ”” ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ï¼</div>
        <div class="reminder-subtext">ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã‚’é–‹å§‹</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">â—ˆ</div>
                <span>PDCA Mosaic</span>
            </div>
            <button class="nav-item" onclick="showSettings()">
                <span class="nav-icon">âš™ï¸</span>
            </button>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
        <div class="nav-primary">
            <button class="nav-tab active" onclick="showSection('dashboard')">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </button>
            <button class="nav-tab" onclick="showSection('play')">
                <span class="nav-icon">ğŸ’¡</span>
                <span class="nav-text">ã‚¢ã‚¤ãƒ‡ã‚¢</span>
            </button>
            <button class="nav-tab" onclick="showSection('daily')">
                <span class="nav-icon">ğŸ’¬</span>
                <span class="nav-text">ãƒ‡ã‚¤ãƒªãƒ¼</span>
            </button>
            <button class="nav-tab" onclick="showSection('calendar')">
                <span class="nav-icon">ğŸ“…</span>
                <span class="nav-text">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
            </button>
        </div>
        <div class="nav-secondary">
            <button class="nav-menu-btn" onclick="toggleNavMenu()">
                <span class="menu-icon">â‹¯</span>
            </button>
            <div class="nav-dropdown">
                <button class="dropdown-item" onclick="showSection('weekly')">
                    <span class="dropdown-icon">ğŸ“ˆ</span>é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
                </button>
                <button class="dropdown-item" onclick="showSection('monthly')">
                    <span class="dropdown-icon">ğŸ“Š</span>æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
                </button>
                <button class="dropdown-item" onclick="showSection('quarterly')">
                    <span class="dropdown-icon">ğŸ¯</span>3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆ
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="showSection('completed')">
                    <span class="dropdown-icon">âœ…</span>å®Œäº†æ¸ˆã¿
                </button>
                <button class="dropdown-item" onclick="showSection('trash')">
                    <span class="dropdown-icon">ğŸ—‘ï¸</span>ã‚´ãƒŸç®±
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <!-- Search and Filter -->
            <div class="search-container">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œç´¢..."
                       onkeyup="filterProjects()">
                <div class="filter-tags">
                    <button class="filter-tag active" onclick="setFilter('all')">ã™ã¹ã¦</button>
                    <button class="filter-tag" onclick="setFilter('Design')">Design</button>
                    <button class="filter-tag" onclick="setFilter('Check')">Check</button>
                    <button class="filter-tag" onclick="setFilter('Adapt')">Adapt</button>
                </div>
            </div>

            <div class="project-grid" id="projectGrid">
                <!-- Projects will be dynamically loaded here -->
            </div>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“‹</div>
                <div class="empty-text">ã¾ã ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
                <button class="btn btn-primary" onclick="showSection('play')">ã‚¢ã‚¤ãƒ‡ã‚¢ä¸€è¦§ã¸</button>
            </div>
        </section>

        <!-- Play (Ideas) Section -->
        <section id="play" class="section">
            <h2 style="margin-bottom: 1rem;">ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ»ã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹</h2>
            <div id="inboxList">
                <!-- Ideas will be listed here -->
            </div>
            <div class="empty-state" id="inboxEmpty" style="display: none;">
                <div class="empty-icon">ğŸ’¡</div>
                <div class="empty-text">æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†</div>
            </div>
        </section>

        <!-- Completed Projects Section -->
        <section id="completed" class="section">
            <h2 style="margin-bottom: 1rem;">å®Œäº†ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h2>
            <div class="project-grid" id="completedGrid">
                <!-- Completed projects will be listed here -->
            </div>
            <div class="empty-state" id="completedEmpty" style="display: none;">
                <div class="empty-icon">âœ…</div>
                <div class="empty-text">ã¾ã å®Œäº†ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </section>

        <!-- Trash Section -->
        <section id="trash" class="section">
            <h2 style="margin-bottom: 1rem;">ã‚´ãƒŸç®±</h2>
            <div class="project-grid" id="trashGrid">
                <!-- Deleted projects will be listed here -->
            </div>
            <div class="empty-state" id="trashEmpty" style="display: none;">
                <div class="empty-icon">ğŸ—‘ï¸</div>
                <div class="empty-text">ã‚´ãƒŸç®±ã¯ç©ºã§ã™</div>
            </div>
            <button class="btn btn-danger" onclick="emptyTrash()" style="margin-top: 1rem;">
                ã‚´ãƒŸç®±ã‚’ç©ºã«ã™ã‚‹
            </button>
        </section>

        <!-- Weekly Report Section -->
        <section id="weekly" class="section">
            <h2 style="margin-bottom: 1rem;">é€±æ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h2>
            <div id="weeklyReport">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“Š</div>
                    <div class="empty-text">ãƒ¬ãƒãƒ¼ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                    <button class="btn btn-primary" onclick="generateWeeklyReport()">ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ</button>
                </div>
            </div>
        </section>

        <!-- Daily Comment Section -->
        <section id="daily" class="section">
            <h2 style="margin-bottom: 1rem;">ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
            <div id="dailyComment">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ’¬</div>
                    <div class="empty-text">ä»Šæ—¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                    <button class="btn btn-primary" onclick="generateDailyComment()">ä»Šæ—¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ</button>
                </div>
            </div>
        </section>

        <!-- Monthly Insights Section -->
        <section id="monthly" class="section">
            <h2 style="margin-bottom: 1rem;">æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h2>
            <div id="monthlyInsight">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“ˆ</div>
                    <div class="empty-text">ä»Šæœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                    <button class="btn btn-primary" onclick="generateMonthlyInsight()">ä»Šæœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ</button>
                </div>
            </div>
        </section>

        <!-- Quarterly Insights Section -->
        <section id="quarterly" class="section">
            <h2 style="margin-bottom: 1rem;">3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h2>
            <div id="quarterlyInsight">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ¯</div>
                    <div class="empty-text">3ãƒ¶æœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                    <button class="btn btn-primary" onclick="generateQuarterlyInsight()">3ãƒ¶æœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ</button>
                </div>
            </div>
        </section>

        <!-- Calendar Section -->
        <section id="calendar" class="section">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">â—€</button>
                    <div class="calendar-title" id="calendarTitle">2024å¹´1æœˆ</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">â–¶</button>
                        <button class="calendar-nav-btn" onclick="goToToday()">ä»Šæ—¥</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>
            <div id="dayDetail" style="display: none;">
                <!-- Day detail will be shown here -->
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showAddModal()">+</button>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-content">
            <button class="nav-item active" onclick="showSection('dashboard')">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">ãƒ›ãƒ¼ãƒ </span>
            </button>
            <button class="nav-item" onclick="showSection('play')">
                <span class="nav-icon">ğŸ’¡</span>
                <span class="nav-label">ã‚¢ã‚¤ãƒ‡ã‚¢</span>
            </button>
            <button class="nav-item" onclick="showDailyLog()">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-label">è¨˜éŒ²</span>
            </button>
            <button class="nav-item" onclick="showSection('calendar')">
                <span class="nav-icon">ğŸ“…</span>
                <span class="nav-label">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
            </button>
        </div>
    </nav>

    <!-- Add Idea Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ã©ã‚“ãªã‚¢ã‚¤ãƒ‡ã‚¢ï¼Ÿ</label>
                    <textarea class="form-control" id="ideaContent" placeholder="ä¾‹: ãƒãƒ¼ãƒ”ãƒ¼ã‚’æ¯æ—¥ã‚„ã£ã¦ã¿ã‚‹"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="UI.closeModal('addModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="addIdea()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- Project Design Modal -->
    <div class="modal" id="designModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆ</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                    <input type="text" class="form-control" id="projectName" placeholder="ä¾‹: ãƒãƒ¼ãƒ”ãƒ¼ç¿’æ…£åŒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ã‚´ãƒ¼ãƒ«ï¼ˆä½•ã‚’é”æˆã—ãŸã„ï¼Ÿï¼‰</label>
                    <textarea class="form-control" id="projectGoal" placeholder="ä¾‹: 3ãƒ¶æœˆå¾Œã«ã€æ¯æ—¥20å›ã®ãƒãƒ¼ãƒ”ãƒ¼ã‚’æ¯åˆ‡ã‚Œã›ãšã«ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœŸé–“</label>
                    <select class="form-control" id="projectDuration">
                        <option value="7">1é€±é–“</option>
                        <option value="14">2é€±é–“</option>
                        <option value="30" selected>30æ—¥é–“</option>
                        <option value="60">60æ—¥é–“</option>
                        <option value="90">90æ—¥é–“</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é€²æ—ç®¡ç†æ–¹æ³•</label>
                    <select class="form-control" id="trackingType" onchange="updateTrackingUI()">
                        <option value="daily">æ¯æ—¥ãƒã‚§ãƒƒã‚¯</option>
                        <option value="count">å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ</option>
                        <option value="milestone">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆ</option>
                    </select>
                </div>
                
                <div class="form-group" id="dailyCheckGroup">
                    <label class="form-label">æ¯æ—¥ãƒã‚§ãƒƒã‚¯ã™ã‚‹é …ç›®</label>
                    <div id="checkpoints">
                        <input type="text" class="form-control" style="margin-bottom: 0.5rem;" placeholder="ä¾‹: ãƒãƒ¼ãƒ”ãƒ¼ã‚’10å›å®Ÿæ–½">
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="addCheckpoint()">+ é …ç›®ã‚’è¿½åŠ </button>
                </div>
                
                <div class="form-group" id="countGroup" style="display: none;">
                    <label class="form-label">ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹é …ç›®</label>
                    <div id="countItems">
                        <input type="text" class="form-control" style="margin-bottom: 0.5rem;" placeholder="ä¾‹: ãƒãƒ¼ãƒ”ãƒ¼ã®å›æ•°">
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="addCountItem()">+ é …ç›®ã‚’è¿½åŠ </button>
                </div>
                
                <div class="form-group" id="milestoneGroup" style="display: none;">
                    <label class="form-label">é”æˆã—ãŸã„ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</label>
                    <div id="milestones">
                        <input type="text" class="form-control" style="margin-bottom: 0.5rem;" placeholder="ä¾‹: 10å›é€£ç¶šã§ãƒãƒ¼ãƒ”ãƒ¼ãŒã§ãã‚‹">
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="addMilestone()">+ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’è¿½åŠ </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('designModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="createProject()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹</button>
            </div>
        </div>
    </div>

    <!-- Daily Log Modal -->
    <div class="modal" id="logModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ä»Šæ—¥ã®è¨˜éŒ²</h3>
            </div>
            <div class="modal-body" id="logModalBody">
                <!-- Daily logs will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('logModal')">é–‰ã˜ã‚‹</button>
                <button class="btn btn-primary" onclick="saveDailyLog()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°</h3>
            </div>
            <div class="modal-body" id="projectModalBody">
                <!-- Project details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">è¨­å®š</h3>
            </div>
            <div class="modal-body">
                <div class="settings-item" onclick="showAPIKeyModal()">
                    <div class="settings-label">OpenAI APIã‚­ãƒ¼</div>
                    <div class="settings-description">AIåˆ†ææ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™</div>
                </div>
                
                <div class="settings-item" onclick="exportData()">
                    <div class="settings-label">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                    <div class="settings-description">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜</div>
                </div>
                
                <div class="settings-item" onclick="importData()">
                    <div class="settings-label">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
                    <div class="settings-description">ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</div>
                </div>
                
                <div class="settings-item" onclick="toggleNotifications()">
                    <div class="settings-label">é€šçŸ¥è¨­å®š</div>
                    <div class="settings-description" id="notificationStatus">é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹</div>
                </div>
                
                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">OpenAI APIã‚­ãƒ¼è¨­å®š</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">APIã‚­ãƒ¼</label>
                    <input type="password" class="form-control" id="apiKey" placeholder="sk-...">
                    <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                        APIã‚­ãƒ¼ã¯æš—å·åŒ–ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('apiKeyModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveAPIKey()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Improvement Memo Modal -->
    <div class="modal" id="improvementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ”¹å–„ç‚¹ãƒ¡ãƒ¢</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">æ–°ã—ã„æ”¹å–„ç‚¹</label>
                    <textarea class="form-control" id="newImprovement" rows="3" placeholder="å®Ÿæ–½ã—ãŸæ”¹å–„ã‚„ä»Šå¾Œã®æ”¹å–„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="addImprovementMemo()">è¿½åŠ </button>
                </div>
                <div id="improvementsList" style="margin-top: 2rem;">
                    <!-- æ”¹å–„ç‚¹ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('improvementModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Service Worker Registration Script -->
   <script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => console.log('SW registered:', registration))
            .catch(error => console.log('SW registration failed:', error));
    });
}
</script>
    <!-- Original Application Script -->
    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        const app = {
            ideas: [],
            projects: [],
            logs: [],
            improvements: [],
            currentSection: 'dashboard',
            currentProjectId: null,
            apiKey: null,
            searchQuery: '',
            filterPhase: 'all'
        };

        function saveData() {
            DataManager.saveData(app);
        }

        function loadData() {
            const loadedData = DataManager.loadData();
            if (loadedData) {
                app.ideas = loadedData.ideas;
                app.projects = loadedData.projects;
                app.logs = loadedData.logs;
                app.improvements = loadedData.improvements;
                app.apiKey = loadedData.apiKey;
            }
        }

        

        // åˆæœŸåŒ–
      document.addEventListener('DOMContentLoaded', function() {
    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    loadData();
    
    renderDashboard();
    goToToday();
    setupEventListeners();
    checkDailyReminder();
    requestNotificationPermission();
    // è¤‡æ•°ã‚¿ãƒ–åŒæœŸ
    window.addEventListener('storage', handleStorageChange);
});

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleNavMenu() {
            const dropdown = document.querySelector('.nav-dropdown');
            dropdown.classList.toggle('active');
            
            // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            if (dropdown.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeNavMenu);
                }, 100);
            }
        }
        
        function closeNavMenu(e) {
            const dropdown = document.querySelector('.nav-dropdown');
            const menuBtn = document.querySelector('.nav-menu-btn');
            
            if (!dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
                dropdown.classList.remove('active');
                document.removeEventListener('click', closeNavMenu);
            }
        }
        
        // ã‚¹ãƒ¯ã‚¤ãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
        function setupSwipeNavigation() {
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            const mainContent = document.querySelector('.main-content');
            const sections = ['dashboard', 'play', 'calendar', 'daily', 'weekly', 'monthly', 'quarterly', 'completed', 'trash'];
            
            // ã‚¿ãƒƒãƒé–‹å§‹
            mainContent.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });
            
            // ã‚¿ãƒƒãƒçµ‚äº†
            mainContent.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                const swipeDistanceX = touchEndX - touchStartX;
                const swipeDistanceY = Math.abs(touchEndY - touchStartY);
                
                // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å ´åˆã¯ç„¡è¦–ï¼ˆæ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã‚ˆã‚Šç¸¦ã®ç§»å‹•ãŒå¤§ãã„å ´åˆï¼‰
                if (swipeDistanceY > Math.abs(swipeDistanceX)) {
                    return;
                }
                
                // æœ€å°ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ï¼ˆ50pxï¼‰
                if (Math.abs(swipeDistanceX) < 50) {
                    return;
                }
                
                const currentIndex = sections.indexOf(app.currentSection);
                let newIndex = currentIndex;
                
                if (swipeDistanceX > 0) {
                    // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ï¼‰
                    if (currentIndex > 0) {
                        newIndex = currentIndex - 1;
                    } else {
                        // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‹ã‚‰æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¸ãƒ«ãƒ¼ãƒ—
                        newIndex = sections.length - 1;
                    }
                } else if (swipeDistanceX < 0) {
                    // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ï¼‰
                    if (currentIndex < sections.length - 1) {
                        newIndex = currentIndex + 1;
                    } else {
                        // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã‹ã‚‰æœ€åˆã®ãƒšãƒ¼ã‚¸ã¸ãƒ«ãƒ¼ãƒ—
                        newIndex = 0;
                    }
                }
                
                if (newIndex !== currentIndex) {
                    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    const newSection = sections[newIndex];
                    
                    // å¯¾å¿œã™ã‚‹ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’è¦‹ã¤ã‘ã¦ã‚¯ãƒªãƒƒã‚¯
                    const tabButton = document.querySelector(`.nav-tab[onclick="showSection('${newSection}')"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                    
                    // ã‚¹ãƒ¯ã‚¤ãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆç”»é¢ã®ç«¯ã«å°ã•ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    const indicator = document.createElement('div');
                    indicator.style.cssText = `
                        position: fixed;
                        top: 50%;
                        ${swipeDistanceX > 0 ? 'left: 10px;' : 'right: 10px;'}
                        transform: translateY(-50%);
                        width: 40px;
                        height: 40px;
                        background: var(--primary);
                        border-radius: 50%;
                        opacity: 0.3;
                        pointer-events: none;
                        animation: swipeIndicator 0.3s ease-out;
                    `;
                    document.body.appendChild(indicator);
                    
                    setTimeout(() => {
                        indicator.remove();
                    }, 300);
                }
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã®è¿½åŠ 
            setupSwipeNavigation();
        }

        // è¤‡æ•°ã‚¿ãƒ–åŒæœŸå‡¦ç†
        function handleStorageChange(e) {
            if (e.key && e.key.startsWith('pdca_')) {
                const loadedData = DataManager.loadData();
                if (loadedData) {
                    app.ideas = loadedData.ideas;
                    app.projects = loadedData.projects;
                    app.logs = loadedData.logs;
                    app.improvements = loadedData.improvements;
                    app.apiKey = loadedData.apiKey;
                }
                renderCurrentSection();
                UI.showToast('ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
            }
        }

        // ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†æç”»
        function renderCurrentSection() {
            if (app.currentSection === 'dashboard') {
                renderDashboard();
            } else if (app.currentSection === 'play') {
                renderIdeas();
            } else if (app.currentSection === 'completed') {
                renderCompletedProjects();
            } else if (app.currentSection === 'trash') {
                renderTrashProjects();
            } else if (app.currentSection === 'weekly') {
                renderWeeklyReport();
            } else if (app.currentSection === 'daily') {
                renderDailyComment();
            } else if (app.currentSection === 'monthly') {
                renderMonthlyInsight();
            } else if (app.currentSection === 'quarterly') {
                renderQuarterlyInsight();
            }
        }

       
        // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
        function filterProjects() {
            app.searchQuery = document.getElementById('searchInput').value.toLowerCase();
            renderDashboard();
        }

        function setFilter(phase) {
            app.filterPhase = phase;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ã‚°ã®æ›´æ–°
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderDashboard();
        }

        

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æç”»
        function renderDashboard() {
            const grid = document.getElementById('projectGrid');
            const emptyState = document.getElementById('emptyState');
            
            let activeProjects = app.projects.filter(p => !p.completed && !p.deleted);
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (app.searchQuery) {
                activeProjects = activeProjects.filter(p => 
                    p.name.toLowerCase().includes(app.searchQuery) ||
                    p.goal.toLowerCase().includes(app.searchQuery)
                );
            }
            
            // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (app.filterPhase !== 'all') {
                activeProjects = activeProjects.filter(p => p.phase === app.filterPhase);
            }
            
            if (activeProjects.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            grid.innerHTML = activeProjects.map(project => {
                const progress = calculateProjectProgress(project);
                const phaseColors = {
                    'Play': '#6366f1',
                    'Design': '#f59e0b',
                    'Check': '#10b981',
                    'Adapt': '#ef4444'
                };
                
                // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®é”æˆç‡ã‚’è¨ˆç®—
                const checkpointStats = calculateCheckpointStats(project);
                
                return `
                    <div class="project-card" onclick="showProjectDetail('${project.id}')">
                        <div class="trash-icon" onclick="moveToTrash(event, '${project.id}')">ğŸ—‘ï¸</div>
                        <div class="project-header">
                            <div>
                                <div class="project-title">${project.name}</div>
                                <div style="font-size: 0.875rem; color: var(--gray);">${project.duration}æ—¥é–“</div>
                            </div>
                            <div class="project-phase" style="background: ${phaseColors[project.phase] || phaseColors.Play}">
                                ${project.phase}
                            </div>
                        </div>
                        
                        <div class="project-stats">
                            <div class="stat-item">
                                <div class="stat-value">${progress}%</div>
                                <div class="stat-label">ç·åˆé€²æ—</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${getProjectDaysLeft(project)}</div>
                                <div class="stat-label">æ®‹ã‚Šæ—¥æ•°</div>
                            </div>
                        </div>
                        
                        ${project.trackingType === 'daily' && checkpointStats.length > 0 ? `
                            <div class="checkpoint-progress">
                                ${checkpointStats.map(stat => `
                                    <div class="checkpoint-item">
                                        <span class="checkpoint-name">${stat.name}</span>
                                        <span class="checkpoint-rate">${stat.rate}%</span>
                                        <div class="mini-progress">
                                            <div class="mini-progress-fill" style="width: ${stat.rate}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${project.trackingType === 'count' ? renderCounterSection(project) : ''}
                        
                        ${project.trackingType === 'milestone' ? renderMilestoneProgress(project) : ''}
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        
                        ${renderPhaseActions(project)}
                    </div>
                `;
            }).join('');
        }

        // ã‚´ãƒŸç®±ã¸ç§»å‹•
        function moveToTrash(event, projectId) {
            event.stopPropagation();
            
            const project = app.projects.find(p => p.id === projectId);
            if (project) {
                project.deleted = true;
                project.deletedAt = new Date().toISOString();
                DataManager.saveData(app);
                renderDashboard();
                showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ã‚´ãƒŸç®±ã‹ã‚‰å¾©å…ƒ
        function restoreFromTrash(event, projectId) {
            event.stopPropagation();
            
            const project = app.projects.find(p => p.id === projectId);
            if (project) {
                delete project.deleted;
                delete project.deletedAt;
                saveData();
                renderTrashProjects();
                showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
            }
        }

        // ã‚´ãƒŸç®±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»
        function renderTrashProjects() {
            const grid = document.getElementById('trashGrid');
            const emptyState = document.getElementById('trashEmpty');
            
            const deletedProjects = app.projects.filter(p => p.deleted);
            
            if (deletedProjects.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            grid.innerHTML = deletedProjects.map(project => {
                const deletedDate = new Date(project.deletedAt);
                
                return `
                    <div class="project-card" style="opacity: 0.7;">
                        <div class="project-header">
                            <div>
                                <div class="project-title">${project.name}</div>
                                <div style="font-size: 0.875rem; color: var(--gray);">
                                    å‰Šé™¤æ—¥: ${formatDate(deletedDate)}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                                    onclick="restoreFromTrash(event, '${project.id}')">
                                å¾©å…ƒã™ã‚‹
                            </button>
                            <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                                    onclick="permanentlyDelete(event, '${project.id}')">
                                å®Œå…¨ã«å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å®Œå…¨å‰Šé™¤
        function permanentlyDelete(event, projectId) {
            event.stopPropagation();
            
            if (confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                app.projects = app.projects.filter(p => p.id !== projectId);
                app.logs = app.logs.filter(log => log.projectId !== projectId);
                saveData();
                renderTrashProjects();
                showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ã‚´ãƒŸç®±ã‚’ç©ºã«ã™ã‚‹
        function emptyTrash() {
            if (confirm('ã‚´ãƒŸç®±å†…ã®ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                const deletedProjectIds = app.projects
                    .filter(p => p.deleted)
                    .map(p => p.id);
                
                app.projects = app.projects.filter(p => !p.deleted);
                app.logs = app.logs.filter(log => !deletedProjectIds.includes(log.projectId));
                
                saveData();
                renderTrashProjects();
                showToast('ã‚´ãƒŸç®±ã‚’ç©ºã«ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»
        function renderCounterSection(project) {
            if (!project.countItems) return '';
            
            return `
                <div class="counter-section">
                    ${project.countItems.map((item, index) => {
                        const count = getProjectCountForItem(project.id, index);
                        return `
                            <div class="counter-item">
                                <span class="counter-label">${item}</span>
                                <div class="counter-controls">
                                    <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, -1)">âˆ’</button>
                                    <span class="counter-value" onclick="editCount(event, '${project.id}', ${index})" id="count_${project.id}_${index}">${count}</span>
                                    <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, 1)">+</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€²æ—ã®æç”»
        function renderMilestoneProgress(project) {
            if (!project.milestones) return '';
            
            const achievedCount = getMilestoneAchievedCount(project);
            return `
                <div style="margin-top: 1rem;">
                    <div style="font-size: 0.875rem; color: var(--gray);">
                        é”æˆæ¸ˆã¿: ${achievedCount} / ${project.milestones.length}
                    </div>
                </div>
            `;
        }

        // å®Œäº†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æç”»
        function renderCompletedProjects() {
            const grid = document.getElementById('completedGrid');
            const emptyState = document.getElementById('completedEmpty');
            
            const completedProjects = app.projects.filter(p => p.completed && !p.deleted);
            
            if (completedProjects.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            grid.innerHTML = completedProjects.map(project => {
                const completedDate = project.completedAt ? new Date(project.completedAt) : null;
                
                return `
                    <div class="project-card completed" onclick="showProjectDetail('${project.id}')">
                        <div class="project-header">
                            <div>
                                <div class="project-title">
                                    ${project.name}
                                    <span class="completed-badge">å®Œäº†</span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--gray);">
                                    ${completedDate ? `å®Œäº†æ—¥: ${formatDate(completedDate)}` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="project-stats">
                            <div class="stat-item">
                                <div class="stat-value">${project.duration}</div>
                                <div class="stat-label">å®Ÿæ–½æ—¥æ•°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${project.cycleCount || 1}</div>
                                <div class="stat-label">ã‚µã‚¤ã‚¯ãƒ«æ•°</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                                    onclick="reactivateProject(event, '${project.id}')">
                                å†é–‹ã™ã‚‹
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function renderPhaseActions(project) {
            const actions = {
                'Play': [
                    { icon: 'ğŸ’¡', text: 'ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…·ä½“åŒ–', action: 'moveToDesign' }
                ],
                'Design': [
                    { icon: 'â–¶ï¸', text: 'å®Ÿè¡Œé–‹å§‹', action: 'moveToCheck' },
                    { icon: 'â—€ï¸', text: 'ã‚¢ã‚¤ãƒ‡ã‚¢ã«æˆ»ã™', action: 'moveToPlay' }
                ],
                'Check': [
                    { icon: 'ğŸ“', text: 'ä»Šæ—¥ã®è¨˜éŒ²', action: 'showDailyLog' },
                    { icon: 'ğŸ“Š', text: 'é€²æ—ã‚’åˆ†æ', action: 'analyzeProgress' },
                    { icon: 'ğŸ”„', text: 'æ”¹å–„ãƒ•ã‚§ãƒ¼ã‚ºã¸', action: 'moveToAdapt' },
                    { icon: 'â—€ï¸', text: 'è¨­è¨ˆã«æˆ»ã‚‹', action: 'moveToDesign' }
                ],
                'Adapt': [
                    { icon: 'ğŸ“', text: 'æ”¹å–„ç‚¹ãƒ¡ãƒ¢', action: 'showImprovements' },
                    { icon: 'âœ…', text: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†', action: 'completeProject' },
                    { icon: 'ğŸ”„', text: 'å†è¨­è¨ˆã™ã‚‹', action: 'moveToDesign' },
                    { icon: 'â–¶ï¸', text: 'å®Ÿè¡Œã«æˆ»ã‚‹', action: 'moveToCheck' }
                ]
            };

            const phaseActions = actions[project.phase] || [];
            if (phaseActions.length === 0) return '';

            return `
                <div class="phase-actions">
                    ${phaseActions.map(action => `
                        <div class="phase-action" onclick="handlePhaseAction(event, '${project.id}', '${action.action}')">
                            <span class="phase-action-icon">${action.icon}</span>
                            <span>${action.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handlePhaseAction(event, projectId, action) {
            event.stopPropagation();
            
            switch (action) {
                case 'moveToPlay':
                    moveToPhase(projectId, 'Play');
                    break;
                case 'moveToDesign':
                    moveToPhase(projectId, 'Design');
                    break;
                case 'showDailyLog':
                    showDailyLog(projectId);
                    break;
                case 'moveToCheck':
                    moveToPhase(projectId, 'Check');
                    break;
                case 'analyzeProgress':
                    analyzeProjectProgress(projectId);
                    break;
                case 'moveToAdapt':
                    moveToPhase(projectId, 'Adapt');
                    break;
                case 'showImprovements':
                    showImprovementModal(projectId);
                    break;
                case 'completeProject':
                    completeProject(projectId);
                    break;
                case 'restartCycle':
                    restartProjectCycle(projectId);
                    break;
            }
        }

        // ã‚«ã‚¦ãƒ³ãƒˆã®å¢—æ¸›
        function incrementCount(event, projectId, itemIndex, delta) {
            event.stopPropagation();
            
            const log = {
                id: Date.now().toString(),
                projectId: projectId,
                date: new Date().toISOString(),
                type: 'count',
                itemIndex: itemIndex,
                value: delta
            };
            
            app.logs.push(log);
            saveData();
            
            // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
            const countElement = document.getElementById(`count_${projectId}_${itemIndex}`);
            if (countElement) {
                const newCount = getProjectCountForItem(projectId, itemIndex);
                countElement.textContent = newCount;
            }
            
            showToast(`ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ: ${delta > 0 ? '+' : ''}${delta}`, 'success');
        }

        // ã‚«ã‚¦ãƒ³ãƒˆã®ç›´æ¥ç·¨é›†
        function editCount(event, projectId, itemIndex) {
            event.stopPropagation();
            
            const countElement = event.target;
            const currentCount = getProjectCountForItem(projectId, itemIndex);
            
            // inputã«ç½®ãæ›ãˆ
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'counter-input';
            input.value = currentCount;
            input.onclick = (e) => e.stopPropagation();
            
            input.onblur = () => {
                const newValue = parseInt(input.value) || 0;
                const delta = newValue - currentCount;
                
                if (delta !== 0) {
                    const log = {
                        id: Date.now().toString(),
                        projectId: projectId,
                        date: new Date().toISOString(),
                        type: 'count',
                        itemIndex: itemIndex,
                        value: delta
                    };
                    
                    app.logs.push(log);
                    saveData();
                    showToast('ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                }
                
                // å…ƒã®è¡¨ç¤ºã«æˆ»ã™
                countElement.textContent = newValue;
                countElement.style.display = '';
                input.remove();
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            countElement.style.display = 'none';
            countElement.parentElement.insertBefore(input, countElement.nextSibling);
            input.focus();
            input.select();
        }

        // ç‰¹å®šé …ç›®ã®ã‚«ã‚¦ãƒ³ãƒˆå–å¾—
        function getProjectCountForItem(projectId, itemIndex) {
            return app.logs.filter(log => 
                log.projectId === projectId && 
                log.type === 'count' &&
                log.itemIndex === itemIndex
            ).reduce((sum, log) => sum + (log.value || 0), 0);
        }

        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆæ•°ã®å–å¾—
        function getMilestoneAchievedCount(project) {
            const milestoneLogs = app.logs.filter(log =>
                log.projectId === project.id &&
                log.type === 'milestone'
            );
            
            const achievedMilestones = new Set();
            milestoneLogs.forEach(log => {
                if (log.achieved) {
                    achievedMilestones.add(log.milestoneIndex);
                }
            });
            
            return achievedMilestones.size;
        }

        // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®çµ±è¨ˆã‚’è¨ˆç®—
        function calculateCheckpointStats(project) {
            if (project.trackingType !== 'daily' || !project.checkpoints) return [];
            
            const projectLogs = app.logs.filter(log => log.projectId === project.id);
            
            return project.checkpoints.map((checkpoint, index) => {
                const completedCount = projectLogs.filter(log => 
                    log.checkpoints && log.checkpoints[index] === true
                ).length;
                
                const totalDays = Math.min(
                    Math.floor((new Date() - new Date(project.startDate)) / (1000 * 60 * 60 * 24)) + 1,
                    project.duration
                );
                
                const rate = totalDays > 0 ? Math.round((completedCount / totalDays) * 100) : 0;
                
                return {
                    name: checkpoint,
                    completedCount,
                    totalDays,
                    rate
                };
            });
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã®åˆ†æ
        function analyzeProjectProgress(projectId) {
            const project = app.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const stats = calculateCheckpointStats(project);
            const overallProgress = calculateProjectProgress(project);
            
            let analysis = `ğŸ“Š ${project.name} ã®é€²æ—åˆ†æ\n\n`;
            analysis += `ç·åˆé€²æ—: ${overallProgress}%\n`;
            analysis += `çµŒéæ—¥æ•°: ${Math.floor((new Date() - new Date(project.startDate)) / (1000 * 60 * 60 * 24)) + 1}æ—¥\n\n`;
            
            if (stats.length > 0) {
                analysis += `é …ç›®åˆ¥é”æˆç‡:\n`;
                stats.forEach(stat => {
                    analysis += `â€¢ ${stat.name}: ${stat.rate}% (${stat.completedCount}/${stat.totalDays}æ—¥)\n`;
                });
                
                // æœ€ã‚‚é”æˆç‡ãŒé«˜ã„é …ç›®ã¨ä½ã„é …ç›®ã‚’ç‰¹å®š
                const bestItem = stats.reduce((best, current) => 
                    current.rate > best.rate ? current : best
                );
                const worstItem = stats.reduce((worst, current) => 
                    current.rate < worst.rate ? current : worst
                );
                
                analysis += `\nğŸ’ª æœ€ã‚‚é †èª¿: ${bestItem.name} (${bestItem.rate}%)\n`;
                analysis += `âš ï¸ è¦æ”¹å–„: ${worstItem.name} (${worstItem.rate}%)\n`;
            }
            
            alert(analysis);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤
        function deleteProject(event, projectId) {
            event.stopPropagation();
            
            if (confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                moveToTrash(event, projectId);
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ã‚¦ãƒ³ãƒˆå–å¾—
        function getProjectCount(project) {
            return app.logs.filter(log => 
                log.projectId === project.id && 
                log.type === 'count'
            ).reduce((sum, log) => sum + (log.value || 1), 0);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.getElementById('ideaContent').value = '';
        }

        function showProjectDetail(projectId) {
            const project = app.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            const body = document.getElementById('projectModalBody');
            
            title.textContent = project.name;
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è©³ç´°è¡¨ç¤º
            const logs = app.logs.filter(log => log.projectId === projectId);
            const completedDays = logs.filter(log => log.completed).length;
            const checkpointStats = calculateCheckpointStats(project);
            
            body.innerHTML = `
                <div class="form-group">
                    <label class="form-label">ã‚´ãƒ¼ãƒ«</label>
                    <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius);">
                        ${project.goal}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º: ${project.phase}</label>
                    <div style="padding: 1rem; background: var(--light-gray); border-radius: var(--radius);">
                        ${getPhaseDescription(project.phase)}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é€²æ—çŠ¶æ³</label>
                    <div class="project-stats" style="margin-top: 0;">
                        <div class="stat-item">
                            <div class="stat-value">${completedDays}</div>
                            <div class="stat-label">å®Ÿè¡Œæ—¥æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${project.duration}</div>
                            <div class="stat-label">ç›®æ¨™æ—¥æ•°</div>
                        </div>
                    </div>
                </div>
                
                ${project.trackingType === 'daily' && checkpointStats.length > 0 ? `
                    <div class="form-group">
                        <label class="form-label">ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåˆ¥é”æˆç‡</label>
                        ${checkpointStats.map(stat => `
                            <div class="checkpoint-item">
                                <span class="checkpoint-name">${stat.name}</span>
                                <span class="checkpoint-rate">${stat.rate}% (${stat.completedCount}/${stat.totalDays}æ—¥)</span>
                                <div class="mini-progress">
                                    <div class="mini-progress-fill" style="width: ${stat.rate}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${project.trackingType === 'count' && project.countItems ? `
                    <div class="form-group">
                        <label class="form-label">ã‚«ã‚¦ãƒ³ãƒˆé€²æ—</label>
                        ${project.countItems.map((item, index) => `
                            <div style="padding: 0.5rem; background: var(--light-gray); border-radius: var(--radius); margin-bottom: 0.5rem;">
                                ${item}: ${getProjectCountForItem(project.id, index)}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${project.trackingType === 'milestone' && project.milestones ? `
                    <div class="form-group">
                        <label class="form-label">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³</label>
                        ${project.milestones.map((milestone, index) => {
                            const isAchieved = isMilestoneAchieved(project.id, index);
                            return `
                                <div class="milestone-item">
                                    <span class="${isAchieved ? 'milestone-achieved' : ''}">${milestone}</span>
                                    ${isAchieved ? 'âœ…' : 'â­•'}
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            `;
            
            modal.classList.add('active');
        }

        function showSettings() {
            const modal = document.getElementById('settingsModal');
            updateNotificationStatus();
            modal.classList.add('active');
        }

        function showAPIKeyModal() {
            showSection('settingsModal');
            const modal = document.getElementById('apiKeyModal');
            const apiKeyInput = document.getElementById('apiKey');
            apiKeyInput.value = app.apiKey || '';
            modal.classList.add('active');
        }

      

        // æ”¹å–„ç‚¹ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
        function showImprovementModal(projectId) {
            app.currentProjectId = projectId;
            const modal = document.getElementById('improvementModal');
            const project = app.projects.find(p => p.id === projectId);
            
            if (!project) return;
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤º
            const modalTitle = modal.querySelector('.modal-title');
            modalTitle.textContent = `æ”¹å–„ç‚¹ãƒ¡ãƒ¢ - ${project.name}`;
            
            // æ”¹å–„ç‚¹ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            renderImprovementsList(projectId);
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('newImprovement').value = '';
            
            modal.classList.add('active');
        }

        // æ”¹å–„ç‚¹ãƒ¡ãƒ¢ã®è¿½åŠ 
        function addImprovementMemo() {
            const content = document.getElementById('newImprovement').value.trim();
            if (!content) return;
            
            const improvement = {
                id: Date.now().toString(),
                projectId: app.currentProjectId,
                content: content,
                createdAt: new Date().toISOString(),
                type: 'memo' // 'daily'ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚
            };
            
            app.improvements.push(improvement);
            saveData();
            
            document.getElementById('newImprovement').value = '';
            renderImprovementsList(app.currentProjectId);
            
            showToast('æ”¹å–„ç‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        // æ”¹å–„ç‚¹ãƒªã‚¹ãƒˆã®è¡¨ç¤º
        function renderImprovementsList(projectId) {
            const listDiv = document.getElementById('improvementsList');
            const projectImprovements = app.improvements
                .filter(imp => imp.projectId === projectId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (projectImprovements.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 2rem;">ã¾ã æ”¹å–„ç‚¹ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            listDiv.innerHTML = `
                <h4 style="margin-bottom: 1rem;">æ”¹å–„ç‚¹å±¥æ­´</h4>
                ${projectImprovements.map(imp => {
                    const date = new Date(imp.createdAt);
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    return `
                        <div style="background: var(--light-gray); padding: 1rem; border-radius: var(--radius); margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">${dateStr}</div>
                                    <div style="white-space: pre-wrap;">${imp.content}</div>
                                </div>
                                <button onclick="deleteImprovement('${imp.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0.25rem;">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // æ”¹å–„ç‚¹ã®å‰Šé™¤
        function deleteImprovement(improvementId) {
            if (confirm('ã“ã®æ”¹å–„ç‚¹ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                app.improvements = app.improvements.filter(imp => imp.id !== improvementId);
                saveData();
                renderImprovementsList(app.currentProjectId);
                showToast('æ”¹å–„ç‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ã‚¢ã‚¤ãƒ‡ã‚¢ã®è¿½åŠ 
        function addIdea() {
            const content = document.getElementById('ideaContent').value.trim();
            
            if (!content) return;
            
            const idea = {
                id: Date.now().toString(),
                content: content,
                createdAt: new Date().toISOString()
            };
            
            app.ideas.push(idea);
            saveData();
            
            closeModal('addModal');
            renderIdeas();
            
            showToast('ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚¢ã‚¤ãƒ‡ã‚¢ãƒªã‚¹ãƒˆã®æç”»
        function renderIdeas() {
            const list = document.getElementById('inboxList');
            const emptyState = document.getElementById('inboxEmpty');
            
            if (app.ideas.length === 0) {
                list.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            list.innerHTML = app.ideas.map(idea => `
                <div class="inbox-item" data-idea-id="${idea.id}">
                    <div class="inbox-content">
                        <div>${idea.content}</div>
                        <div class="inbox-date">${formatDate(new Date(idea.createdAt))}</div>
                    </div>
                    <button class="inbox-action" onclick="startDesign('${idea.id}')">
                        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–
                    </button>
                    <div class="inbox-delete-bg">
                        <span>å‰Šé™¤</span>
                    </div>
                </div>
            `).join('');
            
            // ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã‚’è¨­å®š
            setupInboxSwipe();
        }

        // ã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½
        function setupInboxSwipe() {
            const items = document.querySelectorAll('.inbox-item');
            
            items.forEach(item => {
                let touchStartX = 0;
                let touchEndX = 0;
                let currentX = 0;
                let isDragging = false;
                let startTime = 0;
                
                // ã‚¿ãƒƒãƒé–‹å§‹
                item.addEventListener('touchstart', function(e) {
                    touchStartX = e.touches[0].clientX;
                    isDragging = true;
                    startTime = Date.now();
                    item.style.transition = 'none';
                    e.stopPropagation();
                }, { passive: false });
                
                // ã‚¿ãƒƒãƒç§»å‹•
                item.addEventListener('touchmove', function(e) {
                    if (!isDragging) return;
                    
                    touchEndX = e.touches[0].clientX;
                    currentX = touchEndX - touchStartX;
                    
                    // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ã®ã¿è¨±å¯ï¼ˆå‰Šé™¤ï¼‰
                    if (currentX < 0) {
                        // æœ€å¤§-100pxã¾ã§
                        currentX = Math.max(currentX, -100);
                        item.style.transform = `translateX(${currentX}px)`;
                        e.stopPropagation();
                    }
                }, { passive: false });
                
                // ã‚¿ãƒƒãƒçµ‚äº†
                item.addEventListener('touchend', function(e) {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    const endTime = Date.now();
                    const timeDiff = endTime - startTime;
                    const velocity = Math.abs(currentX) / timeDiff;
                    
                    item.style.transition = 'transform 0.3s ease-out';
                    
                    // ã‚¹ãƒ¯ã‚¤ãƒ—ã®åˆ¤å®šï¼ˆ-50pxä»¥ä¸Šã¾ãŸã¯é«˜é€Ÿã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰
                    if (currentX < -50 || (currentX < -20 && velocity > 0.5)) {
                        // å‰Šé™¤ä½ç½®ã¾ã§ç§»å‹•
                        item.style.transform = 'translateX(-100px)';
                        
                        // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
                        const deleteBtn = item.querySelector('.inbox-delete-bg');
                        deleteBtn.style.pointerEvents = 'auto';
                        deleteBtn.addEventListener('click', function() {
                            const ideaId = item.dataset.ideaId;
                            deleteIdea(ideaId);
                        });
                        e.stopPropagation();
                    } else {
                        // å…ƒã®ä½ç½®ã«æˆ»ã™
                        item.style.transform = 'translateX(0)';
                    }
                    
                    currentX = 0;
                    e.stopPropagation();
                }, { passive: false });
                
                // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¿½åŠ ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å¯¾å¿œï¼‰
                let mouseStartX = 0;
                let isMouseDragging = false;
                
                item.addEventListener('mousedown', function(e) {
                    mouseStartX = e.clientX;
                    isMouseDragging = true;
                    startTime = Date.now();
                    item.style.transition = 'none';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isMouseDragging) return;
                    
                    currentX = e.clientX - mouseStartX;
                    
                    if (currentX < 0) {
                        currentX = Math.max(currentX, -100);
                        item.style.transform = `translateX(${currentX}px)`;
                    }
                });
                
                document.addEventListener('mouseup', function(e) {
                    if (!isMouseDragging) return;
                    isMouseDragging = false;
                    
                    const endTime = Date.now();
                    const timeDiff = endTime - startTime;
                    const velocity = Math.abs(currentX) / timeDiff;
                    
                    item.style.transition = 'transform 0.3s ease-out';
                    
                    if (currentX < -50 || (currentX < -20 && velocity > 0.5)) {
                        item.style.transform = 'translateX(-100px)';
                        
                        const deleteBtn = item.querySelector('.inbox-delete-bg');
                        deleteBtn.style.pointerEvents = 'auto';
                        deleteBtn.addEventListener('click', function() {
                            const ideaId = item.dataset.ideaId;
                            deleteIdea(ideaId);
                        });
                    } else {
                        item.style.transform = 'translateX(0)';
                    }
                    
                    currentX = 0;
                });
            });
        }
        
        // ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‰Šé™¤
        function deleteIdea(ideaId) {
            const index = app.ideas.findIndex(i => i.id === ideaId);
            if (index !== -1) {
                app.ideas.splice(index, 1);
                saveData();
                renderIdeas();
                showToast('ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­è¨ˆé–‹å§‹
        function startDesign(ideaId) {
            const idea = app.ideas.find(i => i.id === ideaId);
            if (!idea) return;
            
            // ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ä¸€æ™‚ä¿å­˜
            app.currentIdeaId = ideaId;
            
            // ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            const modal = document.getElementById('designModal');
            document.getElementById('projectName').value = idea.content;
            document.getElementById('projectGoal').value = '';
            document.getElementById('projectDuration').value = '30';
            document.getElementById('trackingType').value = 'daily';
            updateTrackingUI();
            
            modal.classList.add('active');
        }

        // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°UIã®æ›´æ–°
        function updateTrackingUI() {
            const trackingType = document.getElementById('trackingType').value;
            
            document.getElementById('dailyCheckGroup').style.display = 
                trackingType === 'daily' ? 'block' : 'none';
            document.getElementById('countGroup').style.display = 
                trackingType === 'count' ? 'block' : 'none';
            document.getElementById('milestoneGroup').style.display = 
                trackingType === 'milestone' ? 'block' : 'none';
        }

        // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
        function addCheckpoint() {
            const container = document.getElementById('checkpoints');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.style.marginBottom = '0.5rem';
            input.placeholder = 'ä¾‹: ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’5åˆ†å®Ÿæ–½';
            container.appendChild(input);
        }

        // ã‚«ã‚¦ãƒ³ãƒˆé …ç›®è¿½åŠ 
        function addCountItem() {
            const container = document.getElementById('countItems');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.style.marginBottom = '0.5rem';
            input.placeholder = 'ä¾‹: è…¹ç­‹ã®å›æ•°';
            container.appendChild(input);
        }

        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¿½åŠ 
        function addMilestone() {
            const container = document.getElementById('milestones');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.style.marginBottom = '0.5rem';
            input.placeholder = 'ä¾‹: 100å›é€£ç¶šã§è…¹ç­‹ãŒã§ãã‚‹';
            container.appendChild(input);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
        function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const goal = document.getElementById('projectGoal').value.trim();
            const duration = parseInt(document.getElementById('projectDuration').value);
            const trackingType = document.getElementById('trackingType').value;
            
            if (!name || !goal) {
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨ã‚´ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const project = {
                id: Date.now().toString(),
                name: name,
                goal: goal,
                duration: duration,
                trackingType: trackingType,
                phase: 'Design',
                startDate: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                cycleCount: 1
            };
            
            // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é …ç›®ã‚’è¿½åŠ 
            if (trackingType === 'daily') {
                const checkpoints = Array.from(document.querySelectorAll('#checkpoints input'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                
                if (checkpoints.length === 0) {
                    alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                project.checkpoints = checkpoints;
            } else if (trackingType === 'count') {
                const countItems = Array.from(document.querySelectorAll('#countItems input'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                
                if (countItems.length === 0) {
                    alert('å°‘ãªãã¨ã‚‚1ã¤ã®ã‚«ã‚¦ãƒ³ãƒˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                project.countItems = countItems;
            } else if (trackingType === 'milestone') {
                const milestones = Array.from(document.querySelectorAll('#milestones input'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                
                if (milestones.length === 0) {
                    alert('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                project.milestones = milestones;
            }
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            app.projects.push(project);
            
            // å…ƒã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‰Šé™¤
            if (app.currentIdeaId) {
                app.ideas = app.ideas.filter(i => i.id !== app.currentIdeaId);
                app.currentIdeaId = null;
            }
            
            saveData();
            closeModal('designModal');
            UI.showSection('dashboard');
            
            showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
        }

        // æ—¥æ¬¡ãƒ­ã‚°ã®è¡¨ç¤º
        function showDailyLog(projectId) {
            // ç‰¹å®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ã‚°ã‚’è¡¨ç¤º
            if (projectId) {
                app.currentProjectId = projectId;
            } else {
                // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ¥ãŸå ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ãƒ•ã‚§ãƒ¼ã‚ºã®å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                app.currentProjectId = null;
            }
            
            const modal = document.getElementById('logModal');
            const body = document.getElementById('logModalBody');
            
            const today = new Date().toDateString();
            const projects = app.currentProjectId 
                ? app.projects.filter(p => p.id === app.currentProjectId)
                : app.projects.filter(p => p.phase === 'Check' && !p.completed && !p.deleted);
            
            const dailyProjects = projects.filter(p => p.trackingType === 'daily');
            const countProjects = projects.filter(p => p.trackingType === 'count');
            const milestoneProjects = projects.filter(p => p.trackingType === 'milestone');
            
            let html = '';
            
            // æ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é …ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            html += `
                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem;">ä»Šæ—¥ã®æ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é …</h4>
                    <textarea 
                        id="dailyImprovements" 
                        class="form-control" 
                        rows="3" 
                        placeholder="ä»Šæ—¥å®Ÿæ–½ã—ãŸæ”¹å–„ç‚¹ã‚„ã€æ–°ã—ãé©å¿œã—ãŸã“ã¨ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹ï¼šä½œæ¥­æ™‚é–“ã‚’æœã«å¤‰æ›´ã—ãŸã€æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’å°å…¥ã—ãŸã€ãªã©"
                        style="width: 100%; resize: vertical;"
                    >${getTodayImprovements()}</textarea>
                </div>
            `;
            
            // æ¯æ—¥ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
            if (dailyProjects.length > 0) {
                html += '<h4 style="margin-bottom: 1rem;">ä»Šæ—¥ã®ãƒã‚§ãƒƒã‚¯é …ç›®</h4>';
                dailyProjects.forEach(project => {
                    const todayLog = app.logs.find(log => 
                        log.projectId === project.id && 
                        new Date(log.date).toDateString() === today
                    );
                    
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <h5 style="margin-bottom: 0.5rem;">${project.name}</h5>
                            ${project.checkpoints.map((checkpoint, index) => `
                                <div class="checkbox-group">
                                    <input type="checkbox" 
                                           id="check_${project.id}_${index}"
                                           ${todayLog && todayLog.checkpoints && todayLog.checkpoints[index] ? 'checked' : ''}>
                                    <label for="check_${project.id}_${index}" class="checkbox-label">
                                        ${checkpoint}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
            }
            
            // ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
            if (countProjects.length > 0) {
                html += '<h4 style="margin-top: 2rem; margin-bottom: 1rem;">ã‚«ã‚¦ãƒ³ãƒˆé …ç›®</h4>';
                countProjects.forEach(project => {
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <h5 style="margin-bottom: 0.5rem;">${project.name}</h5>
                            ${project.countItems.map((item, index) => {
                                const count = getProjectCountForItem(project.id, index);
                                return `
                                    <div class="counter-item">
                                        <span class="counter-label">${item}</span>
                                        <div class="counter-controls">
                                            <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, -1)">âˆ’</button>
                                            <span class="counter-value" id="modal_count_${project.id}_${index}">${count}</span>
                                            <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, 1)">+</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                });
            }
            
            // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
            if (milestoneProjects.length > 0) {
                html += '<h4 style="margin-top: 2rem; margin-bottom: 1rem;">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆ</h4>';
                milestoneProjects.forEach(project => {
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <h5 style="margin-bottom: 0.5rem;">${project.name}</h5>
                            ${project.milestones.map((milestone, index) => {
                                const achieved = isMilestoneAchieved(project.id, index);
                                const tempKey = `milestone_${project.id}_${index}`;
                                const tempAchieved = sessionStorage.getItem(tempKey) === 'true';
                                
                                return `
                                    <div class="milestone-item">
                                        <input type="checkbox" 
                                               class="milestone-checkbox"
                                               id="milestone_${project.id}_${index}"
                                               ${achieved || tempAchieved ? 'checked' : ''}
                                               onchange="toggleMilestone('${project.id}', ${index}, this.checked)">
                                        <label for="milestone_${project.id}_${index}" 
                                               class="milestone-text ${achieved || tempAchieved ? 'milestone-achieved' : ''}">
                                            ${milestone}
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                });
            }
            
            if (html === '') {
                html = '<p style="text-align: center; color: var(--gray);">è¨˜éŒ²ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            body.innerHTML = html;
            modal.classList.add('active');
            
            // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒãƒŠãƒ¼ã‚’éè¡¨ç¤º
            document.getElementById('reminderBanner').classList.remove('show');
        }

        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleMilestone(projectId, milestoneIndex, achieved) {
            const tempKey = `milestone_${projectId}_${milestoneIndex}`;
            sessionStorage.setItem(tempKey, achieved ? 'true' : 'false');
            
            // UIã®æ›´æ–°
            const label = document.querySelector(`label[for="milestone_${projectId}_${milestoneIndex}"]`);
            if (label) {
                if (achieved) {
                    label.classList.add('milestone-achieved');
                } else {
                    label.classList.remove('milestone-achieved');
                }
            }
        }

        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãŒé”æˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        function isMilestoneAchieved(projectId, milestoneIndex) {
            const latestLog = app.logs
                .filter(log => 
                    log.projectId === projectId && 
                    log.type === 'milestone' &&
                    log.milestoneIndex === milestoneIndex
                )
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            
            return latestLog && latestLog.achieved;
        }

        // ä»Šæ—¥ã®æ”¹å–„ç‚¹ã‚’å–å¾—
        function getTodayImprovements() {
            const today = new Date().toDateString();
            const todayImprovement = app.improvements?.find(imp => 
                new Date(imp.date).toDateString() === today
            );
            return todayImprovement?.content || '';
        }
        
        // æ—¥æ¬¡ãƒ­ã‚°ã®ä¿å­˜
        function saveDailyLog() {
            const today = new Date();
            
            // æ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é …ã‚’ä¿å­˜
            const improvementsText = document.getElementById('dailyImprovements')?.value;
            if (improvementsText && improvementsText.trim()) {
                if (!app.improvements) {
                    app.improvements = [];
                }
                
                const todayIndex = app.improvements.findIndex(imp => 
                    new Date(imp.date).toDateString() === today.toDateString()
                );
                
                const improvement = {
                    id: todayIndex >= 0 ? app.improvements[todayIndex].id : Date.now().toString(),
                    date: today.toISOString(),
                    content: improvementsText.trim()
                };
                
                if (todayIndex >= 0) {
                    app.improvements[todayIndex] = improvement;
                } else {
                    app.improvements.push(improvement);
                }
                
                localStorage.setItem('pdca_improvements', JSON.stringify(app.improvements));
            }
            
            // æ¯æ—¥ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‡¦ç†
            const dailyProjects = app.currentProjectId 
                ? app.projects.filter(p => p.id === app.currentProjectId && p.trackingType === 'daily')
                : app.projects.filter(p => p.phase === 'Check' && p.trackingType === 'daily' && !p.completed && !p.deleted);
            
            dailyProjects.forEach(project => {
                const checkpoints = {};
                let hasChecked = false;
                
                project.checkpoints.forEach((_, index) => {
                    const checkbox = document.getElementById(`check_${project.id}_${index}`);
                    if (checkbox) {
                        checkpoints[index] = checkbox.checked;
                        if (checkbox.checked) hasChecked = true;
                    }
                });
                
                if (hasChecked) {
                    // ä»Šæ—¥ã®ãƒ­ã‚°ãŒã‚ã‚‹ã‹ç¢ºèª
                    const existingLogIndex = app.logs.findIndex(log => 
                        log.projectId === project.id && 
                        new Date(log.date).toDateString() === today.toDateString()
                    );
                    
                    const log = {
                        id: existingLogIndex >= 0 ? app.logs[existingLogIndex].id : Date.now().toString(),
                        projectId: project.id,
                        date: today.toISOString(),
                        checkpoints: checkpoints,
                        completed: Object.values(checkpoints).every(v => v === true)
                    };
                    
                    if (existingLogIndex >= 0) {
                        app.logs[existingLogIndex] = log;
                    } else {
                        app.logs.push(log);
                    }
                }
            });
            
            // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã®å‡¦ç†
            const milestoneProjects = app.currentProjectId 
                ? app.projects.filter(p => p.id === app.currentProjectId && p.trackingType === 'milestone')
                : app.projects.filter(p => p.phase === 'Check' && p.trackingType === 'milestone' && !p.completed && !p.deleted);
            
            milestoneProjects.forEach(project => {
                project.milestones.forEach((_, index) => {
                    const tempKey = `milestone_${project.id}_${index}`;
                    const tempValue = sessionStorage.getItem(tempKey);
                    
                    if (tempValue !== null) {
                        const achieved = tempValue === 'true';
                        const existingAchieved = isMilestoneAchieved(project.id, index);
                        
                        if (achieved !== existingAchieved) {
                            const log = {
                                id: Date.now().toString() + '_' + index,
                                projectId: project.id,
                                date: today.toISOString(),
                                type: 'milestone',
                                milestoneIndex: index,
                                achieved: achieved
                            };
                            app.logs.push(log);
                        }
                        
                        sessionStorage.removeItem(tempKey);
                    }
                });
            });
            
            // æœ€çµ‚ãƒã‚§ãƒƒã‚¯æ—¥ã‚’æ›´æ–°
            localStorage.setItem(DataManager.STORAGE_KEYS.LAST_CHECK_DATE, today.toDateString());
            
            saveData();
            closeModal('logModal');
            renderDashboard();
            
            showToast('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã®è¨ˆç®—
        function calculateProjectProgress(project) {
            if (project.trackingType === 'daily') {
        const logs = app.logs.filter(log => log.projectId === project.id);
        const totalCheckpoints = project.checkpoints.length * project.duration;
        let completedCheckpoints = 0;
        
        logs.forEach(log => {
            if (log.checkpoints) {
                completedCheckpoints += Object.values(log.checkpoints).filter(v => v === true).length;
            }
        });
        
        return totalCheckpoints > 0 ? Math.round((completedCheckpoints / totalCheckpoints) * 100) : 0;
            } else if (project.trackingType === 'count') {
                // ã‚«ã‚¦ãƒ³ãƒˆå‹ã®é€²æ—ï¼ˆä»®ï¼š100å›ã‚’ç›®æ¨™ã¨ã—ã¦è¨ˆç®—ï¼‰
                const totalCount = project.countItems.reduce((sum, _, index) => {
                    return sum + getProjectCountForItem(project.id, index);
                }, 0);
                const targetCount = project.countItems.length * 100; // å„é …ç›®100å›ã‚’ç›®æ¨™
                return Math.min(100, Math.round((totalCount / targetCount) * 100));
            } else if (project.trackingType === 'milestone') {
                const achieved = getMilestoneAchievedCount(project);
                const total = project.milestones.length;
                return Math.round((achieved / total) * 100);
            }
            return 0;
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ®‹ã‚Šæ—¥æ•°ã‚’å–å¾—
        function getProjectDaysLeft(project) {
            const startDate = new Date(project.startDate);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + project.duration);
            
            const today = new Date();
            const daysLeft = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
            
            return Math.max(0, daysLeft);
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã‚’å–å¾—
        function getPhaseDescription(phase) {
            const descriptions = {
                'Play': 'ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’è‡ªç”±ã«è€ƒãˆã€å¯èƒ½æ€§ã‚’æ¢ã‚‹æ®µéš',
                'Design': 'ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…·ä½“çš„ãªè¨ˆç”»ã«è½ã¨ã—è¾¼ã‚€æ®µéš',
                'Check': 'è¨ˆç”»ã‚’å®Ÿè¡Œã—ã€é€²æ—ã‚’ç¢ºèªã™ã‚‹æ®µéš',
                'Adapt': 'çµæœã‚’è©•ä¾¡ã—ã€æ”¹å–„ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹æ®µéš'
            };
            return descriptions[phase] || '';
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºç§»å‹•
        function moveToPhase(projectId, newPhase) {
            const project = app.projects.find(p => p.id === projectId);
            if (!project) return;
            
            project.phase = newPhase;
            saveData();
            renderDashboard();
            
            showToast(`${newPhase}ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»å‹•ã—ã¾ã—ãŸ`, 'success');
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Œäº†
        function completeProject(projectId) {
            const project = app.projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ')) {
                project.completed = true;
                project.completedAt = new Date().toISOString();
                saveData();
                renderDashboard();
                
                showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å†é–‹
        function reactivateProject(event, projectId) {
            event.stopPropagation();
            
            const project = app.projects.find(p => p.id === projectId);
            if (!project) return;
            
            project.completed = false;
            project.phase = 'Design';
            delete project.completedAt;
            
            saveData();
            showSection('dashboard');
            
            showToast('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†é–‹ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚µã‚¤ã‚¯ãƒ«ã®å†é–‹
        function restartProjectCycle(projectId) {
            const project = app.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // ã‚µã‚¤ã‚¯ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
            project.cycleCount = (project.cycleCount || 1) + 1;
            project.phase = 'Design';
            project.startDate = new Date().toISOString();
            
            saveData();
            renderDashboard();
            
            showToast('æ–°ã—ã„ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
        }

        // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®æç”»
        function renderWeeklyReport() {
            const reportDiv = document.getElementById('weeklyReport');
            const lastReport = localStorage.getItem('pdca_last_report');
            
            if (lastReport) {
                const report = JSON.parse(lastReport);
                reportDiv.innerHTML = `
                    <div class="analysis-card">
                        <div class="analysis-title">é€±æ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</div>
                        <div class="analysis-content">${report.content.replace(/\n/g, '<br>')}</div>
                        <div style="margin-top: 1rem; font-size: 0.875rem; opacity: 0.8;">
                            ç”Ÿæˆæ—¥: ${formatDate(new Date(report.date))}
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateWeeklyReport()">æ–°ã—ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ</button>
                    <button class="btn btn-secondary" style="margin-left: 0.5rem;" onclick="downloadReport()">
                        ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                `;
            }
        }

        // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
        async function generateWeeklyReport() {
                console.log('API Key status:', app.apiKey ? 'Set' : 'Not set');
                console.log('API Key length:', app.apiKey ? app.apiKey.length : 0);
                console.log('API Key starts with sk-:', app.apiKey ? app.apiKey.startsWith('sk-') : false);

            if (!app.apiKey) {
                alert('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€è¨­å®šã‹ã‚‰OpenAI APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                showSettings();
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const weeklyLogs = app.logs.filter(log => 
                    new Date(log.date) >= weekAgo
                );
                
                const activeProjects = app.projects.filter(p => !p.completed && !p.deleted);
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®é€²æ—ã‚µãƒãƒªãƒ¼
                const projectSummaries = activeProjects.map(project => {
                    const projectLogs = weeklyLogs.filter(log => log.projectId === project.id);
                    const progress = calculateProjectProgress(project);
                    
                    return {
                        name: project.name,
                        phase: project.phase,
                        progress: progress,
                        logsCount: projectLogs.length,
                        trackingType: project.trackingType
                    };
                });
                
                // ä»Šé€±ã®æ”¹å–„ç‚¹ã‚’å–å¾—
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                
                const weeklyImprovements = app.improvements.filter(imp => {
                    const impDate = new Date(imp.createdAt);
                    return impDate >= startOfWeek && impDate <= now;
                });

                // OpenAI APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const prompt = `
ä»¥ä¸‹ã®PDCAãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€±æ¬¡é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æ—¥æœ¬èªã§ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š

${projectSummaries.map(p => `
- ${p.name} (${p.phase}ãƒ•ã‚§ãƒ¼ã‚º)
  é€²æ—: ${p.progress}%
  ä»Šé€±ã®è¨˜éŒ²: ${p.logsCount}å›
  ã‚¿ã‚¤ãƒ—: ${p.trackingType}
`).join('\n')}

${weeklyImprovements.length > 0 ? `
ä»Šé€±å®Ÿæ–½ã—ãŸæ”¹å–„ãƒ»é©å¿œï¼ˆ${weeklyImprovements.length}ä»¶ï¼‰:
${weeklyImprovements.map(imp => {
    const project = app.projects.find(p => p.id === imp.projectId);
    return `- ${project ? project.name : 'å…¨èˆ¬'}: ${imp.content}`;
}).join('\n')}
` : ''}

ä»¥ä¸‹ã®è¦³ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ï¼š
1. å…¨ä½“çš„ãªé€²æ—çŠ¶æ³ã®è©•ä¾¡
2. ${weeklyImprovements.length > 0 ? 'å®Ÿæ–½ã—ãŸæ”¹å–„ã®åŠ¹æœã¨ä»Šå¾Œã®å±•é–‹' : 'æœ€ã‚‚é †èª¿ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨æ”¹å–„ãŒå¿…è¦ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ'}
3. æ¥é€±ã«å‘ã‘ã¦ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
4. ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒã®ãŸã‚ã®åŠ±ã¾ã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${app.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "ã‚ãªãŸã¯ç”Ÿç”£æ€§å‘ä¸Šã®å°‚é–€å®¶ã§ã™ã€‚PDCAã‚µã‚¤ã‚¯ãƒ«ã‚’ä½¿ã£ãŸè‡ªå·±æ”¹å–„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆ†æã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã„ã¾ã™ã€‚" },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
                
                const data = await response.json();
                const report = {
                    date: new Date().toISOString(),
                    content: data.choices[0].message.content
                };
                
                // ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
                localStorage.setItem('pdca_last_report', JSON.stringify(report));
                
                // ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
                renderWeeklyReport();
                
                showToast('é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                console.error('AI API Error Details:', error);
                alert(`ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}

è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            } finally {
                button.disabled = false;
                button.textContent = 'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ';
            }
        }

        // ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆ
        async function generateDailyComment() {
            if (!app.apiKey) {
                alert('ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€è¨­å®šã‹ã‚‰OpenAI APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                showSettings();
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayLogs = app.logs.filter(log => {
                    const logDate = new Date(log.date);
                    logDate.setHours(0, 0, 0, 0);
                    return logDate.getTime() === today.getTime();
                });
                
                const activeProjects = app.projects.filter(p => !p.completed && !p.deleted);
                
                // æœ¬æ—¥ã®æ´»å‹•ã‚µãƒãƒªãƒ¼
                const todaySummary = activeProjects.map(project => {
                    const projectLogs = todayLogs.filter(log => log.projectId === project.id);
                    return {
                        name: project.name,
                        phase: project.phase,
                        logsCount: projectLogs.length,
                        activities: projectLogs.map(log => log.content).join(', ')
                    };
                }).filter(p => p.logsCount > 0);

                // ä»Šæ—¥ã®æ”¹å–„ç‚¹ã‚’å–å¾—
                const todayImprovement = app.improvements?.find(imp => {
                    const impDate = new Date(imp.date);
                    impDate.setHours(0, 0, 0, 0);
                    return impDate.getTime() === today.getTime();
                });

                const prompt = `ä»¥ä¸‹ã¯ä»Šæ—¥ã®PDCAãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ´»å‹•è¨˜éŒ²ã§ã™ã€‚

${todaySummary.length > 0 ? 
`æœ¬æ—¥ã®æ´»å‹•:
${todaySummary.map(p => `- ${p.name} (${p.phase}ãƒ•ã‚§ãƒ¼ã‚º): ${p.activities}`).join('\n')}` :
'æœ¬æ—¥ã¯ã¾ã æ´»å‹•è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'}

${todayImprovement ? 
`æœ¬æ—¥ã®æ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é …:
${todayImprovement.content}` : ''}

ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°: ${activeProjects.length}

ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰ã€åŠ±ã¾ã—ã¨å»ºè¨­çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å«ã‚€çŸ­ã„ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ150æ–‡å­—ç¨‹åº¦ï¼‰:
1. æœ¬æ—¥ã®æ´»å‹•ã¸ã®è©•ä¾¡
2. ${todayImprovement ? 'æ”¹å–„ç‚¹ã®åŠ¹æœã«ã¤ã„ã¦ã®è©•ä¾¡' : 'æ˜æ—¥ã«å‘ã‘ã¦ã®æ”¹å–„ææ¡ˆ'}
3. æ˜æ—¥ã«å‘ã‘ã¦ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹
4. ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜ã‚ã‚‹ä¸€è¨€`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${app.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "ã‚ãªãŸã¯å„ªã—ãã¦åŠ±ã¾ã—ä¸Šæ‰‹ãªã‚³ãƒ¼ãƒã§ã™ã€‚ç°¡æ½”ã§æ¸©ã‹ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã™ã€‚" },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const comment = data.choices[0].message.content;
                
                // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
                const dailyComment = {
                    date: new Date().toISOString(),
                    content: comment
                };
                
                // ä»Šæ—¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ï¼ˆ1æ—¥1ã¤ï¼‰
                const savedComments = JSON.parse(localStorage.getItem('pdca_daily_comments') || '[]');
                const todayIndex = savedComments.findIndex(c => {
                    const commentDate = new Date(c.date);
                    commentDate.setHours(0, 0, 0, 0);
                    return commentDate.getTime() === today.getTime();
                });
                
                if (todayIndex >= 0) {
                    savedComments[todayIndex] = dailyComment;
                } else {
                    savedComments.push(dailyComment);
                }
                
                localStorage.setItem('pdca_daily_comments', JSON.stringify(savedComments));
                
                // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
                renderDailyComment();
                
                showToast('ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('AI Comment Generation Error - Full details:', error);
                console.error('Error stack:', error.stack);
                alert(`ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'ä»Šæ—¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ';
            }
        }

        // ãƒ‡ã‚¤ãƒªãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®è¡¨ç¤º
        function renderDailyComment() {
            const dailyCommentDiv = document.getElementById('dailyComment');
            const savedComments = JSON.parse(localStorage.getItem('pdca_daily_comments') || '[]');
            
            if (savedComments.length === 0) {
                dailyCommentDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <div class="empty-text">ä»Šæ—¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                        <button class="btn btn-primary" onclick="generateDailyComment()">ä»Šæ—¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ</button>
                    </div>
                `;
                return;
            }
            
            // æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰è¡¨ç¤º
            const sortedComments = savedComments.sort((a, b) => new Date(b.date) - new Date(a.date));
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            dailyCommentDiv.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="generateDailyComment()">ä»Šæ—¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ</button>
                </div>
                ${sortedComments.map(comment => {
                    const commentDate = new Date(comment.date);
                    const isToday = (() => {
                        const d = new Date(comment.date);
                        d.setHours(0, 0, 0, 0);
                        return d.getTime() === today.getTime();
                    })();
                    
                    return `
                        <div class="analysis-card" style="margin-bottom: 1rem; ${isToday ? 'border: 2px solid var(--primary);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div style="font-weight: bold; color: var(--white); opacity: 0.9;">
                                    ${formatDate(commentDate)} ${isToday ? '(ä»Šæ—¥)' : ''}
                                </div>
                            </div>
                            <div style="font-size: 1.1rem; line-height: 1.6;">
                                ${comment.content}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç”Ÿæˆ
        async function generateMonthlyInsight() {
            if (!app.apiKey) {
                alert('æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€è¨­å®šã‹ã‚‰OpenAI APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                showSettings();
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // ä»Šæœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                const monthlyLogs = app.logs.filter(log => 
                    new Date(log.date) >= monthStart
                );
                
                const monthlyProjects = app.projects.filter(p => 
                    new Date(p.createdAt) >= monthStart || monthlyLogs.some(log => log.projectId === p.id)
                );
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®çµ±è¨ˆ
                const projectStats = monthlyProjects.map(project => {
                    const projectLogs = monthlyLogs.filter(log => log.projectId === project.id);
                    const progress = calculateProjectProgress(project);
                    
                    return {
                        name: project.name,
                        phase: project.phase,
                        progress: progress,
                        logsCount: projectLogs.length,
                        completed: project.completed,
                        createdThisMonth: new Date(project.createdAt) >= monthStart
                    };
                });

                const completedCount = projectStats.filter(p => p.completed).length;
                const activeCount = projectStats.filter(p => !p.completed).length;
                const totalLogs = monthlyLogs.length;
                
                // ä»Šæœˆã®æ”¹å–„ç‚¹ã‚’å–å¾—
                const monthlyImprovements = app.improvements?.filter(imp => 
                    new Date(imp.date) >= monthStart
                ) || [];

                const prompt = `ä»¥ä¸‹ã¯ä»Šæœˆã®PDCAãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚

ä»Šæœˆã®æ´»å‹•:
- ç·ãƒ­ã‚°æ•°: ${totalLogs}
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${activeCount}
- å®Œäº†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${completedCount}
- æ–°è¦é–‹å§‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${projectStats.filter(p => p.createdThisMonth).length}

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°:
${projectStats.map(p => `- ${p.name} (${p.phase}ãƒ•ã‚§ãƒ¼ã‚º): ãƒ­ã‚°æ•°${p.logsCount}å›, é€²æ—${p.progress}%${p.completed ? ' [å®Œäº†]' : ''}`).join('\n')}

${monthlyImprovements.length > 0 ? 
`ä»Šæœˆå®Ÿæ–½ã—ãŸæ”¹å–„ç‚¹ãƒ»é©å¿œäº‹é … (${monthlyImprovements.length}ä»¶):
${monthlyImprovements.slice(-5).map(imp => `- ${new Date(imp.date).getDate()}æ—¥: ${imp.content}`).join('\n')}` : ''}

ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰ã€ä»Šæœˆã®æŒ¯ã‚Šè¿”ã‚Šã¨æ¥æœˆã¸ã®æˆ¦ç•¥çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å«ã‚€æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ300æ–‡å­—ç¨‹åº¦ï¼‰:
1. ä»Šæœˆã®æˆæœã¨æ”¹å–„ç‚¹ã®åˆ†æ
2. ${monthlyImprovements.length > 0 ? 'å®Ÿæ–½ã—ãŸæ”¹å–„ãƒ»é©å¿œã®åŠ¹æœè©•ä¾¡' : 'PDCAã‚µã‚¤ã‚¯ãƒ«ã®å®Ÿæ–½çŠ¶æ³ã®è©•ä¾¡'}
3. æ¥æœˆã®é‡ç‚¹èª²é¡Œã®ææ¡ˆ
4. ç”Ÿç”£æ€§å‘ä¸Šã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${app.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "ã‚ãªãŸã¯ç”Ÿç”£æ€§å‘ä¸Šã®å°‚é–€å®¶ã§ã™ã€‚PDCAã‚µã‚¤ã‚¯ãƒ«ã‚’ä½¿ã£ãŸè‡ªå·±æ”¹å–„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æœˆæ¬¡åˆ†æã¨æˆ¦ç•¥çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡Œã„ã¾ã™ã€‚" },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const insight = data.choices[0].message.content;
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ä¿å­˜
                const monthlyInsight = {
                    date: new Date().toISOString(),
                    month: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`,
                    content: insight,
                    stats: {
                        totalLogs,
                        activeCount,
                        completedCount
                    }
                };
                
                const savedInsights = JSON.parse(localStorage.getItem('pdca_monthly_insights') || '[]');
                const existingIndex = savedInsights.findIndex(i => i.month === monthlyInsight.month);
                
                if (existingIndex >= 0) {
                    savedInsights[existingIndex] = monthlyInsight;
                } else {
                    savedInsights.push(monthlyInsight);
                }
                
                localStorage.setItem('pdca_monthly_insights', JSON.stringify(savedInsights));
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¡¨ç¤º
                renderMonthlyInsight();
                
                showToast('æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'ä»Šæœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ';
            }
        }

        // æœˆæ¬¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®è¡¨ç¤º
        function renderMonthlyInsight() {
            const monthlyInsightDiv = document.getElementById('monthlyInsight');
            const savedInsights = JSON.parse(localStorage.getItem('pdca_monthly_insights') || '[]');
            
            if (savedInsights.length === 0) {
                monthlyInsightDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“ˆ</div>
                        <div class="empty-text">ä»Šæœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                        <button class="btn btn-primary" onclick="generateMonthlyInsight()">ä»Šæœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ</button>
                    </div>
                `;
                return;
            }
            
            const sortedInsights = savedInsights.sort((a, b) => new Date(b.date) - new Date(a.date));
            const currentMonth = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
            
            monthlyInsightDiv.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="generateMonthlyInsight()">ä»Šæœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ</button>
                </div>
                ${sortedInsights.map(insight => {
                    const isCurrentMonth = insight.month === currentMonth;
                    const [year, month] = insight.month.split('-');
                    
                    return `
                        <div class="analysis-card" style="margin-bottom: 1rem; ${isCurrentMonth ? 'border: 2px solid var(--primary);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="font-weight: bold; font-size: 1.2rem;">
                                    ${year}å¹´${parseInt(month)}æœˆ ${isCurrentMonth ? '(ä»Šæœˆ)' : ''}
                                </div>
                                <div style="opacity: 0.9; font-size: 0.9rem;">
                                    ãƒ­ã‚°: ${insight.stats.totalLogs} | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${insight.stats.activeCount} | å®Œäº†: ${insight.stats.completedCount}
                                </div>
                            </div>
                            <div style="font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap;">
                                ${insight.content}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // 3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç”Ÿæˆ
        async function generateQuarterlyInsight() {
            if (!app.apiKey) {
                alert('3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€è¨­å®šã‹ã‚‰OpenAI APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                showSettings();
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                // 3ãƒ¶æœˆå‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const now = new Date();
                const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                
                const quarterlyLogs = app.logs.filter(log => 
                    new Date(log.date) >= threeMonthsAgo
                );
                
                const quarterlyProjects = app.projects.filter(p => 
                    new Date(p.createdAt) >= threeMonthsAgo || quarterlyLogs.some(log => log.projectId === p.id)
                );
                
                // æœˆã”ã¨ã®çµ±è¨ˆ
                const monthlyStats = [];
                for (let i = 2; i >= 0; i--) {
                    const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const nextMonth = new Date(now.getFullYear(), now.getMonth() - i + 1, 1);
                    
                    const monthLogs = quarterlyLogs.filter(log => {
                        const logDate = new Date(log.date);
                        return logDate >= monthDate && logDate < nextMonth;
                    });
                    
                    monthlyStats.push({
                        month: `${monthDate.getFullYear()}å¹´${monthDate.getMonth() + 1}æœˆ`,
                        logsCount: monthLogs.length,
                        activeProjects: new Set(monthLogs.map(log => log.projectId)).size
                    });
                }
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æˆé•·åˆ†æ
                const projectGrowth = quarterlyProjects.map(project => {
                    const projectLogs = quarterlyLogs.filter(log => log.projectId === project.id);
                    const firstLog = projectLogs.sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                    const lastLog = projectLogs.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    
                    return {
                        name: project.name,
                        totalLogs: projectLogs.length,
                        durationDays: firstLog && lastLog ? 
                            Math.ceil((new Date(lastLog.date) - new Date(firstLog.date)) / (1000 * 60 * 60 * 24)) : 0,
                        completed: project.completed,
                        phase: project.phase
                    };
                });

                const completedCount = projectGrowth.filter(p => p.completed).length;
                const totalProjects = quarterlyProjects.length;
                const completionRate = totalProjects > 0 ? Math.round((completedCount / totalProjects) * 100) : 0;
                
                // 3ãƒ¶æœˆé–“ã®æ”¹å–„ç‚¹ã‚’å–å¾—
                const quarterlyImprovements = app.improvements?.filter(imp => 
                    new Date(imp.date) >= threeMonthsAgo
                ) || [];

                const prompt = `ä»¥ä¸‹ã¯éå»3ãƒ¶æœˆã®PDCAãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚

æœˆåˆ¥æ´»å‹•æ¨ç§»:
${monthlyStats.map(s => `- ${s.month}: ãƒ­ã‚°æ•°${s.logsCount}å›, ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ${s.activeProjects}å€‹`).join('\n')}

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†æ:
- ç·ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°: ${totalProjects}
- å®Œäº†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${completedCount} (å®Œäº†ç‡: ${completionRate}%)
- ç·ãƒ­ã‚°æ•°: ${quarterlyLogs.length}

ä¸»è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:
${projectGrowth.slice(0, 5).map(p => `- ${p.name}: ${p.totalLogs}ãƒ­ã‚°, ${p.durationDays}æ—¥é–“${p.completed ? ' [å®Œäº†]' : ` [${p.phase}]`}`).join('\n')}

${quarterlyImprovements.length > 0 ? 
`3ãƒ¶æœˆé–“ã®ä¸»ãªæ”¹å–„ãƒ»é©å¿œ (${quarterlyImprovements.length}ä»¶å®Ÿæ–½):
${quarterlyImprovements.slice(-10).map(imp => {
    const date = new Date(imp.date);
    return `- ${date.getMonth() + 1}/${date.getDate()}: ${imp.content}`;
}).join('\n')}` : ''}

ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰ã€3ãƒ¶æœˆé–“ã®æˆé•·åˆ†æã¨ä»Šå¾Œã®æˆ¦ç•¥ã‚’å«ã‚€ç·åˆã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ400æ–‡å­—ç¨‹åº¦ï¼‰:
1. 3ãƒ¶æœˆé–“ã®æˆé•·ãƒˆãƒ¬ãƒ³ãƒ‰ã¨é”æˆåº¦ã®è©•ä¾¡
2. ${quarterlyImprovements.length > 0 ? 'å®Ÿæ–½ã—ãŸæ”¹å–„ãƒ»é©å¿œã®ç´¯ç©åŠ¹æœ' : 'PDCAã‚µã‚¤ã‚¯ãƒ«ã®ç¿’æ…£åŒ–ã®åº¦åˆã„'}
3. æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¨æ”¹å–„ãŒå¿…è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š
4. æ¬¡ã®3ãƒ¶æœˆã«å‘ã‘ãŸæˆ¦ç•¥çš„æè¨€
5. é•·æœŸçš„ãªæˆé•·ã®ãŸã‚ã®å…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${app.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "ã‚ãªãŸã¯æˆé•·æˆ¦ç•¥ã®å°‚é–€å®¶ã§ã™ã€‚PDCAã‚µã‚¤ã‚¯ãƒ«ã‚’ä½¿ã£ãŸé•·æœŸçš„ãªè‡ªå·±æ”¹å–„ã®åˆ†æã¨æˆ¦ç•¥ç«‹æ¡ˆã‚’è¡Œã„ã¾ã™ã€‚" },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const insight = data.choices[0].message.content;
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ä¿å­˜
                const quarterlyInsight = {
                    date: new Date().toISOString(),
                    quarter: `${now.getFullYear()}-Q${Math.ceil((now.getMonth() + 1) / 3)}`,
                    content: insight,
                    stats: {
                        totalProjects,
                        completedCount,
                        completionRate,
                        totalLogs: quarterlyLogs.length
                    }
                };
                
                const savedInsights = JSON.parse(localStorage.getItem('pdca_quarterly_insights') || '[]');
                savedInsights.push(quarterlyInsight);
                
                // æœ€æ–°ã®10ä»¶ã®ã¿ä¿æŒ
                if (savedInsights.length > 10) {
                    savedInsights.shift();
                }
                
                localStorage.setItem('pdca_quarterly_insights', JSON.stringify(savedInsights));
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’è¡¨ç¤º
                renderQuarterlyInsight();
                
                showToast('3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = '3ãƒ¶æœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ';
            }
        }

        // 3ãƒ¶æœˆã‚¤ãƒ³ã‚µã‚¤ãƒˆã®è¡¨ç¤º
        function renderQuarterlyInsight() {
            const quarterlyInsightDiv = document.getElementById('quarterlyInsight');
            const savedInsights = JSON.parse(localStorage.getItem('pdca_quarterly_insights') || '[]');
            
            if (savedInsights.length === 0) {
                quarterlyInsightDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ¯</div>
                        <div class="empty-text">3ãƒ¶æœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                        <button class="btn btn-primary" onclick="generateQuarterlyInsight()">3ãƒ¶æœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ</button>
                    </div>
                `;
                return;
            }
            
            const sortedInsights = savedInsights.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            quarterlyInsightDiv.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="generateQuarterlyInsight()">3ãƒ¶æœˆã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ</button>
                </div>
                ${sortedInsights.map((insight, index) => {
                    const date = new Date(insight.date);
                    
                    return `
                        <div class="analysis-card" style="margin-bottom: 1rem; ${index === 0 ? 'border: 2px solid var(--primary);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="font-weight: bold; font-size: 1.2rem;">
                                    ${formatDate(date)} ç”Ÿæˆ ${index === 0 ? '(æœ€æ–°)' : ''}
                                </div>
                                <div style="opacity: 0.9; font-size: 0.9rem;">
                                    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${insight.stats.totalProjects} | å®Œäº†: ${insight.stats.completedCount} (${insight.stats.completionRate}%) | ãƒ­ã‚°: ${insight.stats.totalLogs}
                                </div>
                            </div>
                            <div style="font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap;">
                                ${insight.content}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadReport() {
            const lastReport = localStorage.getItem('pdca_last_report');
            if (!lastReport) return;
            
            const report = JSON.parse(lastReport);
            const content = `PDCA Mosaic é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ\nç”Ÿæˆæ—¥: ${formatDate(new Date(report.date))}\n\n${report.content}`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `weekly-report-${formatDate(new Date(), 'file')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ¯æ—¥ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
        function checkDailyReminder() {
            const today = new Date().toDateString();
            const lastCheckDate = localStorage.getItem(DataManager.STORAGE_KEYS.LAST_CHECK_DATE);
            
            // ä»Šæ—¥ã¾ã ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãªã„å ´åˆ
            if (lastCheckDate !== today) {
                const hasActiveProjects = app.projects.some(p => 
                    p.phase === 'Check' && p.trackingType === 'daily' && !p.completed && !p.deleted
                );
                
                if (hasActiveProjects) {
                    // æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const todayLogs = app.logs.filter(log => 
                        new Date(log.date).toDateString() === today
                    );
                    
                    const hasUncompletedTasks = app.projects.some(project => {
                        if (project.phase !== 'Check' || project.trackingType !== 'daily' || project.completed || project.deleted) return false;
                        
                        const todayLog = todayLogs.find(log => log.projectId === project.id);
                        return !todayLog || !todayLog.completed;
                    });
                    
                    if (hasUncompletedTasks) {
                        document.getElementById('reminderBanner').classList.add('show');
                        
                        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’é€ä¿¡
                        if (localStorage.getItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS) === 'enabled') {
                            sendNotification();
                        }
                    }
                }
            }
        }

        // é€šçŸ¥æ¨©é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã®é€ä¿¡
        function sendNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('PDCA Mosaic - ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯', {
                    body: 'ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ï¼',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%236366f1"/><text x="50" y="65" font-size="50" text-anchor="middle" fill="white">â—ˆ</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%236366f1"/></svg>',
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    showDailyLog();
                    notification.close();
                };
            }
        }

        // é€šçŸ¥è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleNotifications() {
            const currentStatus = localStorage.getItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS);
            const newStatus = currentStatus === 'enabled' ? 'disabled' : 'enabled';
            
            if (newStatus === 'enabled' && 'Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            localStorage.setItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS, 'enabled');
                            updateNotificationStatus();
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    localStorage.setItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS, 'enabled');
                    updateNotificationStatus();
                } else {
                    alert('ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
                }
            } else {
                localStorage.setItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS, 'disabled');
                updateNotificationStatus();
            }
        }

        // é€šçŸ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºæ›´æ–°
        function updateNotificationStatus() {
            const status = localStorage.getItem(DataManager.STORAGE_KEYS.NOTIFICATION_SETTINGS);
            const statusElement = document.getElementById('notificationStatus');
            if (statusElement) {
                statusElement.textContent = status === 'enabled' ? 'é€šçŸ¥ãŒã‚ªãƒ³ã§ã™' : 'é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã™ã‚‹';
            }
        }

        // APIã‚­ãƒ¼ã®ä¿å­˜
        function saveAPIKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            app.apiKey = apiKey;
            localStorage.setItem(DataManager.STORAGE_KEYS.API_KEY, apiKey);
            
            closeModal('apiKeyModal');
            showToast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const data = {
                ideas: app.ideas,
                projects: app.projects,
                logs: app.logs,
                improvements: app.improvements,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pdca-mosaic-backup-${formatDate(new Date(), 'file')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData() {
            document.getElementById('importFile').click();
        }

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.ideas || !data.projects || !data.logs) {
                        throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                    }
                    
                    if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                        app.ideas = data.ideas;
                        app.projects = data.projects;
                        app.logs = data.logs;
                        app.improvements = data.improvements || [];
                        
                        saveData();
                        renderDashboard();
                        
                        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
                    }
                } catch (error) {
                    alert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®çŠ¶æ…‹
        const calendarState = {
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth(),
            selectedDate: null
        };

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æç”»
        function renderCalendar() {
            const year = calendarState.currentYear;
            const month = calendarState.currentMonth;
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°
            document.getElementById('calendarTitle').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã®ç”Ÿæˆ
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weekdays.forEach(day => {
                const weekdayDiv = document.createElement('div');
                weekdayDiv.className = 'calendar-weekday';
                weekdayDiv.textContent = day;
                grid.appendChild(weekdayDiv);
            });
            
            // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’å–å¾—
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            // å‰æœˆã®æ—¥ä»˜ã‚’åŸ‹ã‚ã‚‹
            const firstDayOfWeek = firstDay.getDay();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDay.getDate() - i;
                const dayDiv = createCalendarDay(year, month - 1, day, true);
                grid.appendChild(dayDiv);
            }
            
            // å½“æœˆã®æ—¥ä»˜
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayDiv = createCalendarDay(year, month, day, false);
                
                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayDiv.classList.add('today');
                }
                
                grid.appendChild(dayDiv);
            }
            
            // æ¬¡æœˆã®æ—¥ä»˜ã‚’åŸ‹ã‚ã‚‹
            const remainingDays = 42 - (firstDayOfWeek + lastDay.getDate());
            for (let day = 1; day <= remainingDays; day++) {
                const dayDiv = createCalendarDay(year, month + 1, day, true);
                grid.appendChild(dayDiv);
            }
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜è¦ç´ ã‚’ä½œæˆ
        function createCalendarDay(year, month, day, isOtherMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            if (isOtherMonth) {
                dayDiv.classList.add('other-month');
            }
            
            const date = new Date(year, month, day);
            const dateStr = formatDateForKey(date);
            
            // ãã®æ—¥ã®æ´»å‹•ã‚’ãƒã‚§ãƒƒã‚¯
            const dayLogs = app.logs.filter(log => {
                const logDate = new Date(log.date);
                return formatDateForKey(logDate) === dateStr;
            });
            
            const dayImprovements = app.improvements.filter(imp => {
                const impDate = new Date(imp.createdAt || imp.date);
                return formatDateForKey(impDate) === dateStr;
            });
            
            if (dayLogs.length > 0 || dayImprovements.length > 0) {
                dayDiv.classList.add('has-activity');
            }
            
            // æ—¥ä»˜ç•ªå·
            const numberDiv = document.createElement('div');
            numberDiv.className = 'calendar-day-number';
            numberDiv.textContent = day;
            dayDiv.appendChild(numberDiv);
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
            if (dayLogs.length > 0 || dayImprovements.length > 0) {
                const indicatorDiv = document.createElement('div');
                indicatorDiv.className = 'calendar-day-indicator';
                
                // æœ€å¤§3ã¤ã®ãƒ‰ãƒƒãƒˆã‚’è¡¨ç¤º
                const dotCount = Math.min(3, dayLogs.length + dayImprovements.length);
                for (let i = 0; i < dotCount; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'activity-dot';
                    indicatorDiv.appendChild(dot);
                }
                
                dayDiv.appendChild(indicatorDiv);
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            dayDiv.onclick = () => selectCalendarDate(date);
            
            return dayDiv;
        }


        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’é¸æŠ
        function selectCalendarDate(date) {
            // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠã‚’è¿½åŠ 
            event.currentTarget.classList.add('selected');
            calendarState.selectedDate = date;
            
            // è©³ç´°ã‚’è¡¨ç¤º
            showDayDetail(date);
        }

        // æ—¥ä»˜ã®è©³ç´°ã‚’è¡¨ç¤º
        function showDayDetail(date) {
            const detailDiv = document.getElementById('dayDetail');
            const dateStr = formatDateForKey(date);
            
            // ãã®æ—¥ã®ãƒ­ã‚°ã‚’å–å¾—
            const dayLogs = app.logs.filter(log => {
                const logDate = new Date(log.date);
                return formatDateForKey(logDate) === dateStr;
            });
            
            // ãã®æ—¥ã®æ”¹å–„ç‚¹ã‚’å–å¾—
            const dayImprovements = app.improvements.filter(imp => {
                const impDate = new Date(imp.createdAt || imp.date);
                return formatDateForKey(impDate) === dateStr;
            });
            
            let html = `
                <div class="day-detail">
                    <div class="day-detail-header">
                        <div class="day-detail-date">${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥</div>
                        <button class="btn btn-secondary" onclick="closeDayDetail()">é–‰ã˜ã‚‹</button>
                    </div>
            `;
            
            // ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if (dayLogs.length > 0) {
                html += `
                    <div class="day-detail-section">
                        <div class="day-detail-section-title">
                            <span>ğŸ“</span>
                            <span>æ´»å‹•è¨˜éŒ² (${dayLogs.length}ä»¶)</span>
                        </div>
                `;
                
                dayLogs.forEach(log => {
                    const project = app.projects.find(p => p.id === log.projectId);
                    if (project) {
                        html += `
                            <div class="day-detail-item">
                                <div class="day-detail-project">${project.name}</div>
                        `;
                        
                        if (log.checkpoints) {
                            const checkedCount = Object.values(log.checkpoints).filter(c => c).length;
                            html += `<div>ãƒã‚§ãƒƒã‚¯é …ç›®: ${checkedCount}/${Object.keys(log.checkpoints).length} å®Œäº†</div>`;
                        }
                        
                        if (log.type === 'count') {
                            html += `<div>ã‚«ã‚¦ãƒ³ãƒˆ: +${log.value}</div>`;
                        }
                        
                        if (log.type === 'milestone') {
                            html += `<div>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³: ${log.achieved ? 'é”æˆ' : 'æœªé”æˆ'}</div>`;
                        }
                        
                        html += `</div>`;
                    }
                });
                
                html += `</div>`;
            }
            
            // æ”¹å–„ç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if (dayImprovements.length > 0) {
                html += `
                    <div class="day-detail-section">
                        <div class="day-detail-section-title">
                            <span>ğŸ’¡</span>
                            <span>æ”¹å–„ç‚¹ãƒ»é©å¿œ (${dayImprovements.length}ä»¶)</span>
                        </div>
                `;
                
                dayImprovements.forEach(imp => {
                    const project = app.projects.find(p => p.id === imp.projectId);
                    html += `
                        <div class="day-detail-item">
                            ${project ? `<div class="day-detail-project">${project.name}</div>` : ''}
                            <div>${imp.content}</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // AIã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const dailyComments = JSON.parse(localStorage.getItem('pdca_daily_comments') || '[]');
            const dayComment = dailyComments.find(comment => {
                const commentDate = new Date(comment.date);
                return formatDateForKey(commentDate) === dateStr;
            });
            
            if (dayComment) {
                html += `
                    <div class="day-detail-section">
                        <div class="day-detail-section-title">
                            <span>ğŸ¤–</span>
                            <span>AIã‚³ãƒ¡ãƒ³ãƒˆ</span>
                        </div>
                        <div class="day-detail-item">
                            ${dayComment.content}
                        </div>
                    </div>
                `;
            }
            
            if (dayLogs.length === 0 && dayImprovements.length === 0 && !dayComment) {
                html += `
                    <div style="text-align: center; color: var(--gray); padding: 2rem;">
                        ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                `;
            }
            
            html += `</div>`;
            
            detailDiv.innerHTML = html;
            detailDiv.style.display = 'block';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
            detailDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // æ—¥ä»˜è©³ç´°ã‚’é–‰ã˜ã‚‹
        function closeDayDetail() {
            document.getElementById('dayDetail').style.display = 'none';
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
        }

        // æœˆã‚’å¤‰æ›´
        function changeMonth(delta) {
            calendarState.currentMonth += delta;
            
            if (calendarState.currentMonth < 0) {
                calendarState.currentMonth = 11;
                calendarState.currentYear--;
            } else if (calendarState.currentMonth > 11) {
                calendarState.currentMonth = 0;
                calendarState.currentYear++;
            }
            
            renderCalendar();
        }

        // ä»Šæ—¥ã«ç§»å‹•
        function goToToday() {
            const today = new Date();
            calendarState.currentYear = today.getFullYear();
            calendarState.currentMonth = today.getMonth();
            renderCalendar();
        }

       
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }
</script>
<!-- JavaScript -->
<script src="js/utils.js"></script>
<script src="js/data.js"></script>
<script src="js/ui.js"></script>
</body>
</html>
