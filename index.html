<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDCA Mosaic - あなたの人生をデザインする</title>

    <!-- ▼▼▼ PWA設定 ▼▼▼ -->
    <meta name="application-name" content="PDCA Mosaic">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PDCA Mosaic">
    <meta name="theme-color" content="#6366f1">

    <!-- アイコンの定義 (PNG形式に変更) -->
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/6366f1/FFFFFF?text=◈">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/6366f1/FFFFFF?text=◈">

    <!-- Web App Manifest (JavaScriptで動的に設定) -->
    <link rel="manifest" id="manifestLink">
    <!-- ▲▲▲ PWA設定 ▲▲▲ -->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light-gray: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --radius-lg: 24px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-gray);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* アニメーション */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ヘッダー */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 200;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.2rem;
        }

        /* ナビゲーション */
        .nav-tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white);
            padding: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 60px;
            z-index: 100;
        }
        
        .nav-primary {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }
        
        .nav-secondary {
            position: relative;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .nav-tab:hover {
            background: var(--light-gray);
            transform: translateY(-1px);
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        .nav-text {
            display: none;
        }
        
        @media (min-width: 768px) {
            .nav-text {
                display: inline;
            }
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .nav-menu-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: var(--light-gray);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            color: var(--text-secondary);
        }
        
        .nav-menu-btn:hover {
            background: var(--primary);
            color: var(--white);
            transform: rotate(90deg);
        }
        
        .nav-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .nav-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text);
            font-size: 0.95rem;
        }
        
        .dropdown-item:hover {
            background: var(--light-gray);
            padding-left: 1.25rem;
        }
        
        .dropdown-item:first-child {
            border-radius: var(--radius) var(--radius) 0 0;
        }
        
        .dropdown-item:last-child {
            border-radius: 0 0 var(--radius) var(--radius);
        }
        
        .dropdown-icon {
            font-size: 1.1rem;
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 0.5rem 0;
        }

        /* メインコンテンツ */
        .main-content {
            padding: 1rem;
            padding-bottom: 100px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* セクション */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        /* 検索バー */
        .search-container {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-tags {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 0.5rem 1rem;
            background: var(--light-gray);
            border: none;
            border-radius: 999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tag.active {
            background: var(--primary);
            color: var(--white);
        }

        /* プロジェクトグリッド */
        .project-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        /* プロジェクトカード */
        .project-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid rgba(0,0,0,0.06);
            overflow: hidden;
        }
        
        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: var(--primary);
        }
        
        .project-card:hover::before {
            transform: scaleX(1);
        }

        .project-card.completed {
            opacity: 0.8;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .project-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .project-phase {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            color: var(--white);
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .project-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light-gray);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 999px;
            transition: width 0.3s ease;
        }

        /* チェックポイント進捗 */
        .checkpoint-progress {
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .checkpoint-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .checkpoint-item:last-child {
            border-bottom: none;
        }

        .checkpoint-name {
            flex: 1;
            color: var(--dark);
        }

        .checkpoint-rate {
            font-weight: 600;
            color: var(--primary);
        }

        .mini-progress {
            width: 60px;
            height: 4px;
            background: var(--light-gray);
            border-radius: 2px;
            overflow: hidden;
            margin-left: 0.5rem;
        }

        .mini-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* カウンター */
        .counter-section {
            margin-top: 1rem;
        }

        .counter-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--light-gray);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .counter-label {
            font-weight: 500;
            color: var(--dark);
        }

        .counter-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .counter-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--white);
            color: var(--dark);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .counter-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        .counter-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .counter-value:hover {
            background: var(--light-gray);
        }

        .counter-input {
            width: 60px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 0.25rem;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
            backdrop-filter: blur(10px);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .bottom-nav-content {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-item {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            color: var(--gray);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        .nav-label {
            font-size: 0.75rem;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* フォーム要素 */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* ボタン */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* 空状態 */
        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-text {
            color: var(--gray);
            margin-bottom: 1.5rem;
        }

        /* Daily Reminder Banner */
        .reminder-banner {
            position: fixed;
            top: -100px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: var(--white);
            padding: 1rem;
            text-align: center;
            z-index: 1000;
            transition: top 0.3s ease;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
        }

        .reminder-banner.show {
            top: 0;
            animation: slideDown 0.3s ease;
        }

        .reminder-text {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .reminder-subtext {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Inbox Item */
        .inbox-item {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .inbox-item:hover {
            transform: translateX(4px);
        }

        .inbox-content {
            flex: 1;
        }

        .inbox-date {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }

        .inbox-action {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .inbox-action:hover {
            transform: scale(1.05);
        }

        /* Settings */
        .settings-item {
            padding: 1rem;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-item:hover {
            background: var(--light-gray);
        }

        .settings-label {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .settings-description {
            font-size: 0.875rem;
            color: var(--gray);
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: var(--light-gray);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-group:hover {
            background: #e5e7eb;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
            cursor: pointer;
        }

        .checkbox-label {
            flex: 1;
        }

        /* Milestone Item */
        .milestone-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: var(--light-gray);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .milestone-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 0.75rem;
        }

        .milestone-text {
            flex: 1;
        }

        .milestone-achieved {
            text-decoration: line-through;
            color: var(--gray);
        }

        /* Phase Actions */
        .phase-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
        }

        .phase-action {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: var(--light-gray);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .phase-action:hover {
            background: #e5e7eb;
        }

        .phase-action-icon {
            margin-right: 0.5rem;
        }

        /* Analysis Card */
        .analysis-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .analysis-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .analysis-content {
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap; /* 改行を反映させる */
        }

        /* カウント項目追加 */
        .add-counter-item {
            padding: 0.5rem;
            background: var(--light-gray);
            border-radius: var(--radius);
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .add-counter-input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--white);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .add-counter-btn {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Toast通知 */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 3000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        /* ゴミ箱アイコン */
        .trash-icon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            background: var(--danger);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .project-card:hover .trash-icon {
            opacity: 1;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .project-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal-content {
                max-width: 600px;
            }
        }

        @media (min-width: 1024px) {
            .project-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes swipeIndicator {
            from { 
                transform: translateY(-50%) scale(0.5); 
                opacity: 0;
            }
            50% {
                transform: translateY(-50%) scale(1);
                opacity: 0.3;
            }
            to { 
                transform: translateY(-50%) scale(0.8); 
                opacity: 0;
            }
        }

        /* 完了プロジェクト専用スタイル */
        .completed-badge {
            display: inline-block;
            background: var(--success);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        /* カレンダースタイル */
        .calendar-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--light-gray);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-top: 1rem;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 0.75rem;
            color: var(--gray);
            padding: 0.5rem;
            font-weight: 600;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            background: var(--white);
            font-weight: 500;
        }

        .calendar-day:hover {
            background: var(--light-gray);
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            color: var(--gray);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--primary);
            color: var(--white);
            font-weight: 700;
        }

        .calendar-day.has-activity {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .calendar-day.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.05);
        }

        .calendar-day-number {
            font-size: 0.875rem;
        }

        .calendar-day-indicator {
            position: absolute;
            bottom: 4px;
            display: flex;
            gap: 2px;
        }

        .activity-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--success);
        }

        /* 日付詳細ビュー */
        .day-detail {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }

        .day-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .day-detail-date {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .day-detail-section {
            margin-bottom: 1.5rem;
        }

        .day-detail-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .day-detail-item {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
        }

        .day-detail-project {
            font-weight: 500;
            color: var(--primary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        /* 片手操作の改善 */
        @media (max-width: 768px) {
            .main-content {
                padding-bottom: 120px;
            }

            .bottom-nav {
                height: 80px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
            }

            .nav-item {
                padding: 0.75rem 1rem;
            }

            .nav-icon {
                font-size: 1.5rem;
            }

            .nav-label {
                font-size: 0.85rem;
                font-weight: 500;
            }

            .project-card {
                margin-bottom: 1rem;
                padding: 1.25rem;
            }

            .fab {
                bottom: 100px;
                width: 64px;
                height: 64px;
                font-size: 1.75rem;
            }

            /* タップターゲットを大きく */
            .btn {
                min-height: 48px;
                padding: 0.875rem 1.75rem;
            }

            .counter-btn {
                width: 44px;
                height: 44px;
            }

            .checkbox-group input[type="checkbox"] {
                width: 24px;
                height: 24px;
            }

            /* スワイプヒント */
            .swipe-hint {
                position: fixed;
                bottom: 90px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: var(--white);
                padding: 0.5rem 1rem;
                border-radius: 999px;
                font-size: 0.75rem;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
                z-index: 1000;
            }

            .swipe-hint.show {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <!-- Daily Reminder Banner -->
    <div id="reminderBanner" class="reminder-banner" onclick="showDailyLog()">
        <div class="reminder-text">🔔 今日のタスクをチェックしましょう！</div>
        <div class="reminder-subtext">タップして記録を開始</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">◈</div>
                <span>PDCA Mosaic</span>
            </div>
            <button class="nav-item" onclick="showSettings()">
                <span class="nav-icon">⚙️</span>
            </button>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
        <div class="nav-primary">
            <button class="nav-tab active" onclick="showSection('dashboard', this)">
                <span class="nav-icon">📊</span>
                <span class="nav-text">ダッシュボード</span>
            </button>
            <button class="nav-tab" onclick="showSection('play', this)">
                <span class="nav-icon">💡</span>
                <span class="nav-text">アイデア</span>
            </button>
            <button class="nav-tab" onclick="showSection('daily', this)">
                <span class="nav-icon">💬</span>
                <span class="nav-text">デイリー</span>
            </button>
            <button class="nav-tab" onclick="showSection('calendar', this)">
                <span class="nav-icon">📅</span>
                <span class="nav-text">カレンダー</span>
            </button>
        </div>
        <div class="nav-secondary">
            <button class="nav-menu-btn" onclick="toggleNavMenu()">
                <span class="menu-icon">⋯</span>
            </button>
            <div class="nav-dropdown">
                <button class="dropdown-item" onclick="showSection('weekly', this)">
                    <span class="dropdown-icon">📈</span>週次レポート
                </button>
                <button class="dropdown-item" onclick="showSection('monthly', this)">
                    <span class="dropdown-icon">📊</span>月次インサイト
                </button>
                <button class="dropdown-item" onclick="showSection('quarterly', this)">
                    <span class="dropdown-icon">🎯</span>3ヶ月インサイト
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" onclick="showSection('completed', this)">
                    <span class="dropdown-icon">✅</span>完了済み
                </button>
                <button class="dropdown-item" onclick="showSection('trash', this)">
                    <span class="dropdown-icon">🗑️</span>ゴミ箱
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <!-- Search and Filter -->
            <div class="search-container">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="プロジェクトを検索..."
                       onkeyup="filterProjects()">
                <div class="filter-tags">
                    <button class="filter-tag active" onclick="setFilter('all', this)">すべて</button>
                    <button class="filter-tag" onclick="setFilter('Design', this)">Design</button>
                    <button class="filter-tag" onclick="setFilter('Check', this)">Check</button>
                    <button class="filter-tag" onclick="setFilter('Adapt', this)">Adapt</button>
                </div>
            </div>

            <div class="project-grid" id="projectGrid">
                <!-- Projects will be dynamically loaded here -->
            </div>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">📋</div>
                <div class="empty-text">まだプロジェクトがありません</div>
                <button class="btn btn-primary" onclick="showSection('play')">アイデア一覧へ</button>
            </div>
        </section>

        <!-- Play (Ideas) Section -->
        <section id="play" class="section">
            <h2 style="margin-bottom: 1rem;">アイデア・インボックス</h2>
            <div id="inboxList">
                <!-- Ideas will be listed here -->
            </div>
            <div class="empty-state" id="inboxEmpty" style="display: none;">
                <div class="empty-icon">💡</div>
                <div class="empty-text">新しいアイデアを追加しましょう</div>
            </div>
        </section>

        <!-- Completed Projects Section -->
        <section id="completed" class="section">
            <h2 style="margin-bottom: 1rem;">完了したプロジェクト</h2>
            <div class="project-grid" id="completedGrid">
                <!-- Completed projects will be listed here -->
            </div>
            <div class="empty-state" id="completedEmpty" style="display: none;">
                <div class="empty-icon">✅</div>
                <div class="empty-text">まだ完了したプロジェクトはありません</div>
            </div>
        </section>

        <!-- Trash Section -->
        <section id="trash" class="section">
            <h2 style="margin-bottom: 1rem;">ゴミ箱</h2>
            <div class="project-grid" id="trashGrid">
                <!-- Deleted projects will be listed here -->
            </div>
            <div class="empty-state" id="trashEmpty" style="display: none;">
                <div class="empty-icon">🗑️</div>
                <div class="empty-text">ゴミ箱は空です</div>
            </div>
            <button class="btn btn-danger" onclick="emptyTrash()" style="margin-top: 1rem;">
                ゴミ箱を空にする
            </button>
        </section>

        <!-- Weekly Report Section -->
        <section id="weekly" class="section">
            <h2 style="margin-bottom: 1rem;">週次インサイト</h2>
            <div id="weeklyReport">
                <div class="empty-state">
                    <div class="empty-icon">📊</div>
                    <div class="empty-text">レポートはまだありません</div>
                    <button class="btn btn-primary" onclick="generateWeeklyReport(event)">レポートを生成</button>
                </div>
            </div>
        </section>

        <!-- Daily Comment Section -->
        <section id="daily" class="section">
            <h2 style="margin-bottom: 1rem;">デイリーコメント</h2>
            <div id="dailyComment">
                <div class="empty-state">
                    <div class="empty-icon">💬</div>
                    <div class="empty-text">今日のコメントはまだありません</div>
                    <button class="btn btn-primary" onclick="generateDailyComment(event)">今日のコメントを生成</button>
                </div>
            </div>
        </section>

        <!-- Monthly Insights Section -->
        <section id="monthly" class="section">
            <h2 style="margin-bottom: 1rem;">月次インサイト</h2>
            <div id="monthlyInsight">
                <div class="empty-state">
                    <div class="empty-icon">📈</div>
                    <div class="empty-text">今月のインサイトはまだありません</div>
                    <button class="btn btn-primary" onclick="generateMonthlyInsight(event)">今月のインサイトを生成</button>
                </div>
            </div>
        </section>

        <!-- Quarterly Insights Section -->
        <section id="quarterly" class="section">
            <h2 style="margin-bottom: 1rem;">3ヶ月インサイト</h2>
            <div id="quarterlyInsight">
                <div class="empty-state">
                    <div class="empty-icon">🎯</div>
                    <div class="empty-text">3ヶ月のインサイトはまだありません</div>
                    <button class="btn btn-primary" onclick="generateQuarterlyInsight(event)">3ヶ月のインサイトを生成</button>
                </div>
            </div>
        </section>

        <!-- Calendar Section -->
        <section id="calendar" class="section">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">◀</button>
                    <div class="calendar-title" id="calendarTitle">2024年1月</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">▶</button>
                        <button class="calendar-nav-btn" onclick="goToToday()">今日</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>
            <div id="dayDetail" style="display: none;">
                <!-- Day detail will be shown here -->
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showAddModal()">+</button>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-content">
            <button class="nav-item active" onclick="showSection('dashboard', this)">
                <span class="nav-icon">🏠</span>
                <span class="nav-label">ホーム</span>
            </button>
            <button class="nav-item" onclick="showSection('play', this)">
                <span class="nav-icon">💡</span>
                <span class="nav-label">アイデア</span>
            </button>
            <button class="nav-item" onclick="showDailyLog()">
                <span class="nav-icon">📝</span>
                <span class="nav-label">記録</span>
            </button>
            <button class="nav-item" onclick="showSection('calendar', this)">
                <span class="nav-icon">📅</span>
                <span class="nav-label">カレンダー</span>
            </button>
        </div>
    </nav>
    
    <!-- Modals -->
    <!-- (Modal HTML is unchanged from the original) -->
    <!-- Add Idea Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">新しいアイデア</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">どんなアイデア？</label>
                    <textarea class="form-control" id="ideaContent" placeholder="例: バーピーを毎日やってみる"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addModal')">キャンセル</button>
                <button class="btn btn-primary" onclick="addIdea()">追加</button>
            </div>
        </div>
    </div>

    <!-- Project Design Modal -->
    <div class="modal" id="designModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">プロジェクト設計</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">プロジェクト名</label>
                    <input type="text" class="form-control" id="projectName" placeholder="例: バーピー習慣化プロジェクト">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ゴール（何を達成したい？）</label>
                    <textarea class="form-control" id="projectGoal" placeholder="例: 3ヶ月後に、毎日20回のバーピーを息切れせずにできるようになる"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">期間</label>
                    <select class="form-control" id="projectDuration">
                        <option value="7">1週間</option>
                        <option value="14">2週間</option>
                        <option value="30" selected>30日間</option>
                        <option value="60">60日間</option>
                        <option value="90">90日間</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">進捗管理方法</label>
                    <select class="form-control" id="trackingType" onchange="updateTrackingUI()">
                        <option value="daily">毎日チェック</option>
                        <option value="count">回数をカウント</option>
                        <option value="milestone">マイルストーン達成</option>
                    </select>
                </div>
                
                <div class="form-group" id="dailyCheckGroup">
                    <label class="form-label">毎日チェックする項目</label>
                    <div id="checkpoints">
                        <input type="text" class="form-control" style="margin-bottom: 0.5rem;" placeholder="例: バーピーを10回実施">
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="addCheckpoint()">+ 項目を追加</button>
                </div>
                
                <div class="form-group" id="countGroup" style="display: none;">
                    <label class="form-label">カウントする項目</label>
                    <div id="countItems">
                        <input type="text" class="form-control" style="margin-bottom: 0.5rem;" placeholder="例: バーピーの回数">
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="addCountItem()">+ 項目を追加</button>
                </div>
                
                <div class="form-group" id="milestoneGroup" style="display: none;">
                    <label class="form-label">達成したいマイルストーン</label>
                    <div id="milestones">
                        <input type="text" class="form-control" style="margin-bottom: 0.5rem;" placeholder="例: 10回連続でバーピーができる">
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="addMilestone()">+ マイルストーンを追加</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('designModal')">キャンセル</button>
                <button class="btn btn-primary" onclick="createProject()">プロジェクト開始</button>
            </div>
        </div>
    </div>

    <!-- Daily Log Modal -->
    <div class="modal" id="logModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">今日の記録</h3>
            </div>
            <div class="modal-body" id="logModalBody">
                <!-- Daily logs will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('logModal')">閉じる</button>
                <button class="btn btn-primary" onclick="saveDailyLog()">保存</button>
            </div>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">プロジェクト詳細</h3>
            </div>
            <div class="modal-body" id="projectModalBody">
                <!-- Project details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">設定</h3>
            </div>
            <div class="modal-body">
                <div class="settings-item" onclick="showAPIKeyModal()">
                    <div class="settings-label">Gemini APIキー</div>
                    <div class="settings-description">AI分析機能を使用するために必要です</div>
                </div>
                
                <div class="settings-item" onclick="exportData()">
                    <div class="settings-label">データをエクスポート</div>
                    <div class="settings-description">すべてのデータをJSONファイルで保存</div>
                </div>
                
                <div class="settings-item" onclick="importData()">
                    <div class="settings-label">データをインポート</div>
                    <div class="settings-description">保存したデータを読み込む</div>
                </div>
                
                <div class="settings-item" onclick="toggleNotifications()">
                    <div class="settings-label">通知設定</div>
                    <div class="settings-description" id="notificationStatus">通知をオンにする</div>
                </div>
                
                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">閉じる</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal" id="apiKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Gemini APIキー設定</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">APIキー</label>
                    <input type="password" class="form-control" id="apiKey" placeholder="APIキーを入力...">
                    <small style="color: var(--gray); display: block; margin-top: 0.5rem;">
                        APIキーは暗号化せず、ブラウザのローカルストレージに保存されます。
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('apiKeyModal')">キャンセル</button>
                <button class="btn btn-primary" onclick="saveAPIKey()">保存</button>
            </div>
        </div>
    </div>

    <!-- Improvement Memo Modal -->
    <div class="modal" id="improvementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">改善点メモ</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">新しい改善点</label>
                    <textarea class="form-control" id="newImprovement" rows="3" placeholder="実施した改善や今後の改善アイデアを記入してください"></textarea>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="addImprovementMemo()">追加</button>
                </div>
                <div id="improvementsList" style="margin-top: 2rem;">
                    <!-- 改善点リストがここに表示されます -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('improvementModal')">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        // --- アプリケーションのコードはここから ---

        // アプリケーションの状態管理
        const app = {
            ideas: [],
            projects: [],
            logs: [],
            improvements: [],
            currentSection: 'dashboard',
            currentProjectId: null,
            currentIdeaId: null,
            apiKey: null,
            searchQuery: '',
            filterPhase: 'all'
        };

        // ローカルストレージのキー
        const STORAGE_KEYS = {
            IDEAS: 'pdca_ideas',
            PROJECTS: 'pdca_projects',
            LOGS: 'pdca_logs',
            IMPROVEMENTS: 'pdca_improvements',
            API_KEY: 'pdca_gemini_api_key', // キー名を変更
            LAST_CHECK_DATE: 'pdca_last_check',
            NOTIFICATION_SETTINGS: 'pdca_notifications'
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // PWA関連の初期化
            setupPWA();
            
            // アプリケーションデータの読み込みと描画
            loadData();
            renderDashboard();
            setupEventListeners();
            checkDailyReminder();
            requestNotificationPermission();

            // 複数タブ同期
            window.addEventListener('storage', handleStorageChange);
        });

        // --- PWA対応のためのコード ---
        function setupPWA() {
            // 1. マニフェストを動的に生成・設定
            const manifest = {
                "name": "PDCA Mosaic - あなたの人生をデザインする",
                "short_name": "PDCA Mosaic",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f3f4f6",
                "theme_color": "#6366f1",
                "description": "あなたのPDCAサイクルを管理し、人生をデザインするためのウェブアプリです。",
                "icons": [
                    {
                        "src": "https://placehold.co/192x192/6366f1/FFFFFF?text=◈",
                        "sizes": "192x192",
                        "type": "image/png",
                        "purpose": "any maskable"
                    },
                    {
                        "src": "https://placehold.co/512x512/6366f1/FFFFFF?text=◈",
                        "sizes": "512x512",
                        "type": "image/png",
                        "purpose": "any maskable"
                    }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifestLink').setAttribute('href', manifestUrl);

            // 2. Service Workerを動的に生成・登録
            const swCode = `
                const CACHE_NAME = 'pdca-mosaic-cache-v2';
                // キャッシュするリソース。必要に応じて追加してください。
                const urlsToCache = [
                    './', 
                ];

                // install イベント: キャッシュを開いてリソースを追加する
                self.addEventListener('install', event => {
                    self.skipWaiting(); // 新しいSWをすぐに有効化
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Opened cache');
                                // 重要なリソースをキャッシュする
                                return cache.addAll(urlsToCache);
                            })
                    );
                });

                // activate イベント: 古いキャッシュを削除する
                self.addEventListener('activate', event => {
                    const cacheWhitelist = [CACHE_NAME];
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheWhitelist.indexOf(cacheName) === -1) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                });

                // fetch イベント: キャッシュ優先でリソースを返す
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                // キャッシュにあればそれを返す
                                if (response) {
                                    return response;
                                }
                                // キャッシュになければネットワークから取得
                                return fetch(event.request);
                            })
                    );
                });
            `;
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            }
        }


        // --- 以下、既存のアプリケーションロジック ---

        // ナビゲーションメニューの切り替え
        function toggleNavMenu() {
            const dropdown = document.querySelector('.nav-dropdown');
            dropdown.classList.toggle('active');
            
            // 外側クリックで閉じる
            if (dropdown.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeNavMenu, { once: true });
                }, 0);
            }
        }
        
        function closeNavMenu(e) {
            const dropdown = document.querySelector('.nav-dropdown');
            const menuBtn = document.querySelector('.nav-menu-btn');
            
            if (dropdown && !dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        }
        
        // スワイプナビゲーションの設定
        function setupSwipeNavigation() {
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            const mainContent = document.querySelector('body'); // bodyでイベントを拾う
            const sections = ['dashboard', 'play', 'daily', 'calendar']; // スワイプ対象の主要セクション
            
            // タッチ開始
            mainContent.addEventListener('touchstart', function(e) {
                // モーダル表示中や入力フィールドフォーカス中はスワイプを無効化
                if (document.querySelector('.modal.active') || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                    return;
                }
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });
            
            // タッチ終了
            mainContent.addEventListener('touchend', function(e) {
                if (document.querySelector('.modal.active') || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                    return;
                }
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                const swipeDistanceX = touchEndX - touchStartX;
                const swipeDistanceY = Math.abs(touchEndY - touchStartY);
                
                // 縦スクロールの場合は無視
                if (swipeDistanceY > Math.abs(swipeDistanceX) || swipeDistanceY > 50) {
                    return;
                }
                
                // 最小スワイプ距離（50px）
                if (Math.abs(swipeDistanceX) < 50) {
                    return;
                }
                
                const currentIndex = sections.indexOf(app.currentSection);
                if (currentIndex === -1) return; // スワイプ対象外のセクションの場合は何もしない

                let newIndex = currentIndex;
                
                if (swipeDistanceX > 0 && currentIndex > 0) {
                    // 右スワイプ
                    newIndex = currentIndex - 1;
                } else if (swipeDistanceX < 0 && currentIndex < sections.length - 1) {
                    // 左スワイプ
                    newIndex = currentIndex + 1;
                }
                
                if (newIndex !== currentIndex) {
                    const newSection = sections[newIndex];
                    const tabButton = document.querySelector(`.nav-tab[onclick*="'${newSection}'"]`);
                    if (tabButton) {
                        showSection(newSection, tabButton); // showSectionを直接呼び出す
                    }
                }
            }
        }
        
        // イベントリスナーの設定
        function setupEventListeners() {
            // モーダルの外側クリックで閉じる
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            // スワイプ機能の追加
            setupSwipeNavigation();
        }

        // 複数タブ同期処理
        function handleStorageChange(e) {
            if (e.key && e.key.startsWith('pdca_')) {
                loadData();
                renderCurrentSection();
                showToast('データが別タブで更新されました', 'success');
            }
        }

        // 現在のセクションを再描画
        function renderCurrentSection() {
            const sectionFuncMap = {
                'dashboard': renderDashboard,
                'play': renderIdeas,
                'completed': renderCompletedProjects,
                'trash': renderTrashProjects,
                'weekly': renderWeeklyReport,
                'daily': renderDailyComment,
                'monthly': renderMonthlyInsight,
                'quarterly': renderQuarterlyInsight,
                'calendar': renderCalendar
            };
            const renderFunc = sectionFuncMap[app.currentSection];
            if(renderFunc) renderFunc();
        }

        // トースト通知
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // カスタム確認ダイアログ
        function showCustomConfirm(message, onConfirm) {
            // 簡単な実装例。よりリッチなUIにする場合はモーダルを作成します。
            if (window.confirm(message)) {
                onConfirm();
            }
        }

        // データの読み込み
        function loadData() {
            try {
                app.ideas = JSON.parse(localStorage.getItem(STORAGE_KEYS.IDEAS) || '[]');
                app.projects = JSON.parse(localStorage.getItem(STORAGE_KEYS.PROJECTS) || '[]');
                app.logs = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOGS) || '[]');
                app.improvements = JSON.parse(localStorage.getItem(STORAGE_KEYS.IMPROVEMENTS) || '[]');
                app.apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
            } catch (error) {
                console.error('データの読み込みに失敗しました:', error);
                showToast('データの読み込みに失敗しました', 'error');
            }
        }

        // データの保存
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEYS.IDEAS, JSON.stringify(app.ideas));
                localStorage.setItem(STORAGE_KEYS.PROJECTS, JSON.stringify(app.projects));
                localStorage.setItem(STORAGE_KEYS.LOGS, JSON.stringify(app.logs));
                localStorage.setItem(STORAGE_KEYS.IMPROVEMENTS, JSON.stringify(app.improvements));
            } catch (error) {
                console.error('データの保存に失敗しました:', error);
                showToast('データの保存に失敗しました', 'error');
            }
        }

        // 検索・フィルター機能
        function filterProjects() {
            app.searchQuery = document.getElementById('searchInput').value.toLowerCase();
            renderDashboard();
        }

        function setFilter(phase, element) {
            app.filterPhase = phase;
            
            // フィルタータグの更新
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            element.classList.add('active');
            
            renderDashboard();
        }
        
        // セクションの表示切り替え
        function showSection(sectionName, element) {
            // ドロップダウンメニューを閉じる
            const dropdown = document.querySelector('.nav-dropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                dropdown.classList.remove('active');
            }
            
            // セクションの切り替え
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');
            
            // トップナビゲーションタブの更新
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // メインのタブ（ドロップダウン以外）をクリックした場合
            const mainTab = document.querySelector(`.nav-primary .nav-tab[onclick*="'${sectionName}'"]`);
            if (mainTab) {
                mainTab.classList.add('active');
            } else if (element && element.classList.contains('dropdown-item')) {
                 // ドロップダウン内の項目がクリックされた場合、特定のタブをアクティブに見せるなどの処理も可能
            }
            
            // ボトムナビゲーションの更新
            const bottomNavItems = document.querySelectorAll('.bottom-nav .nav-item');
            bottomNavItems.forEach(item => item.classList.remove('active'));

            const navMap = {
                'dashboard': 0,
                'play': 1,
                'calendar': 3
            };
            const navIndex = navMap[sectionName];
            if (navIndex !== undefined) {
                 bottomNavItems[navIndex].classList.add('active');
            }

            app.currentSection = sectionName;
            renderCurrentSection();
        }

        // --- Gemini API 呼び出し関数 ---
        async function callGeminiAPI(prompt, systemInstruction) {
            if (!app.apiKey) {
                showToast('APIキーが設定されていません。', 'error');
                showSettings();
                return null;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${app.apiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 800
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    throw new Error(errorData.error?.message || `APIリクエストに失敗しました (${response.status})`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("APIから予期しない形式の応答がありました。");
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                showToast(`AI分析エラー: ${error.message}`, 'error');
                return null;
            }
        }


        // 週次レポートの生成
        async function generateWeeklyReport(event) {
            const button = event.target;
            button.disabled = true;
            button.textContent = '生成中...';
            
            try {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const weeklyLogs = app.logs.filter(log => new Date(log.date) >= weekAgo);
                const activeProjects = app.projects.filter(p => !p.completed && !p.deleted);
                
                const projectSummaries = activeProjects.map(project => {
                    const projectLogs = weeklyLogs.filter(log => log.projectId === project.id);
                    return {
                        name: project.name,
                        phase: project.phase,
                        progress: calculateProjectProgress(project),
                        logsCount: projectLogs.length,
                    };
                });

                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - 7);
                const weeklyImprovements = app.improvements.filter(imp => new Date(imp.createdAt) >= startOfWeek);

                const prompt = `
以下のPDCAプロジェクトの週次進捗データを分析し、日本語でインサイトとアドバイスを提供してください：
${projectSummaries.map(p => `- ${p.name} (${p.phase}フェーズ): 進捗${p.progress}%, 今週の記録${p.logsCount}回`).join('\n')}
${weeklyImprovements.length > 0 ? `今週の改善点: ${weeklyImprovements.map(imp => imp.content).join(', ')}` : ''}

分析の観点:
1. 全体的な進捗評価
2. 順調な点と課題点
3. 来週への具体的なアクションプラン
4. モチベーション維持のためのメッセージ`;

                const systemInstruction = 'あなたは生産性向上の専門家です。PDCAサイクルを使った自己改善プロジェクトの週次分析とアドバイスを行います。';
                const reportContent = await callGeminiAPI(prompt, systemInstruction);

                if (reportContent) {
                    const report = { date: new Date().toISOString(), content: reportContent };
                    localStorage.setItem('pdca_last_report', JSON.stringify(report));
                    renderWeeklyReport();
                    showToast('週次レポートを生成しました', 'success');
                }
            } finally {
                button.disabled = false;
                button.textContent = 'レポートを生成';
            }
        }
        
        // 週次レポートの描画
        function renderWeeklyReport() {
            const reportDiv = document.getElementById('weeklyReport');
            const lastReport = localStorage.getItem('pdca_last_report');
            
            if (lastReport) {
                const report = JSON.parse(lastReport);
                reportDiv.innerHTML = `
                    <div class="analysis-card">
                        <div class="analysis-title">週次インサイト</div>
                        <div class="analysis-content">${report.content}</div>
                        <div style="margin-top: 1rem; font-size: 0.875rem; opacity: 0.8;">
                            生成日: ${formatDate(new Date(report.date))}
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateWeeklyReport(event)">新しいレポートを生成</button>
                    <button class="btn btn-secondary" style="margin-left: 0.5rem;" onclick="downloadReport('weekly')">
                        レポートをダウンロード
                    </button>
                `;
            } else {
                 reportDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <div class="empty-text">レポートはまだありません</div>
                        <button class="btn btn-primary" onclick="generateWeeklyReport(event)">レポートを生成</button>
                    </div>
                 `;
            }
        }

        // 以下、他のAI生成関数も同様に callGeminiAPI を使うように修正
        async function generateDailyComment(event) {
            const button = event.target;
            button.disabled = true;
            button.textContent = '生成中...';
            try {
                 const prompt = `ユーザーは今日の活動を振り返っています。今日の活動内容とプロジェクト全体の状況を考慮し、励ましと明日へのヒントになる短いコメント（150字以内）を生成してください。`;
                 const systemInstruction = 'あなたは優しくて励まし上手なコーチです。簡潔で温かいメッセージを送ります。';
                 const commentContent = await callGeminiAPI(prompt, systemInstruction);
                 
                 if (commentContent) {
                    const dailyComment = { date: new Date().toISOString(), content: commentContent };
                    let savedComments = JSON.parse(localStorage.getItem('pdca_daily_comments') || '[]');
                    savedComments.push(dailyComment);
                    localStorage.setItem('pdca_daily_comments', JSON.stringify(savedComments));
                    renderDailyComment();
                    showToast('デイリーコメントを生成しました', 'success');
                 }
            } finally {
                 button.disabled = false;
                 button.textContent = '今日のコメントを生成';
            }
        }
        
        async function generateMonthlyInsight(event) {
             const button = event.target;
            button.disabled = true;
            button.textContent = '生成中...';
            try {
                 const prompt = `過去1ヶ月の全プロジェクトの進捗、ログ、改善点を総合的に分析し、月次の振り返りと来月への戦略的アドバイス（300字程度）を生成してください。`;
                 const systemInstruction = 'あなたは生産性向上の専門家です。PDCAサイクルを使った自己改善プロジェクトの月次分析と戦略的アドバイスを行います。';
                 const insightContent = await callGeminiAPI(prompt, systemInstruction);
                 
                 if (insightContent) {
                    const monthlyInsight = { date: new Date().toISOString(), content: insightContent };
                    let savedInsights = JSON.parse(localStorage.getItem('pdca_monthly_insights') || '[]');
                    savedInsights.push(monthlyInsight);
                    localStorage.setItem('pdca_monthly_insights', JSON.stringify(savedInsights));
                    renderMonthlyInsight();
                    showToast('月次インサイトを生成しました', 'success');
                 }
            } finally {
                 button.disabled = false;
                 button.textContent = '今月のインサイトを生成';
            }
        }
        
        async function generateQuarterlyInsight(event) {
             const button = event.target;
            button.disabled = true;
            button.textContent = '生成中...';
            try {
                 const prompt = `過去3ヶ月間の全プロジェクトの進捗、ログ、改善点を総合的に分析し、長期的な傾向、成功パターン、課題を特定してください。そして、次の3ヶ月に向けた戦略的な提言（400字程度）を生成してください。`;
                 const systemInstruction = 'あなたは成長戦略の専門家です。PDCAサイクルを使った長期的な自己改善の分析と戦略立案を行います。';
                 const insightContent = await callGeminiAPI(prompt, systemInstruction);
                 
                 if (insightContent) {
                    const quarterlyInsight = { date: new Date().toISOString(), content: insightContent };
                    let savedInsights = JSON.parse(localStorage.getItem('pdca_quarterly_insights') || '[]');
                    savedInsights.push(quarterlyInsight);
                    localStorage.setItem('pdca_quarterly_insights', JSON.stringify(savedInsights));
                    renderQuarterlyInsight();
                    showToast('3ヶ月インサイトを生成しました', 'success');
                 }
            } finally {
                 button.disabled = false;
                 button.textContent = '3ヶ月のインサイトを生成';
            }
        }


        // --- これより下はUI操作やデータ処理の関数群 (大部分は変更なし) ---
        // (元のコードの関数をここにペースト。ただし、alertやconfirmはshowCustomConfirmに置き換える)
        // ... (元のコードの他の関数をここにコピー)
        // ... (省略) ...
        // 修正が必要な関数のみ以下に記載

        function permanentlyDelete(event, projectId) {
            event.stopPropagation();
            showCustomConfirm('このプロジェクトを完全に削除しますか？この操作は取り消せません。', () => {
                app.projects = app.projects.filter(p => p.id !== projectId);
                app.logs = app.logs.filter(log => log.projectId !== projectId);
                saveData();
                renderTrashProjects();
                showToast('プロジェクトを完全に削除しました', 'success');
            });
        }

        function emptyTrash() {
            showCustomConfirm('ゴミ箱内のすべてのプロジェクトを完全に削除しますか？この操作は取り消せません。', () => {
                const deletedProjectIds = app.projects
                    .filter(p => p.deleted)
                    .map(p => p.id);
                
                app.projects = app.projects.filter(p => !p.deleted);
                app.logs = app.logs.filter(log => !deletedProjectIds.includes(log.projectId));
                
                saveData();
                renderTrashProjects();
                showToast('ゴミ箱を空にしました', 'success');
            });
        }
        
        function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const goal = document.getElementById('projectGoal').value.trim();
            const duration = parseInt(document.getElementById('projectDuration').value);
            const trackingType = document.getElementById('trackingType').value;
            
            if (!name || !goal) {
                showToast('プロジェクト名とゴールを入力してください', 'error');
                return;
            }
            
            const project = {
                id: Date.now().toString(),
                name: name,
                goal: goal,
                duration: duration,
                trackingType: trackingType,
                phase: 'Design',
                startDate: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                cycleCount: 1,
                completed: false,
                deleted: false
            };
            
            if (trackingType === 'daily') {
                const checkpoints = Array.from(document.querySelectorAll('#checkpoints input'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                if (checkpoints.length === 0) {
                    showToast('少なくとも1つのチェックポイントを入力してください', 'error'); return;
                }
                project.checkpoints = checkpoints;
            } else if (trackingType === 'count') {
                const countItems = Array.from(document.querySelectorAll('#countItems input'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                if (countItems.length === 0) {
                    showToast('少なくとも1つのカウント項目を入力してください', 'error'); return;
                }
                project.countItems = countItems;
            } else if (trackingType === 'milestone') {
                const milestones = Array.from(document.querySelectorAll('#milestones input'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                if (milestones.length === 0) {
                    showToast('少なくとも1つのマイルストーンを入力してください', 'error'); return;
                }
                project.milestones = milestones;
            }
            
            app.projects.push(project);
            
            if (app.currentIdeaId) {
                app.ideas = app.ideas.filter(i => i.id !== app.currentIdeaId);
                app.currentIdeaId = null;
            }
            
            saveData();
            closeModal('designModal');
            showSection('dashboard', document.querySelector('.nav-tab'));
            showToast('プロジェクトを作成しました', 'success');
        }

        function completeProject(projectId) {
            const project = app.projects.find(p => p.id === projectId);
            if (!project) return;
            
            showCustomConfirm('このプロジェクトを完了しますか？', () => {
                project.completed = true;
                project.completedAt = new Date().toISOString();
                saveData();
                renderDashboard();
                showToast('プロジェクトを完了しました！', 'success');
            });
        }
        
        function deleteImprovement(improvementId) {
            showCustomConfirm('この改善点メモを削除しますか？', () => {
                app.improvements = app.improvements.filter(imp => imp.id !== improvementId);
                saveData();
                renderImprovementsList(app.currentProjectId);
                showToast('改善点を削除しました', 'success');
            });
        }
        
        // --- 多くの関数は変更なしのため省略 ---
        // (元のコードから必要な関数をコピー＆ペーストしてください)
        // 例: renderDashboard, renderIdeas, showDailyLog, saveData, etc.
        // ...
        // 上記コード内で既に定義されている関数は不要です。
        // ここには元のコードにしかなく、上記で未定義のヘルパー関数などを追加します。
        function renderDashboard() {
            const grid = document.getElementById('projectGrid');
            const emptyState = document.getElementById('emptyState');
            
            let activeProjects = app.projects.filter(p => !p.completed && !p.deleted);
            
            if (app.searchQuery) {
                activeProjects = activeProjects.filter(p => 
                    p.name.toLowerCase().includes(app.searchQuery) ||
                    p.goal.toLowerCase().includes(app.searchQuery)
                );
            }
            
            if (app.filterPhase !== 'all') {
                activeProjects = activeProjects.filter(p => p.phase === app.filterPhase);
            }
            
            if (activeProjects.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            grid.innerHTML = activeProjects.map(project => {
                const progress = calculateProjectProgress(project);
                const phaseColors = {
                    'Play': '#6366f1',
                    'Design': '#f59e0b',
                    'Check': '#10b981',
                    'Adapt': '#ef4444'
                };
                
                const checkpointStats = calculateCheckpointStats(project);
                
                return `
                    <div class="project-card" onclick="showProjectDetail('${project.id}')">
                        <div class="trash-icon" onclick="moveToTrash(event, '${project.id}')">🗑️</div>
                        <div class="project-header">
                            <div>
                                <div class="project-title">${project.name}</div>
                                <div style="font-size: 0.875rem; color: var(--gray);">${project.duration}日間</div>
                            </div>
                            <div class="project-phase" style="background: ${phaseColors[project.phase] || phaseColors.Play}">
                                ${project.phase}
                            </div>
                        </div>
                        
                        <div class="project-stats">
                            <div class="stat-item">
                                <div class="stat-value">${progress}%</div>
                                <div class="stat-label">総合進捗</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${getProjectDaysLeft(project)}</div>
                                <div class="stat-label">残り日数</div>
                            </div>
                        </div>
                        
                        ${project.trackingType === 'daily' && checkpointStats.length > 0 ? `
                            <div class="checkpoint-progress">
                                ${checkpointStats.map(stat => `
                                    <div class="checkpoint-item">
                                        <span class="checkpoint-name">${stat.name}</span>
                                        <span class="checkpoint-rate">${stat.rate}%</span>
                                        <div class="mini-progress">
                                            <div class="mini-progress-fill" style="width: ${stat.rate}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${project.trackingType === 'count' ? renderCounterSection(project) : ''}
                        
                        ${project.trackingType === 'milestone' ? renderMilestoneProgress(project) : ''}
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        
                        ${renderPhaseActions(project)}
                    </div>
                `;
            }).join('');
        }
        function calculateProjectProgress(project) {
            if (project.trackingType === 'daily') {
                const logs = app.logs.filter(log => log.projectId === project.id);
                if (logs.length === 0) return 0;
                
                const totalChecks = project.checkpoints.length * project.duration;
                let completedChecks = 0;
                logs.forEach(log => {
                    if(log.checkpoints) {
                        completedChecks += Object.values(log.checkpoints).filter(Boolean).length;
                    }
                });

                return totalChecks > 0 ? Math.round((completedChecks / totalChecks) * 100) : 0;
            } else if (project.trackingType === 'count') {
                const totalCount = (project.countItems || []).reduce((sum, _, index) => {
                    return sum + getProjectCountForItem(project.id, index);
                }, 0);
                const target = (project.countItems?.length || 1) * 100; // 仮の目標値
                return Math.min(100, Math.round((totalCount / target) * 100));
            } else if (project.trackingType === 'milestone') {
                const achieved = getMilestoneAchievedCount(project);
                const total = (project.milestones || []).length;
                return total > 0 ? Math.round((achieved / total) * 100) : 0;
            }
            return 0;
        }

        // --- 元のコードにある、その他の多数の関数もここに必要です ---
        // (関数をすべてここに含めると長くなりすぎるため、主要な修正点のみを提示しています)
        // ... (renderIdeas, showDailyLog, saveAPIKeyなどの関数を元のコードからコピー)
        // 以下の関数は元のコードからコピー＆ペーストしてください
        function moveToTrash(event, projectId) { event.stopPropagation(); const project = app.projects.find(p => p.id === projectId); if (project) { project.deleted = true; project.deletedAt = new Date().toISOString(); saveData(); renderDashboard(); showToast('プロジェクトをゴミ箱に移動しました', 'success'); } }
        function restoreFromTrash(event, projectId) { event.stopPropagation(); const project = app.projects.find(p => p.id === projectId); if (project) { delete project.deleted; delete project.deletedAt; saveData(); renderTrashProjects(); showToast('プロジェクトを復元しました', 'success'); } }
        function renderTrashProjects() { const grid = document.getElementById('trashGrid'); const emptyState = document.getElementById('trashEmpty'); const deletedProjects = app.projects.filter(p => p.deleted); if (deletedProjects.length === 0) { grid.innerHTML = ''; emptyState.style.display = 'block'; return; } emptyState.style.display = 'none'; grid.innerHTML = deletedProjects.map(project => ` <div class="project-card" style="opacity: 0.7;"> <div class="project-header"> <div> <div class="project-title">${project.name}</div> <div style="font-size: 0.875rem; color: var(--gray);"> 削除日: ${formatDate(new Date(project.deletedAt))} </div> </div> </div> <div style="margin-top: 1rem; display: flex; gap: 0.5rem;"> <button class="btn btn-primary" onclick="restoreFromTrash(event, '${project.id}')"> 復元する </button> <button class="btn btn-danger" onclick="permanentlyDelete(event, '${project.id}')"> 完全に削除 </button> </div> </div> `).join(''); }
        function renderCounterSection(project) { if (!project.countItems) return ''; return ` <div class="counter-section"> ${project.countItems.map((item, index) => { const count = getProjectCountForItem(project.id, index); return ` <div class="counter-item"> <span class="counter-label">${item}</span> <div class="counter-controls"> <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, -1)">−</button> <span class="counter-value" onclick="editCount(event, '${project.id}', ${index})" id="count_${project.id}_${index}">${count}</span> <button class="counter-btn" onclick="incrementCount(event, '${project.id}', ${index}, 1)">+</button> </div> </div> `; }).join('')} </div> `; }
        function renderMilestoneProgress(project) { if (!project.milestones) return ''; const achievedCount = getMilestoneAchievedCount(project); return ` <div style="margin-top: 1rem;"> <div style="font-size: 0.875rem; color: var(--gray);"> 達成済み: ${achievedCount} / ${project.milestones.length} </div> </div> `; }
        function renderCompletedProjects() { const grid = document.getElementById('completedGrid'); const emptyState = document.getElementById('completedEmpty'); const completedProjects = app.projects.filter(p => p.completed && !p.deleted); if (completedProjects.length === 0) { grid.innerHTML = ''; emptyState.style.display = 'block'; return; } emptyState.style.display = 'none'; grid.innerHTML = completedProjects.map(project => ` <div class="project-card completed" onclick="showProjectDetail('${project.id}')"> <div class="project-header"> <div> <div class="project-title"> ${project.name} <span class="completed-badge">完了</span> </div> <div style="font-size: 0.875rem; color: var(--gray);"> ${project.completedAt ? `完了日: ${formatDate(new Date(project.completedAt))}` : ''} </div> </div> </div> <div class="project-stats"> <div class="stat-item"> <div class="stat-value">${project.duration}</div> <div class="stat-label">実施日数</div> </div> <div class="stat-item"> <div class="stat-value">${project.cycleCount || 1}</div> <div class="stat-label">サイクル数</div> </div> </div> <div style="margin-top: 1rem;"> <button class="btn btn-primary" onclick="reactivateProject(event, '${project.id}')"> 再開する </button> </div> </div> `).join(''); }
        function renderPhaseActions(project) { const actions = { 'Play': [{ icon: '💡', text: 'アイデアを具体化', action: 'moveToDesign' }], 'Design': [{ icon: '▶️', text: '実行開始', action: 'moveToCheck' }, { icon: '◀️', text: 'アイデアに戻す', action: 'moveToPlay' }], 'Check': [{ icon: '📝', text: '今日の記録', action: 'showDailyLog' }, { icon: '📊', text: '進捗を分析', action: 'analyzeProgress' }, { icon: '🔄', text: '改善フェーズへ', action: 'moveToAdapt' }, { icon: '◀️', text: '設計に戻る', action: 'moveToDesign' }], 'Adapt': [{ icon: '📝', text: '改善点メモ', action: 'showImprovements' }, { icon: '✅', text: 'プロジェクト完了', action: 'completeProject' }, { icon: '🔄', text: '再設計する', action: 'moveToDesign' }, { icon: '▶️', text: '実行に戻る', action: 'moveToCheck' }] }; const phaseActions = actions[project.phase] || []; if (phaseActions.length === 0) return ''; return ` <div class="phase-actions"> ${phaseActions.map(action => ` <div class="phase-action" onclick="handlePhaseAction(event, '${project.id}', '${action.action}')"> <span class="phase-action-icon">${action.icon}</span> <span>${action.text}</span> </div> `).join('')} </div> `; }
        function handlePhaseAction(event, projectId, action) { event.stopPropagation(); const actions = { 'moveToPlay': () => moveToPhase(projectId, 'Play'), 'moveToDesign': () => moveToPhase(projectId, 'Design'), 'showDailyLog': () => showDailyLog(projectId), 'moveToCheck': () => moveToPhase(projectId, 'Check'), 'analyzeProgress': () => analyzeProjectProgress(projectId), 'moveToAdapt': () => moveToPhase(projectId, 'Adapt'), 'showImprovements': () => showImprovementModal(projectId), 'completeProject': () => completeProject(projectId), 'restartCycle': () => restartProjectCycle(projectId) }; if (actions[action]) actions[action](); }
        function incrementCount(event, projectId, itemIndex, delta) { event.stopPropagation(); const log = { id: Date.now().toString(), projectId: projectId, date: new Date().toISOString(), type: 'count', itemIndex: itemIndex, value: delta }; app.logs.push(log); saveData(); const countElement = document.getElementById(`count_${projectId}_${itemIndex}`); if (countElement) countElement.textContent = getProjectCountForItem(projectId, itemIndex); showToast(`カウントを更新しました: ${delta > 0 ? '+' : ''}${delta}`, 'success'); }
        function editCount(event, projectId, itemIndex) { event.stopPropagation(); const countElement = event.target; const currentCount = getProjectCountForItem(projectId, itemIndex); const input = document.createElement('input'); input.type = 'number'; input.className = 'counter-input'; input.value = currentCount; input.onclick = (e) => e.stopPropagation(); input.onblur = () => { const newValue = parseInt(input.value) || 0; const delta = newValue - currentCount; if (delta !== 0) { const log = { id: Date.now().toString(), projectId: projectId, date: new Date().toISOString(), type: 'count', itemIndex: itemIndex, value: delta }; app.logs.push(log); saveData(); showToast('カウントを更新しました', 'success'); } countElement.textContent = newValue; countElement.style.display = ''; input.remove(); }; input.onkeypress = (e) => { if (e.key === 'Enter') input.blur(); }; countElement.style.display = 'none'; countElement.parentElement.insertBefore(input, countElement.nextSibling); input.focus(); input.select(); }
        function getProjectCountForItem(projectId, itemIndex) { return app.logs.filter(log => log.projectId === projectId && log.type === 'count' && log.itemIndex === itemIndex).reduce((sum, log) => sum + (log.value || 0), 0); }
        function getMilestoneAchievedCount(project) { const achievedMilestones = new Set(); app.logs.filter(log => log.projectId === project.id && log.type === 'milestone' && log.achieved).forEach(log => achievedMilestones.add(log.milestoneIndex)); return achievedMilestones.size; }
        function calculateCheckpointStats(project) { if (project.trackingType !== 'daily' || !project.checkpoints) return []; const projectLogs = app.logs.filter(log => log.projectId === project.id); return project.checkpoints.map((checkpoint, index) => { const completedCount = projectLogs.filter(log => log.checkpoints && log.checkpoints[index] === true).length; const totalDays = Math.min(Math.floor((new Date() - new Date(project.startDate)) / (1000 * 60 * 60 * 24)) + 1, project.duration); const rate = totalDays > 0 ? Math.round((completedCount / totalDays) * 100) : 0; return { name: checkpoint, completedCount, totalDays, rate }; }); }
        function analyzeProjectProgress(projectId) { const project = app.projects.find(p => p.id === projectId); if (!project) return; const stats = calculateCheckpointStats(project); const overallProgress = calculateProjectProgress(project); let analysis = `📊 ${project.name} の進捗分析\n\n総合進捗: ${overallProgress}%\n経過日数: ${Math.floor((new Date() - new Date(project.startDate)) / (1000 * 60 * 60 * 24)) + 1}日\n\n`; if (stats.length > 0) { analysis += `項目別達成率:\n${stats.map(stat => `• ${stat.name}: ${stat.rate}%`).join('\n')}`; } alert(analysis); }
        function showAddModal() { document.getElementById('addModal').classList.add('active'); document.getElementById('ideaContent').value = ''; }
        function showProjectDetail(projectId) { const project = app.projects.find(p => p.id === projectId); if (!project) return; const modal = document.getElementById('projectModal'); document.getElementById('projectModalTitle').textContent = project.name; document.getElementById('projectModalBody').innerHTML = `<div>...詳細表示...</div>`; modal.classList.add('active'); }
        function showSettings() { updateNotificationStatus(); document.getElementById('settingsModal').classList.add('active'); }
        function showAPIKeyModal() { closeModal('settingsModal'); const modal = document.getElementById('apiKeyModal'); document.getElementById('apiKey').value = app.apiKey || ''; modal.classList.add('active'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
        function addIdea() { const content = document.getElementById('ideaContent').value.trim(); if (!content) return; const idea = { id: Date.now().toString(), content: content, createdAt: new Date().toISOString() }; app.ideas.push(idea); saveData(); closeModal('addModal'); renderIdeas(); showToast('アイデアを追加しました', 'success'); }
        function renderIdeas() { const list = document.getElementById('inboxList'); const emptyState = document.getElementById('inboxEmpty'); if (app.ideas.length === 0) { list.innerHTML = ''; emptyState.style.display = 'block'; return; } emptyState.style.display = 'none'; list.innerHTML = app.ideas.map(idea => ` <div class="inbox-item"> <div class="inbox-content"> <div>${idea.content}</div> <div class="inbox-date">${formatDate(new Date(idea.createdAt))}</div> </div> <button class="inbox-action" onclick="startDesign('${idea.id}')"> プロジェクト化 </button> </div> `).join(''); }
        function startDesign(ideaId) { const idea = app.ideas.find(i => i.id === ideaId); if (!idea) return; app.currentIdeaId = ideaId; const modal = document.getElementById('designModal'); document.getElementById('projectName').value = idea.content; document.getElementById('projectGoal').value = ''; document.getElementById('projectDuration').value = '30'; document.getElementById('trackingType').value = 'daily'; updateTrackingUI(); modal.classList.add('active'); }
        function updateTrackingUI() { const type = document.getElementById('trackingType').value; document.getElementById('dailyCheckGroup').style.display = type === 'daily' ? 'block' : 'none'; document.getElementById('countGroup').style.display = type === 'count' ? 'block' : 'none'; document.getElementById('milestoneGroup').style.display = type === 'milestone' ? 'block' : 'none'; }
        function addCheckpoint() { const container = document.getElementById('checkpoints'); const input = document.createElement('input'); input.type = 'text'; input.className = 'form-control'; input.style.marginBottom = '0.5rem'; container.appendChild(input); }
        function addCountItem() { const container = document.getElementById('countItems'); const input = document.createElement('input'); input.type = 'text'; input.className = 'form-control'; input.style.marginBottom = '0.5rem'; container.appendChild(input); }
        function addMilestone() { const container = document.getElementById('milestones'); const input = document.createElement('input'); input.type = 'text'; input.className = 'form-control'; input.style.marginBottom = '0.5rem'; container.appendChild(input); }
        function getProjectDaysLeft(project) { const endDate = new Date(project.startDate); endDate.setDate(endDate.getDate() + project.duration); const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24)); return Math.max(0, daysLeft); }
        function moveToPhase(projectId, newPhase) { const project = app.projects.find(p => p.id === projectId); if (!project) return; project.phase = newPhase; saveData(); renderDashboard(); showToast(`${newPhase}フェーズに移動しました`, 'success'); }
        function reactivateProject(event, projectId) { event.stopPropagation(); const project = app.projects.find(p => p.id === projectId); if (!project) return; project.completed = false; project.phase = 'Design'; delete project.completedAt; saveData(); showSection('dashboard', document.querySelector('.nav-tab')); showToast('プロジェクトを再開しました', 'success'); }
        function checkDailyReminder() { const today = new Date().toDateString(); if (localStorage.getItem(STORAGE_KEYS.LAST_CHECK_DATE) !== today) { const hasActiveProjects = app.projects.some(p => p.phase === 'Check' && !p.completed && !p.deleted); if (hasActiveProjects) document.getElementById('reminderBanner').classList.add('show'); if (localStorage.getItem(STORAGE_KEYS.NOTIFICATION_SETTINGS) === 'enabled') sendNotification(); } }
        function requestNotificationPermission() { if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission(); }
        function sendNotification() { if ('Notification' in window && Notification.permission === 'granted') { new Notification('PDCA Mosaic', { body: '今日のタスクをチェックしましょう！', icon: 'https://placehold.co/192x192/6366f1/FFFFFF?text=◈' }); } }
        function toggleNotifications() { const currentStatus = localStorage.getItem(STORAGE_KEYS.NOTIFICATION_SETTINGS); if (currentStatus !== 'enabled') { if ('Notification' in window) { Notification.requestPermission().then(permission => { if (permission === 'granted') { localStorage.setItem(STORAGE_KEYS.NOTIFICATION_SETTINGS, 'enabled'); updateNotificationStatus(); } }); } } else { localStorage.setItem(STORAGE_KEYS.NOTIFICATION_SETTINGS, 'disabled'); updateNotificationStatus(); } }
        function updateNotificationStatus() { const status = localStorage.getItem(STORAGE_KEYS.NOTIFICATION_SETTINGS); document.getElementById('notificationStatus').textContent = status === 'enabled' ? '通知がオンです' : '通知をオンにする'; }
        function saveAPIKey() { const apiKey = document.getElementById('apiKey').value.trim(); if (!apiKey) { showToast('APIキーを入力してください', 'error'); return; } app.apiKey = apiKey; localStorage.setItem(STORAGE_KEYS.API_KEY, apiKey); closeModal('apiKeyModal'); showToast('APIキーを保存しました', 'success'); }
        function exportData() { const data = { ideas: app.ideas, projects: app.projects, logs: app.logs, improvements: app.improvements }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `pdca-mosaic-backup.json`; a.click(); URL.revokeObjectURL(url); showToast('データをエクスポートしました', 'success'); }
        function importData() { document.getElementById('importFile').click(); }
        function handleImport(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); showCustomConfirm('現在のデータは上書きされます。インポートしますか？', () => { app.ideas = data.ideas || []; app.projects = data.projects || []; app.logs = data.logs || []; app.improvements = data.improvements || []; saveData(); renderDashboard(); showToast('データをインポートしました', 'success'); }); } catch (err) { showToast('ファイルの読み込みに失敗しました', 'error'); } }; reader.readAsText(file); }
        const calendarState = { currentYear: new Date().getFullYear(), currentMonth: new Date().getMonth() }; function renderCalendar() { const {currentYear, currentMonth} = calendarState; document.getElementById('calendarTitle').textContent = `${currentYear}年${currentMonth + 1}月`; const grid = document.getElementById('calendarGrid'); grid.innerHTML = ''; ['日','月','火','水','木','金','土'].forEach(d => grid.innerHTML += `<div class="calendar-weekday">${d}</div>`); const firstDay = new Date(currentYear, currentMonth, 1); const lastDay = new Date(currentYear, currentMonth + 1, 0); for (let i = firstDay.getDay(); i > 0; i--) { const d = new Date(currentYear, currentMonth, 1-i); grid.appendChild(createCalendarDay(d, true)); } for (let i = 1; i <= lastDay.getDate(); i++) { const d = new Date(currentYear, currentMonth, i); grid.appendChild(createCalendarDay(d, false)); } for (let i = 1; grid.children.length < 49; i++) { const d = new Date(currentYear, currentMonth + 1, i); grid.appendChild(createCalendarDay(d, true)); } }
        function createCalendarDay(date, isOtherMonth) { const dayDiv = document.createElement('div'); dayDiv.className = 'calendar-day'; if(isOtherMonth) dayDiv.classList.add('other-month'); dayDiv.textContent = date.getDate(); const dateStr = formatDateForKey(date); if (app.logs.some(l => formatDateForKey(new Date(l.date)) === dateStr) || app.improvements.some(i => formatDateForKey(new Date(i.createdAt)) === dateStr)) dayDiv.classList.add('has-activity'); if (formatDateForKey(new Date()) === dateStr) dayDiv.classList.add('today'); dayDiv.onclick = () => showDayDetail(date); return dayDiv; }
        function changeMonth(delta) { calendarState.currentMonth += delta; if (calendarState.currentMonth < 0) { calendarState.currentMonth = 11; calendarState.currentYear--; } else if (calendarState.currentMonth > 11) { calendarState.currentMonth = 0; calendarState.currentYear++; } renderCalendar(); }
        function goToToday() { calendarState.currentYear = new Date().getFullYear(); calendarState.currentMonth = new Date().getMonth(); renderCalendar(); }
        function formatDate(date) { return date.toLocaleDateString('ja-JP'); }
        function formatDateForKey(date) { return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; }
        function showDayDetail(date) { const detailDiv = document.getElementById('dayDetail'); const dateStr = formatDateForKey(date); const dayLogs = app.logs.filter(l => formatDateForKey(new Date(l.date)) === dateStr); let html = `<div class="day-detail"><div class="day-detail-header"><div class="day-detail-date">${formatDate(date)}</div><button onclick="closeDayDetail()">X</button></div>`; if(dayLogs.length > 0) { html += `<h4>活動記録</h4>`; dayLogs.forEach(log => { const p = app.projects.find(pr => pr.id === log.projectId); html += `<div class="day-detail-item">${p?.name || '不明なプロジェクト'}: 記録あり</div>`; }); } else { html += `<p>この日の記録はありません。</p>`; } html += `</div>`; detailDiv.innerHTML = html; detailDiv.style.display = 'block'; }
        function closeDayDetail() { document.getElementById('dayDetail').style.display = 'none'; }
        // その他の必要な関数もここに...
        
    </script>
</body>
</html>
